<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0a0a1a">
  <title>Wizz AYCF Route Finder</title>
  <link rel="manifest" href="manifest.json">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --bg:#060611;--surface:#0f0f24;--surface2:#181838;--surface3:#222250;
      --border:rgba(100,100,255,0.1);--border-hi:rgba(100,200,255,0.25);
      --accent:#00d4ff;--accent2:#7b61ff;--accent3:#ff6b9d;
      --text:#e4e4f0;--text-dim:#8888aa;--text-muted:#555570;
      --success:#00e68a;--warning:#ffb347;--danger:#ff5577;
      --radius:12px;--radius-sm:8px;
      --safe-top:env(safe-area-inset-top,0px);--safe-bottom:env(safe-area-inset-bottom,0px);
    }
    html{font-size:15px;-webkit-text-size-adjust:100%;scroll-behavior:smooth}
    body{
      font-family:'Outfit',sans-serif;background:var(--bg);color:var(--text);
      min-height:100dvh;overflow-x:hidden;
      padding-top:var(--safe-top);padding-bottom:calc(60px + var(--safe-bottom));
      -webkit-font-smoothing:antialiased;
    }
    body::before{
      content:'';position:fixed;inset:0;z-index:-1;
      background:
        radial-gradient(ellipse 80% 60% at 10% 20%,rgba(0,212,255,0.04),transparent),
        radial-gradient(ellipse 60% 80% at 90% 80%,rgba(123,97,255,0.04),transparent),
        radial-gradient(ellipse 50% 50% at 50% 50%,rgba(255,107,157,0.02),transparent);
    }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    .hdr{
      position:sticky;top:0;z-index:100;
      background:rgba(6,6,17,0.9);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
      border-bottom:1px solid var(--border);padding:12px 14px;
    }
    .hdr-row{display:flex;align-items:center;justify-content:space-between;max-width:860px;margin:0 auto}
    .hdr-title{font-size:1.1rem;font-weight:800;letter-spacing:-0.03em}
    .hdr-title .hi{background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .hdr-title .ver{font-weight:300;font-size:.7rem;color:var(--text-muted);-webkit-text-fill-color:var(--text-muted)}
    .hdr-actions{display:flex;gap:6px}
    .icon-btn{
      width:36px;height:36px;border-radius:8px;border:1px solid var(--border);
      background:var(--surface);color:var(--text-dim);display:flex;align-items:center;justify-content:center;
      cursor:pointer;font-size:1rem;transition:all .2s;
    }
    .icon-btn:hover,.icon-btn:active{border-color:var(--accent);color:var(--accent)}

    /* ‚îÄ‚îÄ Content ‚îÄ‚îÄ */
    .content{max-width:860px;margin:0 auto;padding:10px 12px}
    @media(min-width:600px){.content{padding:14px 20px}}

    /* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
    .card{
      background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);
      padding:14px;margin-bottom:12px;
    }
    .card-title{
      font-size:.8rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;
      color:var(--text-dim);margin-bottom:10px;display:flex;align-items:center;gap:7px;
    }

    /* ‚îÄ‚îÄ Status ‚îÄ‚îÄ */
    .status{border-radius:var(--radius);padding:14px;margin-bottom:12px;position:relative;overflow:hidden}
    .status::before{content:'';position:absolute;inset:0;border-radius:var(--radius);border:1px solid transparent;pointer-events:none}
    .status.s-empty{background:linear-gradient(135deg,rgba(255,85,119,.1),rgba(255,85,119,.03))}
    .status.s-empty::before{border-color:rgba(255,85,119,.25)}
    .status.s-ok{background:linear-gradient(135deg,rgba(0,230,138,.1),rgba(0,230,138,.03))}
    .status.s-ok::before{border-color:rgba(0,230,138,.25)}
    .status.s-load{background:linear-gradient(135deg,rgba(0,212,255,.1),rgba(0,212,255,.03))}
    .status.s-load::before{border-color:rgba(0,212,255,.25)}
    .s-icon{font-size:1.2rem;margin-bottom:4px}
    .s-title{font-weight:700;font-size:.92rem;margin-bottom:3px}
    .s-detail{font-size:.78rem;color:var(--text-dim);line-height:1.4}
    .s-stats{display:flex;gap:16px;flex-wrap:wrap;margin-top:8px}
    .stat-n{font-family:'JetBrains Mono',monospace;font-size:1.2rem;font-weight:600;color:var(--success)}
    .stat-l{font-size:.65rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.04em}

    /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
    .btn{
      display:inline-flex;align-items:center;gap:5px;padding:9px 14px;border-radius:var(--radius-sm);
      border:none;font-family:'Outfit',sans-serif;font-size:.82rem;font-weight:600;cursor:pointer;
      transition:all .2s;white-space:nowrap;
    }
    .btn:active{transform:scale(.97)}
    .btn-p{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff}
    .btn-o{background:transparent;border:1px solid var(--border);color:var(--text-dim)}
    .btn-o:hover{border-color:var(--accent);color:var(--accent)}
    .btn-s{background:linear-gradient(135deg,var(--success),#00b377);color:#fff}
    .btn-d{background:rgba(255,85,119,.12);border:1px solid rgba(255,85,119,.25);color:var(--danger)}
    .btn-w{background:linear-gradient(135deg,var(--warning),#e69500);color:#111}
    .btn-sm{padding:6px 10px;font-size:.78rem}
    .btn-full{width:100%;justify-content:center}
    .btn:disabled{opacity:.35;cursor:not-allowed}

    .row{display:flex;gap:8px;flex-wrap:wrap}
    .row.mb{margin-bottom:10px}

    /* ‚îÄ‚îÄ Inputs ‚îÄ‚îÄ */
    .inp{
      width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);
      padding:10px 12px;color:var(--text);font-family:'Outfit',sans-serif;font-size:.88rem;
    }
    .inp::placeholder{color:var(--text-muted)}
    .inp:focus{outline:none;border-color:var(--accent)}
    .inp-mono{font-family:'JetBrains Mono',monospace;text-transform:uppercase;letter-spacing:.1em}
    select.inp{-webkit-appearance:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath d='M3 5l3 3 3-3' stroke='%238888aa' fill='none' stroke-width='1.5'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;padding-right:28px}

    /* ‚îÄ‚îÄ Favorites ‚îÄ‚îÄ */
    .fav-row{display:flex;gap:8px;margin-bottom:8px}
    .fav-row input{flex:1}
    .fav-chips{display:flex;flex-wrap:wrap;gap:5px;min-height:28px}
    .fav-chip{
      display:inline-flex;align-items:center;gap:4px;
      background:linear-gradient(135deg,rgba(0,212,255,.12),rgba(123,97,255,.1));
      border:1px solid rgba(0,212,255,.25);border-radius:16px;padding:4px 10px 4px 11px;font-size:.78rem;
    }
    .fav-chip .fc{font-family:'JetBrains Mono',monospace;font-weight:600;color:var(--accent)}
    .fav-chip .fi{color:var(--text-muted);font-size:.68rem}
    .fav-chip .fx{
      width:18px;height:18px;border-radius:50%;background:rgba(255,85,119,.15);
      color:var(--danger);border:none;cursor:pointer;font-size:.7rem;
      display:flex;align-items:center;justify-content:center;
    }
    .fav-empty{color:var(--text-muted);font-size:.78rem;font-style:italic}

    /* ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ */
    .tabs{
      display:flex;background:var(--surface);border-radius:var(--radius);padding:3px;
      margin-bottom:12px;border:1px solid var(--border);overflow-x:auto;
    }
    .tab{
      flex:1;min-width:0;padding:9px 6px;border:none;background:none;color:var(--text-muted);
      font-family:'Outfit',sans-serif;font-size:.75rem;font-weight:600;border-radius:9px;
      cursor:pointer;transition:all .25s;text-align:center;white-space:nowrap;
    }
    .tab.on{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;box-shadow:0 3px 12px rgba(0,212,255,.2)}

    /* ‚îÄ‚îÄ Panels ‚îÄ‚îÄ */
    .panel{display:none}.panel.on{display:block}

    /* ‚îÄ‚îÄ Airport list ‚îÄ‚îÄ */
    .ap-search{margin-bottom:8px}
    .ap-box{
      max-height:260px;overflow-y:auto;border-radius:var(--radius-sm);border:1px solid var(--border);
      background:var(--bg);-webkit-overflow-scrolling:touch;
    }
    .ap-ghdr{
      position:sticky;top:0;background:var(--surface2);padding:8px 12px;font-size:.75rem;font-weight:700;
      color:var(--text-dim);cursor:pointer;display:flex;justify-content:space-between;align-items:center;
      border-bottom:1px solid var(--border);z-index:2;user-select:none;-webkit-user-select:none;
    }
    .ap-ghdr:active{background:var(--surface3)}
    .ap-ghdr .arr{transition:transform .2s;font-size:.65rem}
    .ap-ghdr.open .arr{transform:rotate(90deg)}
    .ap-gbody{display:none;padding:6px;flex-wrap:wrap;gap:5px}
    .ap-gbody.open{display:flex}
    .ap-chip{
      display:inline-flex;align-items:center;gap:3px;padding:6px 10px;border-radius:6px;
      background:var(--surface);border:1px solid var(--border);cursor:pointer;font-size:.76rem;
      transition:all .15s;user-select:none;-webkit-user-select:none;-webkit-tap-highlight-color:transparent;
    }
    .ap-chip:active{transform:scale(.96)}
    .ap-chip.sel{background:linear-gradient(135deg,rgba(0,212,255,.2),rgba(123,97,255,.15));border-color:var(--accent);color:var(--accent)}
    .ap-chip .ac{font-family:'JetBrains Mono',monospace;font-weight:600;font-size:.8rem}
    .ap-chip .an{color:var(--text-muted);font-size:.68rem}
    .ap-chip.fv{border-color:var(--warning)}

    /* ‚îÄ‚îÄ Date grid ‚îÄ‚îÄ */
    .dgrid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:10px 0}
    .dgrid label{display:block;font-size:.72rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.04em;margin-bottom:4px}
    .dgrid input[type="date"]{
      width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);
      padding:9px 10px;color:var(--text);font-family:'Outfit',sans-serif;font-size:.88rem;-webkit-appearance:none;
    }
    .dgrid input[type="date"]:focus{outline:none;border-color:var(--accent)}
    input[type="date"]::-webkit-calendar-picker-indicator{filter:invert(.6)}

    /* ‚îÄ‚îÄ Options ‚îÄ‚îÄ */
    .opt-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;align-items:center}
    .opt-row label{font-size:.78rem;font-weight:600;color:var(--text-dim)}

    /* ‚îÄ‚îÄ Search button ‚îÄ‚îÄ */
    .search-btn{
      width:100%;padding:13px;border:none;border-radius:var(--radius);
      background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;
      font-family:'Outfit',sans-serif;font-size:.95rem;font-weight:700;cursor:pointer;
      margin:12px 0;transition:all .2s;box-shadow:0 5px 20px rgba(0,212,255,.2);letter-spacing:.01em;
    }
    .search-btn:active{transform:scale(.98);filter:brightness(.9)}
    .search-btn:disabled{opacity:.35;cursor:not-allowed;box-shadow:none}

    /* ‚îÄ‚îÄ Results ‚îÄ‚îÄ */
    .results{margin-top:8px}
    .msg{padding:12px;border-radius:var(--radius-sm);margin-bottom:8px;font-size:.82rem;line-height:1.5}
    .msg-i{background:rgba(0,212,255,.08);border:1px solid rgba(0,212,255,.2);color:#88ccff}
    .msg-s{background:rgba(0,230,138,.08);border:1px solid rgba(0,230,138,.2);color:var(--success)}
    .msg-w{background:rgba(255,179,71,.08);border:1px solid rgba(255,179,71,.2);color:var(--warning)}
    .msg-e{background:rgba(255,85,119,.08);border:1px solid rgba(255,85,119,.2);color:var(--danger)}

    .date-hdr{
      font-size:.8rem;font-weight:700;color:var(--accent);margin:14px 0 6px;
      padding:7px 10px;background:rgba(0,212,255,.06);border-radius:var(--radius-sm);border-left:3px solid var(--accent);
    }
    .dest-hdr{
      font-size:.85rem;font-weight:700;padding:9px 12px;margin:12px 0 6px;border-radius:var(--radius-sm);
      background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;
    }

    .fc{
      background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);
      padding:12px;margin-bottom:7px;transition:border-color .2s;
    }
    .fc:active{border-color:var(--accent)}
    .fc.indirect{border-left:3px solid var(--warning)}
    .fc-route{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px}
    .fc-route .rt{font-weight:700;font-size:.85rem}
    .badge{padding:2px 7px;border-radius:5px;font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.03em}
    .b-dir{background:rgba(0,230,138,.12);color:var(--success)}
    .b-1s{background:rgba(255,179,71,.12);color:var(--warning)}
    .fc-info{font-size:.78rem;color:var(--text-dim);line-height:1.5}
    .fc-info .mono{font-family:'JetBrains Mono',monospace;color:var(--text)}
    .book{
      display:inline-flex;align-items:center;gap:4px;margin-top:6px;padding:6px 12px;border-radius:5px;
      background:linear-gradient(135deg,var(--success),#00b377);color:#fff;text-decoration:none;
      font-size:.75rem;font-weight:600;transition:filter .2s;
    }
    .book:active{filter:brightness(.85)}

    .lay-box{background:var(--surface2);border-radius:6px;padding:9px;margin-top:6px;font-size:.76rem;line-height:1.6;color:var(--text-dim)}
    .trip-path{display:flex;align-items:center;flex-wrap:wrap;gap:3px;margin:6px 0}
    .trip-path .lb{background:var(--surface2);padding:4px 8px;border-radius:5px;font-size:.75rem;text-align:center}
    .trip-path .lb .ac{font-family:'JetBrains Mono',monospace;font-weight:600;color:var(--accent)}
    .trip-path .lb small{display:block;color:var(--text-muted);font-size:.65rem}
    .trip-path .as{color:var(--accent2);font-weight:700;font-size:.82rem}
    .trip-dur{font-size:.8rem;font-weight:600;color:var(--success);margin-bottom:6px}
    .trip-leg{padding:6px 0;border-bottom:1px solid var(--border);font-size:.78rem}
    .trip-leg:last-child{border-bottom:none}

    /* ‚îÄ‚îÄ Modal ‚îÄ‚îÄ */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:200;align-items:flex-end;justify-content:center}
    .modal.open{display:flex}
    .modal-sheet{
      width:100%;max-width:520px;background:var(--surface);border-radius:18px 18px 0 0;
      padding:18px 14px calc(18px + var(--safe-bottom));max-height:85dvh;overflow-y:auto;
      animation:sheetUp .3s ease-out;
    }
    @keyframes sheetUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
    .modal-handle{width:36px;height:3px;background:var(--text-muted);border-radius:2px;margin:0 auto 14px}
    .modal-title{font-size:1.05rem;font-weight:700;margin-bottom:14px}

    /* ‚îÄ‚îÄ Drop zone ‚îÄ‚îÄ */
    .drop{
      border:2px dashed var(--border);border-radius:var(--radius);padding:24px 16px;text-align:center;
      color:var(--text-muted);cursor:pointer;transition:all .2s;margin-bottom:14px;
    }
    .drop:hover,.drop.over{border-color:var(--accent);background:rgba(0,212,255,.03)}
    .drop .di{font-size:1.8rem;margin-bottom:6px}

    /* ‚îÄ‚îÄ Debug log ‚îÄ‚îÄ */
    .log-area{
      background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);
      max-height:300px;overflow-y:auto;padding:8px;font-family:'JetBrains Mono',monospace;
      font-size:.7rem;line-height:1.5;color:var(--text-dim);white-space:pre-wrap;word-break:break-all;
    }
    .log-area .err{color:var(--danger)}.log-area .warn{color:var(--warning)}.log-area .ok{color:var(--success)}
    .log-area .api{color:var(--accent)}

    /* ‚îÄ‚îÄ Collapsible ‚îÄ‚îÄ */
    .coll-hdr{cursor:pointer;display:flex;justify-content:space-between;align-items:center;user-select:none}
    .coll-hdr .tgl{font-size:.7rem;color:var(--text-muted);transition:transform .2s}
    .coll-hdr.open .tgl{transform:rotate(180deg)}
    .coll-body{display:none;margin-top:10px}
    .coll-body.open{display:block}

    /* ‚îÄ‚îÄ Bookmarklet code ‚îÄ‚îÄ */
    .bm-code{
      background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);
      padding:10px;font-family:'JetBrains Mono',monospace;font-size:.7rem;color:var(--accent);
      max-height:120px;overflow-y:auto;word-break:break-all;user-select:all;-webkit-user-select:all;
    }
    .bm-link{
      display:inline-block;padding:10px 18px;border-radius:var(--radius-sm);
      background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;
      font-weight:700;font-size:.85rem;text-decoration:none;cursor:grab;margin:8px 0;
    }

    /* ‚îÄ‚îÄ GitHub settings ‚îÄ‚îÄ */
    .gh-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px}
    @media(max-width:400px){.gh-grid{grid-template-columns:1fr}}

    /* ‚îÄ‚îÄ Progress ‚îÄ‚îÄ */
    .prog{height:5px;background:rgba(0,212,255,.1);border-radius:3px;overflow:hidden;margin:8px 0}
    .prog .fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:3px;transition:width .3s}

    /* ‚îÄ‚îÄ Scrollbar ‚îÄ‚îÄ */
    ::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:rgba(0,212,255,.2);border-radius:2px}

    /* ‚îÄ‚îÄ Misc ‚îÄ‚îÄ */
    .hidden{display:none!important}
    .footer{text-align:center;font-size:.7rem;color:var(--text-muted);padding:18px 0}
    .footer a{color:var(--accent);text-decoration:none}
    .spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(0,212,255,.15);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .sep{border:none;border-top:1px solid var(--border);margin:12px 0}

    /* ‚îÄ‚îÄ Steps ‚îÄ‚îÄ */
    .steps{counter-reset:step}
    .step{counter-increment:step;padding-left:32px;position:relative;margin-bottom:10px;font-size:.82rem;line-height:1.5}
    .step::before{
      content:counter(step);position:absolute;left:0;top:0;width:22px;height:22px;
      border-radius:50%;background:var(--accent);color:var(--bg);font-size:.72rem;font-weight:700;
      display:flex;align-items:center;justify-content:center;
    }
  </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê Header ‚ïê‚ïê‚ïê -->
<header class="hdr">
  <div class="hdr-row">
    <div class="hdr-title">‚úàÔ∏è <span class="hi">Wizz AYCF Finder</span> <span class="ver">v3.0</span></div>
    <div class="hdr-actions">
      <button class="icon-btn" id="btnLog" title="Debug Log">üîß</button>
      <button class="icon-btn" id="btnGH" title="GitHub Settings">‚öôÔ∏è</button>
    </div>
  </div>
</header>

<main class="content">

  <!-- ‚ïê‚ïê‚ïê Status ‚ïê‚ïê‚ïê -->
  <div class="status s-empty" id="statusCard">
    <div class="s-icon" id="sIcon">üì≠</div>
    <div class="s-title" id="sTitle">No Flight Data</div>
    <div class="s-detail" id="sDetail">Import data or use the Data Collector to download flights from Wizz Air.</div>
    <div class="s-stats hidden" id="sStats">
      <div><div class="stat-n" id="stFlights">0</div><div class="stat-l">Flights</div></div>
      <div><div class="stat-n" id="stOrigins">0</div><div class="stat-l">Origins</div></div>
      <div><div class="stat-n" id="stRoutes">0</div><div class="stat-l">Routes</div></div>
      <div><div class="stat-n" id="stDays">0</div><div class="stat-l">Days</div></div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê Data Collector (Bookmarklet) ‚ïê‚ïê‚ïê -->
  <div class="card">
    <div class="coll-hdr" id="collectorHdr">
      <div class="card-title" style="margin:0">üöÄ Data Collector ‚Äî Download Flights</div>
      <span class="tgl">‚ñº</span>
    </div>
    <div class="coll-body" id="collectorBody">
      <p style="font-size:.82rem;color:var(--text-dim);margin-bottom:10px;">
        Since the Wizz Air API requires login cookies, we use a <strong>Data Collector bookmarklet</strong> that runs directly on the Wizz Air page.
      </p>

      <div class="steps">
        <div class="step"><strong>Login</strong> ‚Äî Open Wizz Air Multipass and log in:<br>
          <a href="https://multipass.wizzair.com/w6/subscriptions/spa/private-page/wallets" target="_blank" class="btn btn-p btn-sm" style="margin-top:6px">üîë Open Wizz Air Multipass</a>
        </div>
        <div class="step"><strong>Install Bookmarklet</strong> ‚Äî Drag this button to your bookmarks bar:<br>
          <a class="bm-link" id="bmLink" href="#">üì• AYCF Collector</a><br>
          <small style="color:var(--text-muted)">On mobile: copy the code below and create a bookmark manually, then paste as the URL.</small>
          <div style="margin-top:6px">
            <button class="btn btn-o btn-sm" id="btnCopyBM">üìã Copy bookmarklet code</button>
          </div>
          <div class="bm-code hidden" id="bmCode"></div>
        </div>
        <div class="step"><strong>Run</strong> ‚Äî While on the Wizz Air Multipass page, click the bookmarklet. It will scrape routes and download flights, then save a JSON file.</div>
        <div class="step"><strong>Import</strong> ‚Äî Import the downloaded JSON file below.</div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê Import / GitHub ‚ïê‚ïê‚ïê -->
  <div class="card">
    <div class="card-title">üì¶ Data Management</div>
    <div class="row mb">
      <button class="btn btn-p" id="btnImport">üì• Import JSON</button>
      <button class="btn btn-s" id="btnExport">üì§ Export</button>
      <button class="btn btn-o" id="btnGHLoad">‚òÅÔ∏è Load from GitHub</button>
      <button class="btn btn-o" id="btnGHSave">üíæ Save to GitHub</button>
      <button class="btn btn-d btn-sm" id="btnClear">üóëÔ∏è Clear</button>
    </div>
    <input type="file" id="fileIn" accept=".json" style="display:none">
    <div id="dataMsg"></div>
  </div>

  <!-- ‚ïê‚ïê‚ïê Favorites ‚ïê‚ïê‚ïê -->
  <div class="card">
    <div class="card-title">‚≠ê Favorites</div>
    <div class="fav-row">
      <input type="text" class="inp inp-mono" id="favIn" placeholder="TLV, BCN..." maxlength="3" autocomplete="off" autocapitalize="characters">
      <button class="btn btn-p btn-sm" id="btnFav">Add</button>
    </div>
    <div class="fav-chips" id="favChips"><span class="fav-empty">No favorites</span></div>
  </div>

  <!-- ‚ïê‚ïê‚ïê Mode Tabs ‚ïê‚ïê‚ïê -->
  <div class="tabs">
    <button class="tab on" data-m="dep">‚úàÔ∏è From Origin</button>
    <button class="tab" data-m="dest">üéØ To Dest</button>
    <button class="tab" data-m="rt">üîÑ Round Trip</button>
    <button class="tab" data-m="trip">üóìÔ∏è Multi-Hop</button>
  </div>

  <!-- ‚ïê‚ïê‚ïê FROM ORIGIN ‚ïê‚ïê‚ïê -->
  <div class="panel on" id="p-dep">
    <div class="card">
      <div class="card-title">üõ´ Origin Airports</div>
      <input type="text" class="inp ap-search" id="depSrch" placeholder="Search airports...">
      <div class="row mb">
        <button class="btn btn-o btn-sm sfav" data-l="depList">‚≠ê</button>
        <button class="btn btn-o btn-sm sall" data-l="depList">All</button>
        <button class="btn btn-o btn-sm sclr" data-l="depList">Clear</button>
      </div>
      <div class="ap-box" id="depList"></div>
    </div>
    <div class="dgrid">
      <div><label>From</label><input type="date" id="depS"></div>
      <div><label>To</label><input type="date" id="depE"></div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê TO DESTINATION ‚ïê‚ïê‚ïê -->
  <div class="panel" id="p-dest">
    <div class="card">
      <div class="card-title">üéØ Destination Airports</div>
      <input type="text" class="inp ap-search" id="destSrch" placeholder="Search airports...">
      <div class="row mb">
        <button class="btn btn-o btn-sm sfav" data-l="destList">‚≠ê</button>
        <button class="btn btn-o btn-sm sall" data-l="destList">All</button>
        <button class="btn btn-o btn-sm sclr" data-l="destList">Clear</button>
      </div>
      <div class="ap-box" id="destList"></div>
    </div>
    <div class="dgrid">
      <div><label>From</label><input type="date" id="destS"></div>
      <div><label>To</label><input type="date" id="destE"></div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê ROUND TRIP (Anywhere ‚Üî Anywhere) ‚ïê‚ïê‚ïê -->
  <div class="panel" id="p-rt">
    <div class="card">
      <div class="card-title">üîÑ Round Trip ‚Äî Anywhere to Anywhere</div>
      <p style="font-size:.78rem;color:var(--text-dim);margin-bottom:10px;">
        Find all possible round trips in the cached data. Optionally filter by origin/destination.
      </p>
      <div class="opt-row">
        <label>Origin filter:</label>
        <input type="text" class="inp inp-mono" id="rtOrigIn" placeholder="Any (or TLV,BUD)" style="width:140px" autocapitalize="characters">
      </div>
      <div class="opt-row">
        <label>Dest filter:</label>
        <input type="text" class="inp inp-mono" id="rtDestIn" placeholder="Any (or BCN,ATH)" style="width:140px" autocapitalize="characters">
      </div>
    </div>
    <div class="dgrid">
      <div><label>Depart after</label><input type="date" id="rtS"></div>
      <div><label>Return before</label><input type="date" id="rtE"></div>
    </div>
    <div class="opt-row">
      <label>Min stay:</label>
      <select class="inp" id="rtMin" style="width:100px">
        <option value="0">Any</option><option value="1">1+ days</option><option value="2" selected>2+ days</option>
        <option value="3">3+ days</option><option value="5">5+ days</option><option value="7">7+ days</option>
      </select>
      <label>Max stay:</label>
      <select class="inp" id="rtMax" style="width:100px">
        <option value="3">3 days</option><option value="5">5 days</option><option value="7" selected>7 days</option>
        <option value="14">14 days</option><option value="30">30 days</option><option value="99">Any</option>
      </select>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê MULTI-HOP TRIP ‚ïê‚ïê‚ïê -->
  <div class="panel" id="p-trip">
    <div class="card">
      <div class="card-title">üè† Home Airports</div>
      <p style="font-size:.78rem;color:var(--text-dim);margin-bottom:8px;">Trip starts & ends here.</p>
      <input type="text" class="inp ap-search" id="tripSrch" placeholder="Search airports...">
      <div class="row mb">
        <button class="btn btn-o btn-sm sfav" data-l="tripList">‚≠ê</button>
        <button class="btn btn-o btn-sm sall" data-l="tripList">All</button>
        <button class="btn btn-o btn-sm sclr" data-l="tripList">Clear</button>
      </div>
      <div class="ap-box" id="tripList"></div>
    </div>
    <div class="dgrid">
      <div><label>From</label><input type="date" id="tripS"></div>
      <div><label>To</label><input type="date" id="tripE"></div>
    </div>
    <div class="opt-row">
      <label>Extra stops:</label>
      <select class="inp" id="tripHops" style="width:200px">
        <option value="0">Direct (A‚ÜíB‚ÜíA)</option>
        <option value="1" selected>1 extra (A‚ÜíB‚ÜíC‚ÜíA)</option>
        <option value="2">2 extra (A‚ÜíB‚ÜíC‚ÜíD‚ÜíA)</option>
      </select>
    </div>
    <div class="opt-row">
      <label>Min duration:</label>
      <select class="inp" id="tripMin" style="width:100px">
        <option value="0">Any</option><option value="1">1+</option><option value="2">2+</option>
        <option value="3" selected>3+</option><option value="5">5+</option><option value="7">7+</option>
      </select>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê Search Button ‚ïê‚ïê‚ïê -->
  <button class="search-btn" id="btnSearch">üîç Search Flights</button>

  <!-- ‚ïê‚ïê‚ïê Results ‚ïê‚ïê‚ïê -->
  <div class="results" id="results"></div>

  <div class="footer">
    Not affiliated with Wizz Air.
    <a href="https://github.com/vloss3/wizz-aycf-route-finder" target="_blank">GitHub</a> ¬∑
    <a href="https://discord.gg/k3eRaSBez4" target="_blank">Discord</a>
  </div>
</main>

<!-- ‚ïê‚ïê‚ïê GitHub Settings Modal ‚ïê‚ïê‚ïê -->
<div class="modal" id="modalGH">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">‚öôÔ∏è GitHub Settings</div>
    <p style="font-size:.82rem;color:var(--text-dim);margin-bottom:12px;">
      Save & load flight data from your GitHub repo. Create a
      <a href="https://github.com/settings/tokens/new?scopes=repo&description=AYCF+Route+Finder" target="_blank" style="color:var(--accent)">Personal Access Token</a>
      with <strong>repo</strong> scope.
    </p>
    <div class="gh-grid">
      <div><label style="font-size:.72rem;color:var(--text-muted)">Owner</label><input class="inp" id="ghOwner" placeholder="palayax"></div>
      <div><label style="font-size:.72rem;color:var(--text-muted)">Repo</label><input class="inp" id="ghRepo" placeholder="wizz-aycf-web"></div>
    </div>
    <div style="margin-bottom:8px">
      <label style="font-size:.72rem;color:var(--text-muted)">Personal Access Token</label>
      <input class="inp" id="ghToken" type="password" placeholder="ghp_xxxxxxxxxxxx">
    </div>
    <div class="row mb">
      <button class="btn btn-s" id="btnGHTest">üîó Test Connection</button>
      <button class="btn btn-p" id="btnGHSettSave">üíæ Save Settings</button>
    </div>
    <div id="ghMsg"></div>
    <hr class="sep">
    <div class="card-title">üìÅ Saved Databases</div>
    <div id="ghFileList" style="font-size:.82rem;color:var(--text-dim)">Configure settings above to see saved files.</div>
    <hr class="sep">
    <button class="btn btn-o btn-full" id="btnCloseGH">Close</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê Debug Log Modal ‚ïê‚ïê‚ïê -->
<div class="modal" id="modalLog">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">üîß Debug Log <span id="logCount" style="font-size:.75rem;color:var(--text-muted)">(0)</span></div>
    <div class="row mb">
      <button class="btn btn-o btn-sm" id="btnLogExport">üì• Export Log</button>
      <button class="btn btn-d btn-sm" id="btnLogClear">Clear</button>
    </div>
    <div class="log-area" id="logArea">Waiting for events...</div>
    <hr class="sep">
    <button class="btn btn-o btn-full" id="btnCloseLog">Close</button>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  WIZZ AYCF WEB v3.0 ‚Äî Full-featured mobile web app
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const VER = '3.0.0';
const DB_NAME = 'WizzAYCFWeb';
const DB_VER = 1;
const CACHE_H = 72; // hours
const MIN_LAY = 120; // minutes
const COUNTRIES = {
  TLV:'Israel',ETH:'Israel',VDA:'Israel',
  LTN:'UK',LGW:'UK',STN:'UK',LHR:'UK',BHX:'UK',BRS:'UK',MAN:'UK',EDI:'UK',GLA:'UK',LPL:'UK',NCL:'UK',EMA:'UK',ABZ:'UK',CWL:'UK',DSA:'UK',
  FCO:'Italy',CIA:'Italy',MXP:'Italy',BGY:'Italy',VCE:'Italy',TSF:'Italy',NAP:'Italy',BRI:'Italy',CTA:'Italy',PMO:'Italy',BLQ:'Italy',TRN:'Italy',PSA:'Italy',VRN:'Italy',GOA:'Italy',TRS:'Italy',
  BCN:'Spain',MAD:'Spain',AGP:'Spain',ALC:'Spain',PMI:'Spain',IBZ:'Spain',VLC:'Spain',SVQ:'Spain',BIO:'Spain',TFS:'Spain',LPA:'Spain',ACE:'Spain',FUE:'Spain',
  BER:'Germany',CGN:'Germany',DTM:'Germany',DUS:'Germany',FRA:'Germany',HHN:'Germany',HAM:'Germany',HAJ:'Germany',MUC:'Germany',NUE:'Germany',STR:'Germany',FMM:'Germany',
  WAW:'Poland',WMI:'Poland',KRK:'Poland',KTW:'Poland',GDN:'Poland',POZ:'Poland',WRO:'Poland',LUZ:'Poland',RZE:'Poland',SZZ:'Poland',BZG:'Poland',LCJ:'Poland',
  OTP:'Romania',CLJ:'Romania',TSR:'Romania',IAS:'Romania',SBZ:'Romania',SUJ:'Romania',CRA:'Romania',BCM:'Romania',OMR:'Romania',
  BUD:'Hungary',VIE:'Austria',
  ATH:'Greece',SKG:'Greece',HER:'Greece',RHO:'Greece',CFU:'Greece',ZTH:'Greece',KGS:'Greece',CHQ:'Greece',
  LCA:'Cyprus',PFO:'Cyprus',DXB:'UAE',AUH:'UAE',
  SOF:'Bulgaria',VAR:'Bulgaria',BOJ:'Bulgaria',
  CDG:'France',ORY:'France',BVA:'France',NCE:'France',MRS:'France',LYS:'France',TLS:'France',BOD:'France',NTE:'France',
  LIS:'Portugal',OPO:'Portugal',FAO:'Portugal',AMS:'Netherlands',EIN:'Netherlands',
  BRU:'Belgium',CRL:'Belgium',GVA:'Switzerland',ZRH:'Switzerland',BSL:'Switzerland',
  ARN:'Sweden',GOT:'Sweden',CPH:'Denmark',OSL:'Norway',BGO:'Norway',TRD:'Norway',HEL:'Finland',TMP:'Finland',
  BEG:'Serbia',PRN:'Kosovo',SKP:'N.Macedonia',TGD:'Montenegro',SJJ:'Bosnia',ZAG:'Croatia',SPU:'Croatia',DBV:'Croatia',
  TIA:'Albania',PRG:'Czechia',BTS:'Slovakia',LJU:'Slovenia',RIX:'Latvia',VNO:'Lithuania',TLL:'Estonia',KIV:'Moldova',KBP:'Ukraine',IEV:'Ukraine',
};

// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let db=null, airportInfo=new Map(), favorites=[], mode='dep', logs=[];

// ‚îÄ‚îÄ DOM helpers ‚îÄ‚îÄ
const $=id=>document.getElementById(id);
const $$=s=>document.querySelectorAll(s);

// ‚ïê‚ïê‚ïê LOGGING ‚ïê‚ïê‚ïê
function L(msg,cls=''){
  const ts=new Date().toISOString().slice(11,23);
  const line=`[${ts}] ${msg}`;
  logs.push({line,cls});
  if(logs.length>5000)logs=logs.slice(-5000);
  console.log('[AYCF]',msg);
  const area=$('logArea');
  if(area){
    const span=document.createElement('div');
    span.className=cls;span.textContent=line;
    area.appendChild(span);
    area.scrollTop=area.scrollHeight;
  }
  $('logCount').textContent=`(${logs.length})`;
}
function LE(msg){L('‚ùå '+msg,'err')}
function LW(msg){L('‚ö†Ô∏è '+msg,'warn')}
function LS(msg){L('‚úÖ '+msg,'ok')}
function LA(msg){L('üåê '+msg,'api')}

// ‚ïê‚ïê‚ïê UTILITIES ‚ïê‚ïê‚ïê
function fmtD(d){return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`}
function fmtDMY(s){if(!s)return'';const[y,m,d]=s.split('-');return`${d}-${m}-${y}`}
function fmtDD(s){if(!s)return'';const[y,m,d]=s.split('-');const dt=new Date(+y,+m-1,+d);return`${dt.toLocaleDateString('en',{weekday:'short'})} ${d}-${m}-${y}`}
function fmtT(t){if(!t)return'';if(t.includes(':')&&!t.includes('AM')&&!t.includes('PM')){const p=t.split(':');return String(+p[0]).padStart(2,'0')+':'+String(+(p[1]||0)).padStart(2,'0')}return t}
function parseT(t){if(!t)return 0;const p=t.split(':');return(+p[0])*60+(+(p[1]||0))}
function dateRange(s,e){
  const r=[];const[sy,sm,sd]=s.split('-').map(Number);const[ey,em,ed]=e.split('-').map(Number);
  let c=new Date(sy,sm-1,sd);const end=new Date(ey,em-1,ed);
  while(c<=end){r.push(fmtD(c));c.setDate(c.getDate()+1)}return r;
}
function apDisp(c){const i=airportInfo.get(c);if(!i)return c;return[c,i.name!==c?i.name:'',i.country].filter(Boolean).join(' ¬∑ ')}
function apShort(c){const i=airportInfo.get(c);return i&&i.name&&i.name!==c?`${c} (${i.name})`:c}
function bookUrl(o,d,dt){return`https://multipass.wizzair.com/w6/subscriptions/spa/private-page/flight-search?origin=${o}&destination=${d}&departureDate=${dt}`}
function daysBetween(d1,d2){const[y1,m1,dd1]=d1.split('-').map(Number);const[y2,m2,dd2]=d2.split('-').map(Number);return Math.floor((new Date(y2,m2-1,dd2)-new Date(y1,m1-1,dd1))/864e5)}

// ‚ïê‚ïê‚ïê INDEXEDDB ‚ïê‚ïê‚ïê
function initDB(){
  return new Promise((ok,no)=>{
    L('Opening IndexedDB...');
    const r=indexedDB.open(DB_NAME,DB_VER);
    r.onerror=()=>{LE('IndexedDB error');no(r.error)};
    r.onsuccess=()=>{db=r.result;LS('IndexedDB ready');ok(db)};
    r.onupgradeneeded=e=>{
      const d=e.target.result;
      if(!d.objectStoreNames.contains('flights'))d.createObjectStore('flights',{keyPath:'id'});
      if(!d.objectStoreNames.contains('meta'))d.createObjectStore('meta',{keyPath:'key'});
    };
  });
}
function dbPut(s,d){return new Promise((ok,no)=>{const t=db.transaction(s,'readwrite');const r=t.objectStore(s).put(d);r.onsuccess=ok;r.onerror=()=>no(r.error)})}
function dbGetAll(s){return new Promise((ok,no)=>{const t=db.transaction(s,'readonly');const r=t.objectStore(s).getAll();r.onsuccess=()=>ok(r.result||[]);r.onerror=()=>no(r.error)})}
function dbClear(s){return new Promise((ok,no)=>{const t=db.transaction(s,'readwrite');const r=t.objectStore(s).clear();r.onsuccess=ok;r.onerror=()=>no(r.error)})}

// ‚ïê‚ïê‚ïê FAVORITES ‚ïê‚ïê‚ïê
function loadFavs(){try{favorites=JSON.parse(localStorage.getItem('wz_fav')||'[]')}catch{favorites=[]}L(`Loaded ${favorites.length} favorites`)}
function saveFavs(){localStorage.setItem('wz_fav',JSON.stringify(favorites))}
function addFav(code){
  code=code.toUpperCase().trim();if(!code||code.length<2||code.length>3)return false;
  if(favorites.some(f=>f.code===code))return false;
  const i=airportInfo.get(code)||{code,name:code,country:COUNTRIES[code]||''};
  favorites.push({code:i.code,name:i.name||code,country:i.country||COUNTRIES[code]||''});
  saveFavs();renderFavs();renderAllLists();LS(`Added favorite: ${code}`);return true;
}
function removeFav(code){favorites=favorites.filter(f=>f.code!==code);saveFavs();renderFavs();renderAllLists()}
function renderFavs(){
  const c=$('favChips');
  if(!favorites.length){c.innerHTML='<span class="fav-empty">No favorites</span>';return}
  c.innerHTML=favorites.map(f=>`<span class="fav-chip"><span class="fc">${f.code}</span><span class="fi">${f.country||''}</span><button class="fx" data-c="${f.code}">√ó</button></span>`).join('');
  c.querySelectorAll('.fx').forEach(b=>b.onclick=e=>{e.stopPropagation();removeFav(b.dataset.c)});
}

// ‚ïê‚ïê‚ïê AIRPORT INFO ‚ïê‚ïê‚ïê
function buildInfo(data){
  airportInfo=new Map();
  data.forEach(d=>{
    [d.origin,d.dest].forEach(c=>{
      if(!airportInfo.has(c))airportInfo.set(c,{code:c,name:c,country:COUNTRIES[c]||''});
    });
  });
  L(`Built airport info: ${airportInfo.size} airports`);
}

// ‚ïê‚ïê‚ïê AIRPORT LIST UI ‚ïê‚ïê‚ïê
function renderList(cid,sid){
  const c=$(cid);if(!c)return;
  if(!airportInfo.size){c.innerHTML='<div style="padding:16px;text-align:center;color:var(--text-muted);font-size:.8rem">No airports. Import data first.</div>';return}
  const byC={};
  airportInfo.forEach((i,code)=>{const co=i.country||'Other';if(!byC[co])byC[co]=[];byC[co].push(i)});
  const favC=new Set(favorites.map(f=>f.country));
  const sorted=Object.keys(byC).sort((a,b)=>{if(favC.has(a)&&!favC.has(b))return-1;if(!favC.has(a)&&favC.has(b))return 1;return a.localeCompare(b)});
  let h='';
  sorted.forEach(co=>{
    const aps=byC[co].sort((a,b)=>a.code.localeCompare(b.code));
    const hf=aps.some(a=>favorites.some(f=>f.code===a.code));
    h+=`<div class="ap-g" data-co="${co}"><div class="ap-ghdr" data-co="${co}"><span>${hf?'‚≠ê ':''}${co} (${aps.length})</span><span class="arr">‚ñ∂</span></div><div class="ap-gbody">`;
    aps.forEach(a=>{
      const fv=favorites.some(f=>f.code===a.code);
      h+=`<div class="ap-chip${fv?' fv':''}" data-code="${a.code}" data-co="${co}" data-name="${a.name}"><span class="ac">${a.code}</span>${a.name!==a.code?`<span class="an">${a.name}</span>`:''}</div>`;
    });
    h+='</div></div>';
  });
  c.innerHTML=h;
  c.querySelectorAll('.ap-ghdr').forEach(hdr=>{hdr.addEventListener('click',()=>{hdr.classList.toggle('open');hdr.nextElementSibling.classList.toggle('open')})});
  c.querySelectorAll('.ap-chip').forEach(ch=>{ch.addEventListener('click',()=>ch.classList.toggle('sel'))});
  if(sid){
    const inp=$(sid);
    if(inp)inp.addEventListener('input',()=>{
      const q=inp.value.toLowerCase();
      c.querySelectorAll('.ap-chip').forEach(ch=>{
        const m=ch.dataset.code.toLowerCase().includes(q)||ch.dataset.co.toLowerCase().includes(q)||(ch.dataset.name||'').toLowerCase().includes(q);
        ch.style.display=m?'':'none';
      });
      c.querySelectorAll('.ap-g').forEach(g=>{
        const vis=[...g.querySelectorAll('.ap-chip')].some(ch=>ch.style.display!=='none');
        g.style.display=vis?'':'none';
        if(q&&vis){g.querySelector('.ap-ghdr').classList.add('open');g.querySelector('.ap-gbody').classList.add('open')}
      });
    });
  }
}
function renderAllLists(){renderList('depList','depSrch');renderList('destList','destSrch');renderList('tripList','tripSrch')}
function getSel(cid){const c=$(cid);return c?[...c.querySelectorAll('.ap-chip.sel')].map(ch=>ch.dataset.code):[]}
function setSel(cid,codes){const c=$(cid);if(!c)return;const s=new Set(codes);c.querySelectorAll('.ap-chip').forEach(ch=>ch.classList.toggle('sel',s.has(ch.dataset.code)))}

// ‚ïê‚ïê‚ïê STATUS ‚ïê‚ïê‚ïê
async function updateStatus(){
  const all=await dbGetAll('flights');
  const valid=all.filter(d=>Date.now()-d.timestamp<CACHE_H*36e5);
  L(`DB: ${all.length} total, ${valid.length} valid`);
  const card=$('statusCard');
  if(!valid.length){
    card.className='status s-empty';$('sIcon').textContent='üì≠';$('sTitle').textContent='No Flight Data';
    $('sDetail').textContent='Import data or use the Data Collector.';$('sStats').classList.add('hidden');
  }else{
    const tf=valid.reduce((s,d)=>s+(d.flights?.length||0),0);
    const ori=new Set(valid.map(d=>d.origin)),des=new Set(valid.map(d=>d.dest)),dts=new Set(valid.map(d=>d.date));
    card.className='status s-ok';$('sIcon').textContent='‚úÖ';
    $('sTitle').textContent='Flight Data Ready';
    $('sDetail').textContent=`Dates: ${[...dts].sort().map(fmtDMY).join(', ')}`;
    $('sStats').classList.remove('hidden');
    $('stFlights').textContent=tf.toLocaleString();$('stOrigins').textContent=ori.size;
    $('stRoutes').textContent=valid.length.toLocaleString();$('stDays').textContent=dts.size;
    buildInfo(valid);renderAllLists();
    LS(`Data loaded: ${tf} flights, ${ori.size} origins, ${dts.size} days`);
  }
}

// ‚ïê‚ïê‚ïê IMPORT / EXPORT ‚ïê‚ïê‚ïê
async function importJSON(file){
  L(`Importing file: ${file.name} (${(file.size/1024).toFixed(1)} KB)`);
  showDataMsg('info','Importing...');
  try{
    const text=await file.text();const data=JSON.parse(text);
    if(!data.data||!Array.isArray(data.data))throw new Error('Invalid format ‚Äî need .data array');
    let n=0;
    for(const f of data.data){if(f.id&&f.flights){await dbPut('flights',{...f,timestamp:Date.now()});n++}}
    if(data.favorites&&Array.isArray(data.favorites)){
      data.favorites.forEach(f=>{if(!favorites.some(e=>e.code===f.code))favorites.push(f)});
      saveFavs();renderFavs();
    }
    await updateStatus();showDataMsg('success',`Imported ${n} routes!`);LS(`Imported ${n} routes from ${file.name}`);
  }catch(e){LE(`Import failed: ${e.message}`);showDataMsg('error',`Import failed: ${e.message}`)}
}

async function exportJSON(){
  const all=await dbGetAll('flights');
  const valid=all.filter(d=>Date.now()-d.timestamp<CACHE_H*36e5);
  if(!valid.length){showDataMsg('error','No data to export');return}
  const exp={version:VER,exportDate:new Date().toISOString(),favorites,flightCount:valid.reduce((s,f)=>s+f.flights.length,0),routeCount:valid.length,data:valid};
  const blob=new Blob([JSON.stringify(exp)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download=`wizz-flights-${fmtD(new Date())}.json`;
  document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);
  LS('Exported data');showDataMsg('success','Exported!');
}

function showDataMsg(type,msg){
  const m=$('dataMsg');
  const cls={info:'msg-i',success:'msg-s',error:'msg-e',warning:'msg-w'};
  m.innerHTML=`<div class="msg ${cls[type]||'msg-i'}">${msg}</div>`;
  setTimeout(()=>{if(m.innerHTML.includes(msg))m.innerHTML=''},8000);
}

// ‚ïê‚ïê‚ïê GITHUB API ‚ïê‚ïê‚ïê
function loadGHSettings(){
  try{
    const s=JSON.parse(localStorage.getItem('wz_gh')||'{}');
    if(s.owner)$('ghOwner').value=s.owner;
    if(s.repo)$('ghRepo').value=s.repo;
    if(s.token)$('ghToken').value=s.token;
  }catch{}
}
function saveGHSettings(){
  const s={owner:$('ghOwner').value.trim(),repo:$('ghRepo').value.trim(),token:$('ghToken').value.trim()};
  localStorage.setItem('wz_gh',JSON.stringify(s));
  LS('GitHub settings saved');return s;
}
function getGH(){
  try{return JSON.parse(localStorage.getItem('wz_gh')||'{}')}catch{return{}}
}

async function ghAPI(path,method='GET',body=null){
  const s=getGH();
  if(!s.owner||!s.repo||!s.token)throw new Error('GitHub not configured');
  const url=`https://api.github.com/repos/${s.owner}/${s.repo}/contents/${path}`;
  LA(`${method} ${url}`);
  const opts={method,headers:{'Authorization':`Bearer ${s.token}`,'Accept':'application/vnd.github.v3+json'}};
  if(body)opts.body=JSON.stringify(body);
  const resp=await fetch(url,opts);
  if(!resp.ok){
    const err=await resp.text();
    throw new Error(`GitHub API ${resp.status}: ${err.slice(0,200)}`);
  }
  return resp.json();
}

async function testGH(){
  const ghM=$('ghMsg');ghM.innerHTML='<div class="msg msg-i"><span class="spinner"></span> Testing...</div>';
  try{
    const s=getGH();
    const resp=await fetch(`https://api.github.com/repos/${s.owner}/${s.repo}`,{
      headers:{'Authorization':`Bearer ${s.token}`}
    });
    if(!resp.ok)throw new Error(`HTTP ${resp.status}`);
    const data=await resp.json();
    ghM.innerHTML=`<div class="msg msg-s">‚úÖ Connected to <strong>${data.full_name}</strong></div>`;
    LS(`GitHub connected: ${data.full_name}`);
    await listGHFiles();
  }catch(e){
    LE(`GitHub test failed: ${e.message}`);
    ghM.innerHTML=`<div class="msg msg-e">‚ùå ${e.message}</div>`;
  }
}

async function listGHFiles(){
  const list=$('ghFileList');
  try{
    let files;
    try{files=await ghAPI('data')}catch{files=[]}
    if(!Array.isArray(files)||!files.length){list.innerHTML='<em>No saved databases yet.</em>';return}
    const jsonFiles=files.filter(f=>f.name.endsWith('.json')).sort((a,b)=>b.name.localeCompare(a.name));
    if(!jsonFiles.length){list.innerHTML='<em>No JSON files found in data/ folder.</em>';return}
    list.innerHTML=jsonFiles.map(f=>`
      <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border)">
        <span style="font-family:'JetBrains Mono',monospace;font-size:.75rem">${f.name}</span>
        <button class="btn btn-o btn-sm gh-load-file" data-path="${f.path}" data-sha="${f.sha}">Load</button>
      </div>
    `).join('');
    list.querySelectorAll('.gh-load-file').forEach(b=>b.onclick=()=>loadGHFile(b.dataset.path));
  }catch(e){LE(`List GH files: ${e.message}`);list.innerHTML=`<em style="color:var(--danger)">Error: ${e.message}</em>`}
}

async function loadGHFile(path){
  showDataMsg('info','Loading from GitHub...');
  try{
    const file=await ghAPI(path);
    const content=atob(file.content.replace(/\n/g,''));
    const data=JSON.parse(content);
    if(!data.data||!Array.isArray(data.data))throw new Error('Invalid format');
    let n=0;
    for(const f of data.data){if(f.id&&f.flights){await dbPut('flights',{...f,timestamp:Date.now()});n++}}
    if(data.favorites)data.favorites.forEach(f=>{if(!favorites.some(e=>e.code===f.code))favorites.push(f)});
    saveFavs();renderFavs();await updateStatus();
    showDataMsg('success',`Loaded ${n} routes from GitHub!`);LS(`Loaded ${n} routes from ${path}`);
  }catch(e){LE(`GH load failed: ${e.message}`);showDataMsg('error',`Load failed: ${e.message}`)}
}

async function saveToGH(){
  showDataMsg('info','Saving to GitHub...');
  try{
    const all=await dbGetAll('flights');
    const valid=all.filter(d=>Date.now()-d.timestamp<CACHE_H*36e5);
    if(!valid.length)throw new Error('No data to save');
    const exp={version:VER,exportDate:new Date().toISOString(),favorites,flightCount:valid.reduce((s,f)=>s+f.flights.length,0),routeCount:valid.length,data:valid};
    const content=btoa(unescape(encodeURIComponent(JSON.stringify(exp))));
    const now=new Date();
    const ts=`${fmtD(now)}-${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}${String(now.getSeconds()).padStart(2,'0')}`;
    const path=`data/flights-${ts}.json`;
    await ghAPI(path,'PUT',{message:`Add flight data ${ts}`,content});
    showDataMsg('success',`Saved to GitHub: ${path}`);LS(`Saved to GitHub: ${path}`);
  }catch(e){LE(`GH save failed: ${e.message}`);showDataMsg('error',`Save failed: ${e.message}`)}
}

// ‚ïê‚ïê‚ïê BOOKMARKLET ‚ïê‚ïê‚ïê
function buildBookmarklet(){
  // This runs on the Wizz Air multipass page
  const code=`javascript:void((function(){
if(!location.href.includes('multipass.wizzair.com')){alert('Open multipass.wizzair.com first!');return}
var panel=document.createElement('div');
panel.id='aycf-collector';
panel.style.cssText='position:fixed;top:10px;right:10px;z-index:999999;background:#1a1a2e;color:#e4e4f0;padding:16px;border-radius:12px;width:320px;font-family:sans-serif;font-size:13px;box-shadow:0 8px 32px rgba(0,0,0,.5);border:1px solid rgba(100,100,255,.2);max-height:90vh;overflow-y:auto;';
panel.innerHTML='<div style="font-size:16px;font-weight:700;margin-bottom:10px">‚úàÔ∏è AYCF Data Collector</div><div id="aycf-status">Initializing...</div><div id="aycf-prog" style="height:5px;background:rgba(0,212,255,.15);border-radius:3px;margin:8px 0;overflow:hidden"><div id="aycf-fill" style="height:100%;width:0%;background:linear-gradient(90deg,#00d4ff,#7b61ff);border-radius:3px;transition:width .3s"></div></div><div id="aycf-detail" style="font-size:11px;color:#8888aa"></div><div style="margin-top:10px"><button id="aycf-start" style="padding:8px 16px;border:none;border-radius:6px;background:linear-gradient(135deg,#00d4ff,#7b61ff);color:#fff;font-weight:700;cursor:pointer;margin-right:6px">‚ñ∂ Start Download</button><button id="aycf-stop" style="padding:8px 16px;border:none;border-radius:6px;background:#ff5577;color:#fff;font-weight:700;cursor:pointer;display:none">‚èπ Stop</button><button id="aycf-close" style="padding:8px 16px;border:none;border-radius:6px;background:rgba(255,255,255,.1);color:#ccc;cursor:pointer;margin-left:6px">‚úï Close</button></div>';
document.body.appendChild(panel);
var status=document.getElementById('aycf-status');
var fill=document.getElementById('aycf-fill');
var detail=document.getElementById('aycf-detail');
var startBtn=document.getElementById('aycf-start');
var stopBtn=document.getElementById('aycf-stop');
document.getElementById('aycf-close').onclick=function(){panel.remove()};
var running=false,stopped=false;
function getRoutes(){
  var h=document.head.innerHTML,b=document.body.innerHTML;
  var rp=/"routes":\\[(.*?)\\].*?"isOneWayFlightsOnly"/gms;
  var bp=/window\\.CVO\\.routes\\s*=\\s*(\\[.*?\\]);/s;
  var hm=h.match(rp),bm=b.match(bp),rj;
  if(hm&&hm[0])rj='{"routes":'+hm[0].split('"routes":')[1].split(',"isOneWayFlightsOnly"')[0]+'}';
  else if(bm&&bm[1])rj='{"routes":'+bm[1]+'}';
  if(rj)return JSON.parse(rj).routes;
  return null;
}
function getApiUrl(){
  var h=document.head.innerHTML,b=document.body.innerHTML;
  var hm=h.match(/"searchFlight":"https:\\/\\/multipass\\.wizzair\\.com[^"]+\\/([^"]+)"/);
  var bm=b.match(/window\\.CVO\\.flightSearchUrlJson\\s*=\\s*"(https:\\/\\/multipass\\.wizzair\\.com[^"]+)"/);
  if(hm&&hm[1])return'https://multipass.wizzair.com/w6/subscriptions/json/availability/'+hm[1];
  if(bm&&bm[1])return bm[1];
  return null;
}
status.textContent='Ready. Click Start to begin downloading.';
startBtn.onclick=async function(){
  if(running)return;running=true;stopped=false;
  startBtn.style.display='none';stopBtn.style.display='';
  status.textContent='Extracting routes...';
  var routes=getRoutes();
  if(!routes){status.textContent='‚ùå Could not find routes. Navigate to the booking page.';running=false;startBtn.style.display='';stopBtn.style.display='none';return}
  var apiUrl=getApiUrl();
  if(!apiUrl){status.textContent='‚ùå Could not find API URL. Navigate to booking/search page.';running=false;startBtn.style.display='';stopBtn.style.display='none';return}
  status.textContent='Found '+routes.length+' origins. Building tasks...';
  var tasks=[],seen=new Set();
  var today=new Date();
  var dates=[];
  for(var di=0;di<4;di++){var dd=new Date(today);dd.setDate(today.getDate()+di);var ds=dd.getFullYear()+'-'+String(dd.getMonth()+1).padStart(2,'0')+'-'+String(dd.getDate()).padStart(2,'0');dates.push(ds)}
  routes.forEach(function(r){
    var orig=r.departureStation.id;
    r.arrivalStations.forEach(function(d){
      dates.forEach(function(dt){
        var k=orig+'|'+d.id+'|'+dt;
        if(!seen.has(k)){seen.add(k);tasks.push({origin:orig,dest:d.id,date:dt})}
      });
    });
  });
  status.textContent='Downloading '+tasks.length+' routes over '+dates.length+' days...';
  var results=[],done=0,errors=0,rl=0;
  for(var i=0;i<tasks.length;i++){
    if(stopped)break;
    var t=tasks[i];
    fill.style.width=((i/tasks.length)*100)+'%';
    detail.textContent=t.origin+' ‚Üí '+t.dest+' ('+t.date+') ['+i+'/'+tasks.length+']';
    try{
      await new Promise(function(r){setTimeout(r,400+Math.random()*400)});
      var resp=await fetch(apiUrl,{method:'POST',headers:{'Content-Type':'application/json','Accept':'application/json'},body:JSON.stringify({flightType:'OW',origin:t.origin,destination:t.dest,departure:t.date,arrival:'',intervalSubtype:null}),credentials:'include'});
      if(resp.status===429){rl++;if(rl>=3){detail.textContent='Rate limited, waiting 60s...';await new Promise(function(r){setTimeout(r,60000)});rl=0}else{detail.textContent='Rate limited, waiting 15s...';await new Promise(function(r){setTimeout(r,15000)})}i--;continue}
      if(!resp.ok){errors++;results.push({id:t.origin+'-'+t.dest+'-'+t.date,origin:t.origin,dest:t.dest,date:t.date,flights:[],timestamp:Date.now()});done++;continue}
      rl=0;var data=await resp.json();
      var flights=data.flightsOutbound||data.flights||data.outbound||data.outboundFlights||[];
      if(Array.isArray(data))flights=data;
      flights=flights.map(function(f){return{departure:f.departure||f.departureTime||f.std||'',arrival:f.arrival||f.arrivalTime||f.sta||'',duration:f.duration||f.flightDuration||'',flightCode:f.flightCode||f.flightNumber||''}});
      results.push({id:t.origin+'-'+t.dest+'-'+t.date,origin:t.origin,dest:t.dest,date:t.date,flights:flights,timestamp:Date.now()});
      done++;if(done%30===0&&i<tasks.length-1){detail.textContent='Rate limit break (12s)...';await new Promise(function(r){setTimeout(r,12000)})}
    }catch(e){errors++;done++}
  }
  fill.style.width='100%';
  var totalFlights=results.reduce(function(s,r){return s+r.flights.length},0);
  status.textContent=stopped?'Stopped':'‚úÖ Done! '+totalFlights+' flights found across '+done+' routes ('+errors+' errors)';
  detail.textContent='Preparing download...';
  var exp={version:'3.0-collector',exportDate:new Date().toISOString(),favorites:[],flightCount:totalFlights,routeCount:results.length,data:results};
  var blob=new Blob([JSON.stringify(exp)],{type:'application/json'});
  var url=URL.createObjectURL(blob);
  var a=document.createElement('a');a.href=url;
  var ts2=new Date().toISOString().slice(0,19).replace(/[T:.]/g,'-');
  a.download='wizz-aycf-'+ts2+'.json';document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);
  detail.textContent='File downloaded! Import it into the AYCF web app.';
  running=false;startBtn.style.display='';startBtn.textContent='‚Üª Run Again';stopBtn.style.display='none';
};
stopBtn.onclick=function(){stopped=true;stopBtn.style.display='none'};
})())`;
  return code;
}

// ‚ïê‚ïê‚ïê SEARCH ‚ïê‚ïê‚ïê
function buildLookup(valid){
  const byOrigin=new Map(),byDest=new Map(),byKey=new Map();
  valid.forEach(d=>{
    byKey.set(`${d.origin}|${d.dest}|${d.date}`,d.flights||[]);
    if(!byOrigin.has(d.origin))byOrigin.set(d.origin,[]);
    byOrigin.get(d.origin).push({dest:d.dest,date:d.date,flights:d.flights||[]});
    if(!byDest.has(d.dest))byDest.set(d.dest,[]);
    byDest.get(d.dest).push({origin:d.origin,date:d.date,flights:d.flights||[]});
  });
  return{byOrigin,byDest,byKey};
}

async function doSearch(){
  L(`=== SEARCH mode=${mode} ===`);
  const all=await dbGetAll('flights');
  const valid=all.filter(d=>Date.now()-d.timestamp<CACHE_H*36e5);
  if(!valid.length){showRes('msg-e','No cached data. Import flight data first.');return}
  const lu=buildLookup(valid);
  switch(mode){
    case'dep':searchDep(lu);break;
    case'dest':searchDest(lu);break;
    case'rt':searchRT(lu);break;
    case'trip':searchTrip(lu);break;
  }
}

function searchDep(lu){
  const origins=getSel('depList'),s=$('depS').value,e=$('depE').value;
  if(!origins.length){showRes('msg-w','Select at least one origin.');return}
  if(!s||!e){showRes('msg-w','Set both dates.');return}
  L(`Departure search: ${origins.join(',')} from ${s} to ${e}`);
  const dates=dateRange(s,e),flights=[];
  origins.forEach(o=>{
    const data=lu.byOrigin.get(o)||[];
    dates.forEach(d=>{data.filter(r=>r.date===d).forEach(route=>{(route.flights||[]).forEach(f=>{flights.push({origin:o,dest:route.dest,date:d,flight:f})})})});
  });
  LS(`Found ${flights.length} flights`);
  displayDep(flights);
}

function searchDest(lu){
  const dests=getSel('destList'),s=$('destS').value,e=$('destE').value;
  if(!dests.length){showRes('msg-w','Select at least one destination.');return}
  if(!s||!e){showRes('msg-w','Set both dates.');return}
  L(`Destination search: ${dests.join(',')} from ${s} to ${e}`);
  const dates=dateRange(s,e),results=[];
  dests.forEach(dest=>{
    const data=lu.byDest.get(dest)||[];
    dates.forEach(d=>{data.filter(r=>r.date===d).forEach(route=>{(route.flights||[]).forEach(f=>{results.push({type:'direct',origin:route.origin,dest,date:d,flight:f})})})});
  });
  LS(`Found ${results.length} routes`);
  displayDest(results,dests);
}

function searchRT(lu){
  const sDate=$('rtS').value,eDate=$('rtE').value;
  const minStay=+$('rtMin').value,maxStay=+$('rtMax').value;
  if(!sDate||!eDate){showRes('msg-w','Set departure and return date ranges.');return}
  // Parse origin/dest filters
  const origFilter=$('rtOrigIn').value.toUpperCase().trim();
  const destFilter=$('rtDestIn').value.toUpperCase().trim();
  const origSet=origFilter?new Set(origFilter.split(/[,;\s]+/).filter(Boolean)):null;
  const destSet=destFilter?new Set(destFilter.split(/[,;\s]+/).filter(Boolean)):null;

  L(`Round-trip search: ${sDate} to ${eDate}, stay ${minStay}-${maxStay}d, orig=${origFilter||'any'}, dest=${destFilter||'any'}`);
  showRes('msg-i','<span class="spinner"></span> Searching round trips...');

  // Use setTimeout to not block UI
  setTimeout(()=>{
    const dates=dateRange(sDate,eDate);
    const results=[];
    const seen=new Set();

    // For each origin‚Üídest pair in the data, find outbound+return combos
    lu.byOrigin.forEach((routes,origin)=>{
      if(origSet&&!origSet.has(origin))return;
      routes.forEach(route=>{
        if(destSet&&!destSet.has(route.dest))return;
        if(!route.flights||!route.flights.length)return;
        if(!dates.includes(route.date))return;

        // For each outbound flight, look for return flights
        route.flights.forEach(outFlight=>{
          // Find return flights (dest‚Üíorigin)
          const returnRoutes=lu.byOrigin.get(route.dest)||[];
          returnRoutes.forEach(retRoute=>{
            if(retRoute.dest!==origin)return;
            if(!dates.includes(retRoute.date))return;
            const stay=daysBetween(route.date,retRoute.date);
            if(stay<minStay||stay>maxStay)return;
            if(!retRoute.flights||!retRoute.flights.length)return;

            retRoute.flights.forEach(retFlight=>{
              const key=`${origin}|${route.dest}|${route.date}|${retRoute.date}|${outFlight.departure}|${retFlight.departure}`;
              if(seen.has(key))return;
              seen.add(key);
              results.push({
                origin,dest:route.dest,
                outDate:route.date,retDate:retRoute.date,
                outFlight,retFlight,stay
              });
            });
          });
        });
      });
    });

    // Sort by stay duration, then origin
    results.sort((a,b)=>a.stay-b.stay||a.origin.localeCompare(b.origin)||a.dest.localeCompare(b.dest));
    LS(`Round-trip: found ${results.length} options`);
    displayRT(results);
  },50);
}

function searchTrip(lu){
  const homes=getSel('tripList'),s=$('tripS').value,e=$('tripE').value;
  const maxExtra=+$('tripHops').value,minDays=+$('tripMin').value;
  if(!homes.length){showRes('msg-w','Select home airport(s).');return}
  if(!s||!e){showRes('msg-w','Set dates.');return}
  L(`Trip search: homes=${homes.join(',')}, ${s}-${e}, extra=${maxExtra}, minDays=${minDays}`);
  showRes('msg-i','<span class="spinner"></span> Searching trips...');

  setTimeout(()=>{
    const dates=dateRange(s,e);
    const trips=[];
    const getF=(a,b,d)=>lu.byKey.get(`${a}|${b}|${d}`)||[];
    function validC(f1,d1,f2,d2){if(d2>d1)return true;if(d2<d1)return false;return parseT(f2.departure)>=parseT(f1.arrival)+MIN_LAY}
    function validR(f1,d1,f2,d2){if(d2>d1)return true;if(d2<d1)return false;return parseT(f2.departure)>=parseT(f1.arrival)+60}

    homes.forEach(home=>{
      const homeR=lu.byOrigin.get(home)||[];
      const dd=new Set(homeR.map(r=>r.dest));

      // 1-stop: H‚ÜíA‚ÜíH
      dd.forEach(d1=>{
        const ret=lu.byOrigin.get(d1)||[];
        if(!ret.some(r=>r.dest===home))return;
        dates.forEach(dt1=>{
          getF(home,d1,dt1).forEach(f1=>{
            dates.forEach(dt2=>{
              if(dt2<dt1)return;
              getF(d1,home,dt2).forEach(f2=>{
                if(!validR(f1,dt1,f2,dt2))return;
                const days=daysBetween(dt1,dt2);if(days<minDays)return;
                trips.push({home,hops:1,path:[home,d1,home],legs:[{from:home,to:d1,date:dt1,flight:f1},{from:d1,to:home,date:dt2,flight:f2}]});
              });
            });
          });
        });
      });

      // 2-stop: H‚ÜíA‚ÜíB‚ÜíH
      if(maxExtra>=1){
        dd.forEach(d1=>{
          (lu.byOrigin.get(d1)||[]).forEach(r=>{
            const d2=r.dest;if(d2===home)return;
            if(!(lu.byOrigin.get(d2)||[]).some(rr=>rr.dest===home))return;
            dates.forEach(dt1=>{
              const l1=getF(home,d1,dt1);if(!l1.length)return;const f1=l1[0];
              dates.forEach(dt2=>{
                if(dt2<dt1)return;
                for(const f2 of getF(d1,d2,dt2)){
                  if(!validC(f1,dt1,f2,dt2))continue;
                  dates.forEach(dt3=>{
                    if(dt3<dt2)return;
                    for(const f3 of getF(d2,home,dt3)){
                      if(!validC(f2,dt2,f3,dt3))continue;
                      const days=daysBetween(dt1,dt3);if(days<minDays)continue;
                      trips.push({home,hops:2,path:[home,d1,d2,home],legs:[{from:home,to:d1,date:dt1,flight:f1},{from:d1,to:d2,date:dt2,flight:f2},{from:d2,to:home,date:dt3,flight:f3}]});
                      return;
                    }
                  });break;
                }
              });
            });
          });
        });
      }
    });
    LS(`Trip search: ${trips.length} trips found`);
    displayTrips(trips);
  },50);
}

// ‚ïê‚ïê‚ïê DISPLAY ‚ïê‚ïê‚ïê
function showRes(cls,html){$('results').innerHTML=`<div class="msg ${cls}">${html}</div>`}

function displayDep(flights){
  const R=$('results');
  if(!flights.length){showRes('msg-w','No flights found.');return}
  const byD={};flights.forEach(f=>{if(!byD[f.date])byD[f.date]=[];byD[f.date].push(f)});
  let h=`<div class="msg msg-s">Found <strong>${flights.length}</strong> flights</div>`;
  Object.keys(byD).sort().forEach(d=>{
    h+=`<div class="date-hdr">${fmtDD(d)} ‚Äî ${byD[d].length} flights</div>`;
    byD[d].forEach(f=>{h+=flightCard(f.origin,f.dest,f.date,f.flight)});
  });
  R.innerHTML=h;
}

function displayDest(results,dests){
  const R=$('results');
  if(!results.length){showRes('msg-w',`No routes to ${dests.join(', ')}.`);return}
  const byD={};results.forEach(f=>{if(!byD[f.dest])byD[f.dest]=[];byD[f.dest].push(f)});
  let h=`<div class="msg msg-s">Found <strong>${results.length}</strong> routes</div>`;
  Object.keys(byD).sort().forEach(d=>{
    h+=`<div class="dest-hdr">üéØ ${apDisp(d)} (${byD[d].length})</div>`;
    byD[d].slice(0,30).forEach(f=>{h+=flightCard(f.origin,f.dest,f.date,f.flight)});
    if(byD[d].length>30)h+=`<div class="msg msg-i">${byD[d].length-30} more...</div>`;
  });
  R.innerHTML=h;
}

function displayRT(results){
  const R=$('results');
  if(!results.length){showRes('msg-w','No round trips found. Try widening dates or filters.');return}
  let h=`<div class="msg msg-s">Found <strong>${results.length}</strong> round-trip options</div>`;
  const limit=Math.min(results.length,100);
  if(results.length>limit)h+=`<div class="msg msg-i">Showing first ${limit} of ${results.length}</div>`;
  results.slice(0,limit).forEach(r=>{
    h+=`<div class="fc">
      <div class="fc-route">
        <span class="rt">${apShort(r.origin)} ‚Üî ${apShort(r.dest)}</span>
        <span class="badge b-dir">${r.stay}d trip</span>
      </div>
      <div class="lay-box">
        <strong>Outbound:</strong> ${fmtDD(r.outDate)}<br>
        ${apShort(r.origin)} ‚Üí ${apShort(r.dest)} ¬∑ <span class="mono">${fmtT(r.outFlight.departure)}</span> ‚Üí <span class="mono">${fmtT(r.outFlight.arrival)}</span> ¬∑ ${r.outFlight.duration||''}
        <a href="${bookUrl(r.origin,r.dest,r.outDate)}" target="_blank" class="book" style="margin-left:6px;padding:3px 8px;font-size:.7rem">Book</a><br><br>
        <strong>Return:</strong> ${fmtDD(r.retDate)}<br>
        ${apShort(r.dest)} ‚Üí ${apShort(r.origin)} ¬∑ <span class="mono">${fmtT(r.retFlight.departure)}</span> ‚Üí <span class="mono">${fmtT(r.retFlight.arrival)}</span> ¬∑ ${r.retFlight.duration||''}
        <a href="${bookUrl(r.dest,r.origin,r.retDate)}" target="_blank" class="book" style="margin-left:6px;padding:3px 8px;font-size:.7rem">Book</a>
      </div>
    </div>`;
  });
  R.innerHTML=h;
}

function displayTrips(trips){
  const R=$('results');
  if(!trips.length){showRes('msg-w','No trip itineraries found.');return}
  const byH={1:[],2:[],3:[]};trips.forEach(t=>{if(byH[t.hops])byH[t.hops].push(t)});
  let h=`<div class="msg msg-s">Found <strong>${trips.length}</strong> trip itineraries</div>`;
  [1,2,3].forEach(hp=>{
    if(!byH[hp].length)return;
    const lbl=hp===1?'Direct Round Trip':hp===2?'1 Extra Stop':'2 Extra Stops';
    h+=`<div class="dest-hdr" style="background:linear-gradient(135deg,#7b61ff,#5a3fd4)">üîÑ ${lbl} (${byH[hp].length})</div>`;
    const byP={};byH[hp].forEach(t=>{const k=t.path.join('-');if(!byP[k])byP[k]=[];byP[k].push(t)});
    Object.keys(byP).slice(0,15).forEach(pk=>{
      const pts=byP[pk],s=pts[0];
      h+=`<div class="fc" style="border-left:3px solid #7b61ff">
        <div class="trip-path">${s.path.map((p,i)=>`<span class="lb"><span class="ac">${p}</span><small>${(airportInfo.get(p)||{}).name||''}</small></span>${i<s.path.length-1?'<span class="as">‚Üí</span>':''}`).join('')}</div>`;
      pts.slice(0,3).forEach(trip=>{
        const days=daysBetween(trip.legs[0].date,trip.legs[trip.legs.length-1].date);
        h+=`<div class="lay-box"><div class="trip-dur">üìÖ ${days===0?'Same day':days+' days'}</div>`;
        trip.legs.forEach((l,i)=>{
          h+=`<div class="trip-leg"><strong>Leg ${i+1}:</strong> ${fmtDD(l.date)} ¬∑ ${apShort(l.from)} ‚Üí ${apShort(l.to)} ¬∑ <span class="mono">${fmtT(l.flight.departure)}</span> ‚Üí <span class="mono">${fmtT(l.flight.arrival)}</span> <a href="${bookUrl(l.from,l.to,l.date)}" target="_blank" class="book" style="padding:2px 6px;font-size:.68rem">Book</a></div>`;
        });
        h+='</div>';
      });
      if(pts.length>3)h+=`<div style="font-size:.72rem;color:var(--text-muted);padding:4px 0">+${pts.length-3} more date options</div>`;
      h+='</div>';
    });
  });
  R.innerHTML=h;
}

function flightCard(origin,dest,date,flight){
  return`<div class="fc"><div class="fc-route"><span class="rt">${apShort(origin)} ‚Üí ${apShort(dest)}</span><span class="badge b-dir">Direct</span></div><div class="fc-info">üìÖ ${fmtDD(date)} ¬∑ ‚úàÔ∏è <span class="mono">${fmtT(flight.departure)}</span> ‚Üí üõ¨ <span class="mono">${fmtT(flight.arrival)}</span> ¬∑ ${flight.duration||''} ¬∑ ${flight.flightCode||''}</div><a href="${bookUrl(origin,dest,date)}" target="_blank" class="book">üé´ Book</a></div>`;
}

// ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê
async function init(){
  L(`Initializing v${VER}...`);
  await initDB();
  loadFavs();renderFavs();loadGHSettings();

  // Dates
  const today=fmtD(new Date()),maxD=fmtD((()=>{const d=new Date();d.setDate(d.getDate()+3);return d})());
  ['depS','destS','tripS','rtS'].forEach(id=>{const e=$(id);if(e){e.value=today;e.min=today}});
  ['depE','destE','tripE','rtE'].forEach(id=>{const e=$(id);if(e){e.value=maxD;e.min=today}});

  await updateStatus();

  // Build bookmarklet
  const bmCode=buildBookmarklet();
  $('bmLink').href=bmCode;
  $('bmCode').textContent=bmCode;

  LS('App initialized');
}

// ‚ïê‚ïê‚ïê EVENTS ‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded',()=>{
  // Tabs
  $$('.tab').forEach(t=>t.onclick=()=>{
    $$('.tab').forEach(b=>b.classList.remove('on'));t.classList.add('on');
    mode=t.dataset.m;$$('.panel').forEach(p=>p.classList.remove('on'));$('p-'+mode).classList.add('on');
  });

  // Favorites
  $('btnFav').onclick=()=>{const i=$('favIn');if(addFav(i.value))i.value=''};
  $('favIn').onkeypress=e=>{if(e.key==='Enter'){const i=$('favIn');if(addFav(i.value))i.value=''}};

  // Select helpers
  $$('.sfav').forEach(b=>b.onclick=()=>setSel(b.dataset.l,favorites.map(f=>f.code)));
  $$('.sall').forEach(b=>b.onclick=()=>setSel(b.dataset.l,[...airportInfo.keys()]));
  $$('.sclr').forEach(b=>b.onclick=()=>setSel(b.dataset.l,[]));

  // Search
  $('btnSearch').onclick=doSearch;

  // Import/Export
  $('btnImport').onclick=()=>$('fileIn').click();
  $('fileIn').onchange=e=>{if(e.target.files.length){importJSON(e.target.files[0]);e.target.value=''}};
  $('btnExport').onclick=exportJSON;
  $('btnClear').onclick=async()=>{if(confirm('Clear all cached data?')){await dbClear('flights');await updateStatus();$('results').innerHTML='';LS('Cache cleared')}};

  // GitHub
  $('btnGH').onclick=()=>{$('modalGH').classList.add('open');listGHFiles()};
  $('btnCloseGH').onclick=()=>$('modalGH').classList.remove('open');
  $('modalGH').onclick=e=>{if(e.target===$('modalGH'))$('modalGH').classList.remove('open')};
  $('btnGHSettSave').onclick=()=>{saveGHSettings();$('ghMsg').innerHTML='<div class="msg msg-s">Saved!</div>'};
  $('btnGHTest').onclick=testGH;
  $('btnGHLoad').onclick=async()=>{
    try{const s=getGH();if(!s.token){$('modalGH').classList.add('open');return}
    showDataMsg('info','Loading from GitHub...');
    let files;try{files=await ghAPI('data')}catch{showDataMsg('error','No data/ folder found in repo.');return}
    const jsons=(Array.isArray(files)?files:[]).filter(f=>f.name.endsWith('.json')).sort((a,b)=>b.name.localeCompare(a.name));
    if(!jsons.length){showDataMsg('warning','No JSON files in data/ folder.');return}
    await loadGHFile(jsons[0].path);
    }catch(e){showDataMsg('error',e.message)}
  };
  $('btnGHSave').onclick=saveToGH;

  // Debug log
  $('btnLog').onclick=()=>$('modalLog').classList.add('open');
  $('btnCloseLog').onclick=()=>$('modalLog').classList.remove('open');
  $('modalLog').onclick=e=>{if(e.target===$('modalLog'))$('modalLog').classList.remove('open')};
  $('btnLogClear').onclick=()=>{logs=[];$('logArea').innerHTML='';$('logCount').textContent='(0)'};
  $('btnLogExport').onclick=()=>{
    const blob=new Blob([logs.map(l=>l.line).join('\n')],{type:'text/plain'});
    const url=URL.createObjectURL(blob);const a=document.createElement('a');
    a.href=url;a.download=`aycf-log-${fmtD(new Date())}.txt`;document.body.appendChild(a);a.click();document.body.removeChild(a);
  };

  // Collapsibles
  $('collectorHdr').onclick=()=>{$('collectorHdr').classList.toggle('open');$('collectorBody').classList.toggle('open')};

  // Bookmarklet copy
  $('btnCopyBM').onclick=()=>{
    $('bmCode').classList.toggle('hidden');
    navigator.clipboard.writeText($('bmCode').textContent).then(()=>showDataMsg('success','Bookmarklet code copied!')).catch(()=>{});
  };

  init();
});
</script>
</body>
</html>
