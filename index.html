<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0d1117">
<title>Wizz AYCF Route Finder</title>
<link rel="manifest" href="manifest.json">
<link rel="icon" href="icon-192.png">
<link rel="apple-touch-icon" href="icon-192.png">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0d1117;--s1:#161b22;--s2:#1c2333;--s3:#252d3d;
  --bdr:#30363d;--bdr2:#484f58;
  --acc:#58a6ff;--acc2:#a371f7;--grn:#3fb950;--ylw:#d29922;--red:#f85149;--pnk:#f778ba;
  --tx:#e6edf3;--tx2:#8b949e;--tx3:#6e7681;
  --r:10px;--rs:6px;
  --sat:env(safe-area-inset-top,0px);--sab:env(safe-area-inset-bottom,0px);
}
html{font-size:15px;-webkit-text-size-adjust:100%}
body{font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:var(--tx);
  min-height:100dvh;overflow-x:hidden;padding-bottom:calc(16px + var(--sab));
  -webkit-font-smoothing:antialiased;-webkit-tap-highlight-color:transparent}

/* Header */
.hd{position:sticky;top:0;z-index:100;background:rgba(13,17,23,.92);
  backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);
  border-bottom:1px solid var(--bdr);padding:10px 14px}
.hd-r{display:flex;align-items:center;justify-content:space-between;max-width:680px;margin:0 auto}
.hd-t{font-size:1rem;font-weight:800;display:flex;align-items:center;gap:6px}
.hd-t .g{background:linear-gradient(90deg,var(--acc),var(--acc2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.hd-t .v{font-weight:400;font-size:.65rem;color:var(--tx3);-webkit-text-fill-color:var(--tx3)}
.hd-a{display:flex;gap:4px}
.ib{width:36px;height:36px;border-radius:8px;border:1px solid var(--bdr);background:var(--s1);
  color:var(--tx2);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:.95rem}
.ib:active{background:var(--s2);border-color:var(--acc)}

/* Container */
.ct{max-width:680px;margin:0 auto;padding:10px 12px}

/* Cards */
.cd{background:var(--s1);border:1px solid var(--bdr);border-radius:var(--r);padding:14px;margin-bottom:10px}
.cd-t{font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em;
  color:var(--tx2);margin-bottom:10px;display:flex;align-items:center;gap:6px}

/* Status */
.st{border-radius:var(--r);padding:14px;margin-bottom:10px;border:1px solid}
.st-e{background:rgba(248,81,73,.06);border-color:rgba(248,81,73,.3)}
.st-o{background:rgba(63,185,80,.06);border-color:rgba(63,185,80,.3)}
.st-l{background:rgba(88,166,255,.06);border-color:rgba(88,166,255,.3)}
.st-i{font-size:1.1rem;margin-bottom:2px}
.st-h{font-weight:700;font-size:.9rem;margin-bottom:3px}
.st-d{font-size:.78rem;color:var(--tx2);line-height:1.4}
.st-s{display:flex;gap:16px;flex-wrap:wrap;margin-top:8px}
.sn{font-family:'JetBrains Mono',monospace;font-size:1.15rem;font-weight:600;color:var(--grn)}
.sl{font-size:.6rem;color:var(--tx3);text-transform:uppercase;letter-spacing:.04em}

/* Buttons */
.bt{display:inline-flex;align-items:center;gap:4px;padding:10px 14px;border-radius:var(--rs);
  border:none;font-family:'Inter',sans-serif;font-size:.82rem;font-weight:600;cursor:pointer;
  transition:all .15s;white-space:nowrap;min-height:40px;-webkit-tap-highlight-color:transparent}
.bt:active{transform:scale(.97);filter:brightness(.85)}
.bt:disabled{opacity:.3;pointer-events:none}
.bt-p{background:var(--acc);color:#0d1117}
.bt-g{background:var(--grn);color:#0d1117}
.bt-o{background:transparent;border:1px solid var(--bdr);color:var(--tx2)}
.bt-o:active{border-color:var(--acc);color:var(--acc)}
.bt-d{background:rgba(248,81,73,.12);border:1px solid rgba(248,81,73,.3);color:var(--red)}
.bt-w{background:var(--ylw);color:#0d1117}
.bt-sm{padding:7px 10px;font-size:.76rem;min-height:34px}
.bt-f{width:100%;justify-content:center}
.rw{display:flex;gap:6px;flex-wrap:wrap}.rw.mb{margin-bottom:10px}

/* Inputs */
.ip{width:100%;background:var(--s2);border:1px solid var(--bdr);border-radius:var(--rs);
  padding:11px 12px;color:var(--tx);font-family:'Inter',sans-serif;font-size:.88rem;min-height:42px}
.ip::placeholder{color:var(--tx3)}.ip:focus{outline:none;border-color:var(--acc)}
.ip-m{font-family:'JetBrains Mono',monospace;text-transform:uppercase;letter-spacing:.08em}
select.ip{-webkit-appearance:none;appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath d='M3 5l3 3 3-3' stroke='%238b949e' fill='none' stroke-width='1.5'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 10px center;padding-right:28px}
.ip-row{display:flex;gap:8px;margin-bottom:8px}.ip-row .ip{flex:1}

/* Favorites */
.fav-c{display:flex;flex-wrap:wrap;gap:5px;min-height:28px}
.fav{display:inline-flex;align-items:center;gap:3px;background:rgba(88,166,255,.1);
  border:1px solid rgba(88,166,255,.2);border-radius:14px;padding:4px 8px 4px 10px;font-size:.76rem}
.fav .c{font-family:'JetBrains Mono',monospace;font-weight:600;color:var(--acc)}
.fav .n{color:var(--tx3);font-size:.65rem}
.fav .x{width:18px;height:18px;border-radius:50%;background:rgba(248,81,73,.15);
  color:var(--red);border:none;cursor:pointer;font-size:.65rem;display:flex;align-items:center;justify-content:center}
.fav-e{color:var(--tx3);font-size:.78rem;font-style:italic}

/* Tabs */
.tb{display:flex;background:var(--s1);border-radius:var(--r);padding:3px;
  margin-bottom:10px;border:1px solid var(--bdr);overflow-x:auto;gap:2px}
.t{flex:1;min-width:0;padding:9px 4px;border:none;background:none;color:var(--tx3);
  font-family:'Inter',sans-serif;font-size:.72rem;font-weight:600;border-radius:7px;
  cursor:pointer;text-align:center;white-space:nowrap}
.t.on{background:var(--acc);color:#0d1117;font-weight:700}
.pn{display:none}.pn.on{display:block}

/* Airport list */
.ap-b{max-height:220px;overflow-y:auto;border:1px solid var(--bdr);border-radius:var(--rs);
  background:var(--bg);-webkit-overflow-scrolling:touch}
.ap-gh{position:sticky;top:0;z-index:2;background:var(--s2);padding:8px 10px;font-size:.72rem;
  font-weight:700;color:var(--tx2);cursor:pointer;display:flex;justify-content:space-between;
  align-items:center;border-bottom:1px solid var(--bdr);user-select:none}
.ap-gh:active{background:var(--s3)}
.ap-gh .ar{font-size:.6rem;transition:transform .2s}.ap-gh.op .ar{transform:rotate(90deg)}
.ap-gb{display:none;padding:5px;flex-wrap:wrap;gap:4px}.ap-gb.op{display:flex}
.ap-c{display:inline-flex;align-items:center;gap:3px;padding:7px 9px;border-radius:5px;
  background:var(--s1);border:1px solid var(--bdr);cursor:pointer;font-size:.74rem;
  user-select:none;min-height:34px}
.ap-c:active{transform:scale(.96)}
.ap-c.sl{background:rgba(88,166,255,.15);border-color:var(--acc);color:var(--acc)}
.ap-c .ac{font-family:'JetBrains Mono',monospace;font-weight:600;font-size:.78rem}
.ap-c .an{color:var(--tx3);font-size:.64rem}
.ap-c.fv{border-color:var(--ylw)}

/* Date grid */
.dg{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:10px 0}
.dg label{display:block;font-size:.68rem;font-weight:600;color:var(--tx3);text-transform:uppercase;letter-spacing:.04em;margin-bottom:3px}
.dg input[type="date"]{width:100%;background:var(--s2);border:1px solid var(--bdr);border-radius:var(--rs);
  padding:10px;color:var(--tx);font-family:'Inter',sans-serif;font-size:.85rem;min-height:42px;-webkit-appearance:none}
.dg input[type="date"]:focus{outline:none;border-color:var(--acc)}
input[type="date"]::-webkit-calendar-picker-indicator{filter:invert(.55)}

/* Options */
.or{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;align-items:center}
.or label{font-size:.76rem;font-weight:600;color:var(--tx2)}

/* Search button */
.sb{width:100%;padding:14px;border:none;border-radius:var(--r);background:var(--acc);color:#0d1117;
  font-family:'Inter',sans-serif;font-size:.95rem;font-weight:700;cursor:pointer;margin:12px 0;
  min-height:48px}
.sb:active{filter:brightness(.8);transform:scale(.99)}
.sb:disabled{opacity:.3;cursor:not-allowed}

/* Results */
.rs{margin-top:8px}
.mg{padding:12px;border-radius:var(--rs);margin-bottom:8px;font-size:.82rem;line-height:1.5}
.mg-i{background:rgba(88,166,255,.06);border:1px solid rgba(88,166,255,.2);color:#79c0ff}
.mg-s{background:rgba(63,185,80,.06);border:1px solid rgba(63,185,80,.2);color:var(--grn)}
.mg-w{background:rgba(210,153,34,.06);border:1px solid rgba(210,153,34,.2);color:var(--ylw)}
.mg-e{background:rgba(248,81,73,.06);border:1px solid rgba(248,81,73,.2);color:var(--red)}
.dh{font-size:.78rem;font-weight:700;color:var(--acc);margin:12px 0 6px;padding:7px 10px;
  background:rgba(88,166,255,.06);border-radius:var(--rs);border-left:3px solid var(--acc)}
.deh{font-size:.82rem;font-weight:700;padding:9px 12px;margin:12px 0 6px;border-radius:var(--rs);
  background:var(--acc);color:#0d1117}
.fc{background:var(--s1);border:1px solid var(--bdr);border-radius:var(--rs);padding:12px;margin-bottom:6px}
.fc-r{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.fc-r .rt{font-weight:700;font-size:.84rem}
.bg{padding:2px 7px;border-radius:4px;font-size:.62rem;font-weight:700;text-transform:uppercase;letter-spacing:.03em}
.bg-d{background:rgba(63,185,80,.12);color:var(--grn)}
.bg-s{background:rgba(210,153,34,.12);color:var(--ylw)}
.fc-i{font-size:.76rem;color:var(--tx2);line-height:1.5}
.fc-i .m{font-family:'JetBrains Mono',monospace;color:var(--tx)}
.bk{display:inline-flex;align-items:center;gap:3px;margin-top:6px;padding:6px 11px;border-radius:4px;
  background:var(--grn);color:#0d1117;text-decoration:none;font-size:.72rem;font-weight:600;min-height:32px}
.bk:active{filter:brightness(.8)}
.lb{background:var(--s2);border-radius:5px;padding:8px;margin-top:6px;font-size:.74rem;line-height:1.6;color:var(--tx2)}

/* Modal */
.mo{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:200;align-items:flex-end;justify-content:center}
.mo.op{display:flex}
.mo-s{width:100%;max-width:520px;background:var(--s1);border-radius:14px 14px 0 0;
  padding:16px 14px calc(16px + var(--sab));max-height:88dvh;overflow-y:auto;animation:su .25s ease-out}
@keyframes su{from{transform:translateY(100%)}to{transform:translateY(0)}}
.mo-h{width:36px;height:3px;background:var(--tx3);border-radius:2px;margin:0 auto 12px}
.mo-t{font-size:1rem;font-weight:700;margin-bottom:12px}

/* Progress */
.pg{height:4px;background:rgba(88,166,255,.12);border-radius:2px;overflow:hidden;margin:6px 0}
.pg .fl{height:100%;background:linear-gradient(90deg,var(--acc),var(--acc2));border-radius:2px;transition:width .3s;width:0%}

/* Log */
.la{background:var(--bg);border:1px solid var(--bdr);border-radius:var(--rs);max-height:280px;
  overflow-y:auto;padding:8px;font-family:'JetBrains Mono',monospace;font-size:.65rem;
  line-height:1.5;color:var(--tx3);white-space:pre-wrap;word-break:break-all}
.la .e{color:var(--red)}.la .w{color:var(--ylw)}.la .s{color:var(--grn)}.la .a{color:var(--acc)}

/* Collapsible */
.cl-h{cursor:pointer;display:flex;justify-content:space-between;align-items:center;user-select:none}
.cl-h .tg{font-size:.65rem;color:var(--tx3);transition:transform .2s}
.cl-h.op .tg{transform:rotate(180deg)}
.cl-b{display:none;margin-top:10px}.cl-b.op{display:block}

/* Steps */
.stp{counter-reset:step;margin:10px 0}
.sp{counter-increment:step;padding-left:30px;position:relative;margin-bottom:10px;font-size:.8rem;line-height:1.5;color:var(--tx2)}
.sp::before{content:counter(step);position:absolute;left:0;top:0;width:22px;height:22px;border-radius:50%;
  background:var(--acc);color:var(--bg);font-size:.7rem;font-weight:700;display:flex;align-items:center;justify-content:center}
.sp strong{color:var(--tx)}

/* Misc */
.hd-n{display:none!important}
.sep{border:none;border-top:1px solid var(--bdr);margin:12px 0}
.sp-n{display:inline-block;width:14px;height:14px;border:2px solid rgba(88,166,255,.2);
  border-top-color:var(--acc);border-radius:50%;animation:spi .6s linear infinite}
@keyframes spi{to{transform:rotate(360deg)}}
.ft{text-align:center;font-size:.68rem;color:var(--tx3);padding:18px 0}
.ft a{color:var(--acc);text-decoration:none}
::-webkit-scrollbar{width:3px}::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:rgba(88,166,255,.15);border-radius:2px}
.code-box{background:var(--bg);border:1px solid var(--bdr);border-radius:var(--rs);padding:8px;
  font-family:'JetBrains Mono',monospace;font-size:.62rem;color:var(--acc);max-height:100px;
  overflow-y:auto;word-break:break-all;user-select:all;-webkit-user-select:all;margin:6px 0}
.gh-g{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px}
@media(max-width:380px){.gh-g{grid-template-columns:1fr}}
.lbl{font-size:.68rem;font-weight:600;color:var(--tx3);text-transform:uppercase;letter-spacing:.03em;margin-bottom:3px;display:block}
</style>
</head>
<body>

<!-- HEADER -->
<header class="hd">
<div class="hd-r">
  <div class="hd-t">‚úàÔ∏è <span class="g">AYCF Finder</span> <span class="v">v3.1</span></div>
  <div class="hd-a">
    <button class="ib" id="bLog" title="Debug Log">üîß</button>
    <button class="ib" id="bGH" title="Settings">‚öôÔ∏è</button>
  </div>
</div>
</header>

<main class="ct">

<!-- STATUS -->
<div class="st st-e" id="stC">
  <div class="st-i" id="stI">üì≠</div>
  <div class="st-h" id="stH">No Flight Data</div>
  <div class="st-d" id="stD">Login to Wizz Air or import data to get started.</div>
  <div class="st-s hd-n" id="stS">
    <div><div class="sn" id="s1">0</div><div class="sl">Flights</div></div>
    <div><div class="sn" id="s2">0</div><div class="sl">Origins</div></div>
    <div><div class="sn" id="s3">0</div><div class="sl">Routes</div></div>
    <div><div class="sn" id="s4">0</div><div class="sl">Days</div></div>
  </div>
</div>

<!-- PROXY SETUP (shown when no proxy configured) -->
<div class="cd" id="proxySetup">
  <div class="cd-t">üîß One-Time Setup (required)</div>
  <p style="font-size:.8rem;color:var(--tx2);margin-bottom:10px">
    To connect to Wizz Air from this app, you need a free <strong style="color:var(--tx)">Cloudflare Worker</strong> proxy (takes 2 minutes).
  </p>
  <div class="cl-h" id="setupHdr"><span style="font-size:.78rem;font-weight:600;color:var(--acc)">üìã Setup Instructions</span><span class="tg">‚ñº</span></div>
  <div class="cl-b" id="setupBody">
    <div class="stp">
      <div class="sp">Go to <a href="https://dash.cloudflare.com/sign-up" target="_blank" style="color:var(--acc)">Cloudflare</a> ‚Üí Create free account (or log in)</div>
      <div class="sp"><strong>Workers & Pages</strong> ‚Üí <strong>Create</strong></div>
      <div class="sp">Click <strong>"Start with Hello World!"</strong> (green globe icon)</div>
      <div class="sp">Name it anything (e.g. <code style="color:var(--acc)">aycf-proxy</code>) ‚Üí Click <strong>Deploy</strong></div>
      <div class="sp">Click <strong>"Edit Code"</strong> ‚Üí Select all existing code ‚Üí Delete it ‚Üí Paste the code below ‚Üí Click <strong>Deploy</strong></div>
      <div class="sp">Copy your Worker URL from the top (like <code style="color:var(--acc)">https://aycf-proxy.YOUR.workers.dev</code>) and paste it below</div>
      <div class="sp">Click <strong>Test</strong> to verify it works! ‚úÖ</div>
    </div>
    <div style="display:flex;gap:6px;margin-bottom:8px">
      <button class="bt bt-p bt-sm" id="bCopyWorker">üìã Copy Worker Code</button>
    </div>
    <div class="code-box hd-n" id="workerCode"></div>
  </div>
  <div class="ip-row" style="margin-top:10px">
    <input class="ip" id="proxyUrl" placeholder="https://aycf-proxy.xxx.workers.dev" autocomplete="url">
    <button class="bt bt-g" id="bSaveProxy">Save</button>
    <button class="bt bt-p bt-sm" id="bTestProxy" style="white-space:nowrap">üß™ Test</button>
  </div>
  <div id="proxyMsg" style="margin-top:6px"></div>
</div>

<!-- LOGIN & DOWNLOAD -->
<div class="cd" id="loginCard">
  <div class="cd-t">üîë Wizz Air Login & Download</div>
  <div class="ip-row">
    <input class="ip" id="wizEmail" type="email" placeholder="Email" autocomplete="email">
  </div>
  <div class="ip-row">
    <input class="ip" id="wizPass" type="password" placeholder="Password" autocomplete="current-password">
  </div>
  <div class="rw mb">
    <button class="bt bt-p" id="bLogin">üöÄ Login & Download All</button>
    <button class="bt bt-o hd-n" id="bPause">‚è∏ Pause</button>
    <button class="bt bt-d hd-n" id="bStop">‚èπ Stop</button>
  </div>
  <div class="pg hd-n" id="dlProg"><div class="fl" id="dlFill"></div></div>
  <div id="dlStatus" style="font-size:.75rem;color:var(--tx2);margin-top:4px"></div>
  <div id="loginMsg"></div>
</div>

<!-- DATA MANAGEMENT -->
<div class="cd">
  <div class="cd-t">üì¶ Data Management</div>
  <div class="rw mb">
    <button class="bt bt-o bt-sm" id="bImport">üì• Import</button>
    <button class="bt bt-o bt-sm" id="bExport">üì§ Export</button>
    <button class="bt bt-o bt-sm" id="bGHLoad">‚òÅÔ∏è GitHub</button>
    <button class="bt bt-o bt-sm" id="bGHSave">üíæ Save GH</button>
    <button class="bt bt-d bt-sm" id="bClear">üóëÔ∏è</button>
  </div>
  <input type="file" id="fileIn" accept=".json" style="display:none">
  <div id="dMsg"></div>
</div>

<!-- FAVORITES -->
<div class="cd">
  <div class="cd-t">‚≠ê Favorites</div>
  <div class="ip-row">
    <input class="ip ip-m" id="favI" placeholder="TLV" maxlength="3" autocomplete="off" autocapitalize="characters">
    <button class="bt bt-p bt-sm" id="bFav">Add</button>
  </div>
  <div class="fav-c" id="favC"><span class="fav-e">No favorites</span></div>
</div>

<!-- MODE TABS -->
<div class="tb">
  <button class="t on" data-m="dep">‚úàÔ∏è From</button>
  <button class="t" data-m="dest">üéØ To</button>
  <button class="t" data-m="rt">üîÑ Round Trip</button>
  <button class="t" data-m="trip">üóìÔ∏è Multi-Hop</button>
</div>

<!-- FROM ORIGIN -->
<div class="pn on" id="p-dep">
  <div class="cd">
    <div class="cd-t">üõ´ Origin Airports</div>
    <input class="ip" id="dSr" placeholder="Search airports..." style="margin-bottom:6px">
    <div class="rw mb">
      <button class="bt bt-o bt-sm sf" data-l="dL">‚≠ê</button>
      <button class="bt bt-o bt-sm sa" data-l="dL">All</button>
      <button class="bt bt-o bt-sm sc" data-l="dL">Clear</button>
    </div>
    <div class="ap-b" id="dL"></div>
  </div>
  <div class="dg">
    <div><label>From</label><input type="date" id="dS"></div>
    <div><label>To</label><input type="date" id="dE"></div>
  </div>
</div>

<!-- TO DESTINATION -->
<div class="pn" id="p-dest">
  <div class="cd">
    <div class="cd-t">üéØ Destination Airports</div>
    <input class="ip" id="sSr" placeholder="Search airports..." style="margin-bottom:6px">
    <div class="rw mb">
      <button class="bt bt-o bt-sm sf" data-l="sL">‚≠ê</button>
      <button class="bt bt-o bt-sm sa" data-l="sL">All</button>
      <button class="bt bt-o bt-sm sc" data-l="sL">Clear</button>
    </div>
    <div class="ap-b" id="sL"></div>
  </div>
  <div class="dg">
    <div><label>From</label><input type="date" id="sS"></div>
    <div><label>To</label><input type="date" id="sE"></div>
  </div>
</div>

<!-- ROUND TRIP -->
<div class="pn" id="p-rt">
  <div class="cd">
    <div class="cd-t">üîÑ Round Trip ‚Äî Anywhere ‚Üî Anywhere</div>
    <p style="font-size:.76rem;color:var(--tx2);margin-bottom:8px">Find all round-trip combos in cached data.</p>
    <div class="or"><label>Origin:</label><input class="ip ip-m" id="rtO" placeholder="Any (or TLV,BUD)" style="width:140px" autocapitalize="characters"></div>
    <div class="or"><label>Dest:</label><input class="ip ip-m" id="rtD" placeholder="Any (or BCN,ATH)" style="width:140px" autocapitalize="characters"></div>
  </div>
  <div class="dg">
    <div><label>Depart after</label><input type="date" id="rtS"></div>
    <div><label>Return before</label><input type="date" id="rtE"></div>
  </div>
  <div class="or">
    <label>Min stay:</label>
    <select class="ip" id="rtMn" style="width:90px"><option value="0">Any</option><option value="1">1d</option><option value="2" selected>2d</option><option value="3">3d</option><option value="5">5d</option><option value="7">7d</option></select>
    <label>Max:</label>
    <select class="ip" id="rtMx" style="width:90px"><option value="3">3d</option><option value="5">5d</option><option value="7" selected>7d</option><option value="14">14d</option><option value="30">30d</option><option value="99">Any</option></select>
  </div>
</div>

<!-- MULTI-HOP -->
<div class="pn" id="p-trip">
  <div class="cd">
    <div class="cd-t">üè† Home Airports</div>
    <p style="font-size:.76rem;color:var(--tx2);margin-bottom:6px">Trip starts & ends here.</p>
    <input class="ip" id="tSr" placeholder="Search airports..." style="margin-bottom:6px">
    <div class="rw mb">
      <button class="bt bt-o bt-sm sf" data-l="tL">‚≠ê</button>
      <button class="bt bt-o bt-sm sa" data-l="tL">All</button>
      <button class="bt bt-o bt-sm sc" data-l="tL">Clear</button>
    </div>
    <div class="ap-b" id="tL"></div>
  </div>
  <div class="dg">
    <div><label>From</label><input type="date" id="tS"></div>
    <div><label>To</label><input type="date" id="tE"></div>
  </div>
  <div class="or">
    <label>Stops:</label>
    <select class="ip" id="tH" style="width:180px"><option value="0">Direct (A‚ÜíB‚ÜíA)</option><option value="1" selected>1 extra (A‚ÜíB‚ÜíC‚ÜíA)</option><option value="2">2 extra</option></select>
  </div>
  <div class="or">
    <label>Min days:</label>
    <select class="ip" id="tMn" style="width:80px"><option value="0">Any</option><option value="1">1</option><option value="2">2</option><option value="3" selected>3</option><option value="5">5</option><option value="7">7</option></select>
  </div>
</div>

<button class="sb" id="bSrch">üîç Search Flights</button>
<div class="rs" id="res"></div>

<div class="ft">Not affiliated with Wizz Air. <a href="https://github.com/vloss3/wizz-aycf-route-finder" target="_blank">GitHub</a> ¬∑ <a href="https://discord.gg/k3eRaSBez4" target="_blank">Discord</a></div>
</main>

<!-- SETTINGS MODAL -->
<div class="mo" id="mGH">
<div class="mo-s">
  <div class="mo-h"></div>
  <div class="mo-t">‚öôÔ∏è GitHub Settings</div>
  <p style="font-size:.78rem;color:var(--tx2);margin-bottom:10px">Save flight data to your GitHub repo. Need a <a href="https://github.com/settings/tokens/new?scopes=repo&description=AYCF" target="_blank" style="color:var(--acc)">Personal Access Token</a> with <strong>repo</strong> scope.</p>
  <div class="gh-g">
    <div><span class="lbl">Owner</span><input class="ip" id="gO" placeholder="palayax"></div>
    <div><span class="lbl">Repo</span><input class="ip" id="gR" placeholder="wizz-aycf-web"></div>
  </div>
  <div style="margin-bottom:8px"><span class="lbl">Token</span><input class="ip" id="gT" type="password" placeholder="ghp_xxxx"></div>
  <div class="rw mb">
    <button class="bt bt-g bt-sm" id="bGHT">Test</button>
    <button class="bt bt-p bt-sm" id="bGHS">Save</button>
  </div>
  <div id="gMsg"></div>
  <hr class="sep">
  <div class="cd-t">üìÅ Saved Files</div>
  <div id="gFL" style="font-size:.78rem;color:var(--tx2)">Configure above first.</div>
  <hr class="sep">
  <div class="cd-t">üîß Proxy URL</div>
  <div class="ip-row"><input class="ip" id="gPx" placeholder="https://aycf-proxy.xxx.workers.dev"><button class="bt bt-g bt-sm" id="bGPx">Save</button></div>
  <hr class="sep">
  <button class="bt bt-o bt-f" id="bCGH">Close</button>
</div>
</div>

<!-- LOG MODAL -->
<div class="mo" id="mLog">
<div class="mo-s">
  <div class="mo-h"></div>
  <div class="mo-t">üîß Debug Log <span id="lCnt" style="font-size:.72rem;color:var(--tx3)">(0)</span></div>
  <div class="rw mb">
    <button class="bt bt-o bt-sm" id="bLE">üì• Export</button>
    <button class="bt bt-p bt-sm" id="bLCopy">üìã Copy Log</button>
    <button class="bt bt-d bt-sm" id="bLC">Clear</button>
  </div>
  <div class="la" id="lA">Waiting for events...</div>
  <hr class="sep">
  <button class="bt bt-o bt-f" id="bCL">Close</button>
</div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  WIZZ AYCF WEB v3.1 ‚Äî Complete mobile web app
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const V='3.2.0',DB_N='WizzAYCF3',DB_V=1,CACHE_H=72,MIN_LAY=120;
const CC={
TLV:'Israel',ETH:'Israel',VDA:'Israel',
LTN:'UK',LGW:'UK',STN:'UK',LHR:'UK',BHX:'UK',BRS:'UK',MAN:'UK',EDI:'UK',GLA:'UK',LPL:'UK',NCL:'UK',EMA:'UK',ABZ:'UK',CWL:'UK',DSA:'UK',
FCO:'Italy',CIA:'Italy',MXP:'Italy',BGY:'Italy',VCE:'Italy',TSF:'Italy',NAP:'Italy',BRI:'Italy',CTA:'Italy',PMO:'Italy',BLQ:'Italy',TRN:'Italy',PSA:'Italy',VRN:'Italy',GOA:'Italy',TRS:'Italy',
BCN:'Spain',MAD:'Spain',AGP:'Spain',ALC:'Spain',PMI:'Spain',IBZ:'Spain',VLC:'Spain',SVQ:'Spain',BIO:'Spain',TFS:'Spain',LPA:'Spain',ACE:'Spain',FUE:'Spain',
BER:'Germany',CGN:'Germany',DTM:'Germany',DUS:'Germany',FRA:'Germany',HHN:'Germany',HAM:'Germany',HAJ:'Germany',MUC:'Germany',NUE:'Germany',STR:'Germany',FMM:'Germany',
WAW:'Poland',WMI:'Poland',KRK:'Poland',KTW:'Poland',GDN:'Poland',POZ:'Poland',WRO:'Poland',LUZ:'Poland',RZE:'Poland',SZZ:'Poland',BZG:'Poland',LCJ:'Poland',
OTP:'Romania',CLJ:'Romania',TSR:'Romania',IAS:'Romania',SBZ:'Romania',SUJ:'Romania',CRA:'Romania',BCM:'Romania',OMR:'Romania',
BUD:'Hungary',VIE:'Austria',
ATH:'Greece',SKG:'Greece',HER:'Greece',RHO:'Greece',CFU:'Greece',ZTH:'Greece',KGS:'Greece',CHQ:'Greece',
LCA:'Cyprus',PFO:'Cyprus',DXB:'UAE',AUH:'UAE',
SOF:'Bulgaria',VAR:'Bulgaria',BOJ:'Bulgaria',
CDG:'France',ORY:'France',BVA:'France',NCE:'France',MRS:'France',LYS:'France',TLS:'France',BOD:'France',NTE:'France',
LIS:'Portugal',OPO:'Portugal',FAO:'Portugal',AMS:'Netherlands',EIN:'Netherlands',
BRU:'Belgium',CRL:'Belgium',GVA:'Switzerland',ZRH:'Switzerland',BSL:'Switzerland',
ARN:'Sweden',GOT:'Sweden',CPH:'Denmark',OSL:'Norway',BGO:'Norway',TRD:'Norway',HEL:'Finland',TMP:'Finland',
BEG:'Serbia',PRN:'Kosovo',SKP:'N.Macedonia',TGD:'Montenegro',SJJ:'Bosnia',ZAG:'Croatia',SPU:'Croatia',DBV:'Croatia',
TIA:'Albania',PRG:'Czechia',BTS:'Slovakia',LJU:'Slovenia',RIX:'Latvia',VNO:'Lithuania',TLL:'Estonia',KIV:'Moldova',KBP:'Ukraine',IEV:'Ukraine'
};

// STATE
let db=null,airp=new Map(),favs=[],mode='dep',logs=[],
    downloading=false,paused=false,stopped=false;

const $=id=>document.getElementById(id),$$=s=>document.querySelectorAll(s);

// ‚ïê‚ïê LOGGING ‚ïê‚ïê
function L(m,c=''){const ts=new Date().toISOString().slice(11,23);const l=`[${ts}] ${m}`;logs.push({l,c});
  if(logs.length>5000)logs=logs.slice(-5000);console.log('[AYCF]',m);
  const a=$('lA');if(a){const d=document.createElement('div');d.className=c;d.textContent=l;a.appendChild(d);a.scrollTop=a.scrollHeight}
  $('lCnt').textContent=`(${logs.length})`}
function LE(m){L('‚ùå '+m,'e')}function LW(m){L('‚ö†Ô∏è '+m,'w')}function LS(m){L('‚úÖ '+m,'s')}function LA(m){L('üåê '+m,'a')}

// ‚ïê‚ïê UTILS ‚ïê‚ïê
function fD(d){return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`}
function fDMY(s){if(!s)return'';const[y,m,d]=s.split('-');return`${d}-${m}-${y}`}
function fDD(s){if(!s)return'';const[y,m,d]=s.split('-');const dt=new Date(+y,+m-1,+d);return`${dt.toLocaleDateString('en',{weekday:'short'})} ${d}-${m}-${y}`}
function fT(t){if(!t)return'';if(t.includes('T'))t=t.split('T')[1];if(t.includes(':')&&!t.includes('AM')&&!t.includes('PM')){const p=t.split(':');return String(+p[0]).padStart(2,'0')+':'+String(+(p[1]||0)).padStart(2,'0')}return t}
function pT(t){if(!t)return 0;if(t.includes('T'))t=t.split('T')[1];const p=t.split(':');return(+p[0])*60+(+(p[1]||0))}
function dRng(s,e){const r=[];const[sy,sm,sd]=s.split('-').map(Number);const[ey,em,ed]=e.split('-').map(Number);
  let c=new Date(sy,sm-1,sd);const end=new Date(ey,em-1,ed);while(c<=end){r.push(fD(c));c.setDate(c.getDate()+1)}return r}
function aD(c){const i=airp.get(c);if(!i)return c;return[c,i.n!==c?i.n:'',i.c].filter(Boolean).join(' ¬∑ ')}
function aS(c){const i=airp.get(c);return i&&i.n&&i.n!==c?`${c} (${i.n})`:c}
function bU(o,d,dt){return`https://multipass.wizzair.com/w6/subscriptions/spa/private-page/flight-search?origin=${o}&destination=${d}&departureDate=${dt}`}
function dB(d1,d2){const[y1,m1,dd1]=d1.split('-').map(Number);const[y2,m2,dd2]=d2.split('-').map(Number);return Math.floor((new Date(y2,m2-1,dd2)-new Date(y1,m1-1,dd1))/864e5)}
function sleep(ms){return new Promise(r=>setTimeout(r,ms))}
function getProxy(){return localStorage.getItem('wz_proxy')||''}

// ‚ïê‚ïê INDEXEDDB ‚ïê‚ïê
function initDB(){return new Promise((ok,no)=>{L('Opening IndexedDB...');const r=indexedDB.open(DB_N,DB_V);
  r.onerror=()=>{LE('DB error');no(r.error)};r.onsuccess=()=>{db=r.result;LS('DB ready');ok(db)};
  r.onupgradeneeded=e=>{const d=e.target.result;if(!d.objectStoreNames.contains('flights'))d.createObjectStore('flights',{keyPath:'id'});
    if(!d.objectStoreNames.contains('meta'))d.createObjectStore('meta',{keyPath:'key'})}})}
function dbP(s,d){return new Promise((ok,no)=>{const t=db.transaction(s,'readwrite');t.objectStore(s).put(d).onsuccess=ok;t.onerror=()=>no(t.error)})}
function dbA(s){return new Promise((ok,no)=>{const t=db.transaction(s,'readonly');const r=t.objectStore(s).getAll();r.onsuccess=()=>ok(r.result||[]);r.onerror=()=>no(r.error)})}
function dbC(s){return new Promise((ok,no)=>{const t=db.transaction(s,'readwrite');t.objectStore(s).clear().onsuccess=ok;t.onerror=()=>no(t.error)})}

// ‚ïê‚ïê FAVORITES ‚ïê‚ïê
function loadF(){try{favs=JSON.parse(localStorage.getItem('wz_fav3')||'[]')}catch{favs=[]}L(`Loaded ${favs.length} favorites`)}
function saveF(){localStorage.setItem('wz_fav3',JSON.stringify(favs))}
function addF(c){c=c.toUpperCase().trim();if(!c||c.length<2||c.length>3)return false;
  if(favs.some(f=>f.code===c))return false;
  favs.push({code:c,name:c,country:CC[c]||''});saveF();renderF();renderAL();LS(`Fav +${c}`);return true}
function rmF(c){favs=favs.filter(f=>f.code!==c);saveF();renderF();renderAL()}
function renderF(){const c=$('favC');if(!favs.length){c.innerHTML='<span class="fav-e">No favorites</span>';return}
  c.innerHTML=favs.map(f=>`<span class="fav"><span class="c">${f.code}</span><span class="n">${f.country||''}</span><button class="x" data-c="${f.code}">√ó</button></span>`).join('');
  c.querySelectorAll('.x').forEach(b=>b.onclick=e=>{e.stopPropagation();rmF(b.dataset.c)})}

// ‚ïê‚ïê AIRPORT INFO ‚ïê‚ïê
function buildAI(data){airp=new Map();data.forEach(d=>{[d.origin,d.dest].forEach(c=>{if(!airp.has(c))airp.set(c,{code:c,n:c,c:CC[c]||''})})});L(`${airp.size} airports`)}

// ‚ïê‚ïê AIRPORT LIST ‚ïê‚ïê
function renderL(cid,sid){const c=$(cid);if(!c)return;
  if(!airp.size){c.innerHTML='<div style="padding:14px;text-align:center;color:var(--tx3);font-size:.78rem">No airports. Import or download data.</div>';return}
  const bc={};airp.forEach((i,k)=>{const co=i.c||'Other';if(!bc[co])bc[co]=[];bc[co].push(i)});
  const fc=new Set(favs.map(f=>f.country));
  const sk=Object.keys(bc).sort((a,b)=>{if(fc.has(a)&&!fc.has(b))return-1;if(!fc.has(a)&&fc.has(b))return 1;return a.localeCompare(b)});
  let h='';sk.forEach(co=>{const ap=bc[co].sort((a,b)=>a.code.localeCompare(b.code));
    const hf=ap.some(a=>favs.some(f=>f.code===a.code));
    h+=`<div class="ap-g" data-co="${co}"><div class="ap-gh" data-co="${co}"><span>${hf?'‚≠ê ':''}${co} (${ap.length})</span><span class="ar">‚ñ∂</span></div><div class="ap-gb">`;
    ap.forEach(a=>{const fv=favs.some(f=>f.code===a.code);
      h+=`<div class="ap-c${fv?' fv':''}" data-code="${a.code}" data-co="${co}" data-name="${a.n}"><span class="ac">${a.code}</span>${a.n!==a.code?`<span class="an">${a.n}</span>`:''}</div>`});
    h+='</div></div>'});
  c.innerHTML=h;
  c.querySelectorAll('.ap-gh').forEach(h=>h.addEventListener('click',()=>{h.classList.toggle('op');h.nextElementSibling.classList.toggle('op')}));
  c.querySelectorAll('.ap-c').forEach(ch=>ch.addEventListener('click',()=>ch.classList.toggle('sl')));
  if(sid){const inp=$(sid);if(inp)inp.oninput=()=>{const q=inp.value.toLowerCase();
    c.querySelectorAll('.ap-c').forEach(ch=>{const m=ch.dataset.code.toLowerCase().includes(q)||ch.dataset.co.toLowerCase().includes(q)||(ch.dataset.name||'').toLowerCase().includes(q);ch.style.display=m?'':'none'});
    c.querySelectorAll('.ap-g').forEach(g=>{const vis=[...g.querySelectorAll('.ap-c')].some(ch=>ch.style.display!=='none');g.style.display=vis?'':'none';
      if(q&&vis){g.querySelector('.ap-gh').classList.add('op');g.querySelector('.ap-gb').classList.add('op')}})}}
}
function renderAL(){renderL('dL','dSr');renderL('sL','sSr');renderL('tL','tSr')}
function gSel(cid){const c=$(cid);return c?[...c.querySelectorAll('.ap-c.sl')].map(ch=>ch.dataset.code):[]}
function sSel(cid,codes){const c=$(cid);if(!c)return;const s=new Set(codes);c.querySelectorAll('.ap-c').forEach(ch=>ch.classList.toggle('sl',s.has(ch.dataset.code)))}

// ‚ïê‚ïê STATUS ‚ïê‚ïê
async function upSt(){const all=await dbA('flights');const val=all.filter(d=>Date.now()-d.timestamp<CACHE_H*36e5);
  L(`DB: ${all.length} total, ${val.length} valid`);
  if(!val.length){$('stC').className='st st-e';$('stI').textContent='üì≠';$('stH').textContent='No Flight Data';
    $('stD').textContent='Login to Wizz Air or import data.';$('stS').classList.add('hd-n')}
  else{const tf=val.reduce((s,d)=>s+(d.flights?.length||0),0);
    const ori=new Set(val.map(d=>d.origin)),dts=new Set(val.map(d=>d.date));
    $('stC').className='st st-o';$('stI').textContent='‚úÖ';$('stH').textContent='Flight Data Ready';
    $('stD').textContent=`Dates: ${[...dts].sort().map(fDMY).join(', ')}`;
    $('stS').classList.remove('hd-n');$('s1').textContent=tf.toLocaleString();$('s2').textContent=ori.size;
    $('s3').textContent=val.length.toLocaleString();$('s4').textContent=dts.size;
    buildAI(val);renderAL();LS(`Data: ${tf} flights, ${ori.size} origins`)}
}

// ‚ïê‚ïê PROXY / API ‚ïê‚ïê
let cookieJar=''; // Track all cookies
let xsrfToken=''; // Track XSRF token separately

function getProxy(){return localStorage.getItem('wz_proxy')||''}

// Enhanced proxy function with redirect following
async function px(url,opts={}){
  const proxy=getProxy();if(!proxy)throw new Error('Proxy not configured');
  const maxRedirects=opts.maxRedirects||5;
  let currentUrl=url;
  let attempt=0;

  while(attempt<maxRedirects){
    attempt++;
    const headers={'X-Target':currentUrl};
    if(cookieJar)headers['X-Cookies']=cookieJar;
    if(opts.contentType)headers['Content-Type']=opts.contentType;
    // Forward XSRF token if we have one
    if(xsrfToken)headers['X-XSRF-TOKEN']=xsrfToken;
    // Forward any extra headers
    if(opts.extraHeaders){Object.entries(opts.extraHeaders).forEach(([k,v])=>{headers[k]=v})}

    const fOpts={method:(attempt===1?opts.method:null)||'GET',headers};
    // Only send body on first request (not on redirects)
    if(attempt===1&&opts.body)fOpts.body=typeof opts.body==='string'?opts.body:JSON.stringify(opts.body);
    
    const meth=fOpts.method||'GET';
    LA(`[${attempt}] ${meth} ${currentUrl}`);
    L(`  Headers sent: ${Object.keys(headers).filter(h=>h!=='X-Cookies').join(', ')}`);
    if(cookieJar)L(`  Cookies: ${cookieJar.substring(0,80)}${cookieJar.length>80?'...':''}`);
    
    const resp=await fetch(proxy,fOpts);
    
    // Capture ALL cookies from response
    const sc=resp.headers.get('X-Set-Cookies');
    if(sc){
      try{
        const arr=JSON.parse(sc);
        arr.forEach(c=>{
          const parts=c.split(';')[0];
          const [name]=parts.split('=');
          // Update or add cookie
          const existing=cookieJar.split('; ').filter(x=>x&&!x.startsWith(name.trim()+'='));
          existing.push(parts);
          cookieJar=existing.join('; ');
          // Extract XSRF token
          if(name.trim()==='XSRF-TOKEN'){
            xsrfToken=decodeURIComponent(parts.split('=').slice(1).join('='));
            L(`  üîë XSRF token captured: ${xsrfToken.substring(0,20)}...`);
          }
        });
        L(`  üç™ Cookies updated (${arr.length} new): ${arr.map(c=>c.split('=')[0]).join(', ')}`);
      }catch(e){LW(`Cookie parse error: ${e.message}`)}
    }
    
    // Check for redirect
    const loc=resp.headers.get('X-Location');
    const xStatus=resp.headers.get('X-Status');
    if(loc){
      L(`  ‚Ü™ Redirect ${xStatus||'3xx'} ‚Üí ${loc}`);
      // Resolve relative URLs
      if(loc.startsWith('/')){
        const base=new URL(currentUrl);
        currentUrl=base.origin+loc;
      }else if(loc.startsWith('http')){
        currentUrl=loc;
      }else{
        currentUrl=new URL(loc,currentUrl).href;
      }
      continue; // Follow redirect
    }
    
    // Not a redirect ‚Äî return response with metadata
    const status=parseInt(xStatus)||resp.status;
    const ct=resp.headers.get('Content-Type')||'';
    
    // Clone body so we can peek and still return it
    const bodyText=await resp.text();
    L(`  ‚úì Response: HTTP ${status} | ${ct.split(';')[0]} | ${bodyText.length} bytes`);
    L(`  Body preview: ${bodyText.substring(0,150).replace(/\n/g,' ')}${bodyText.length>150?'...':''}`);
    
    return{
      status,
      headers:resp.headers,
      url:currentUrl,
      redirected:attempt>1,
      text:()=>Promise.resolve(bodyText),
      json:()=>Promise.resolve(JSON.parse(bodyText)),
      bodyText // Direct access for logging
    };
  }
  throw new Error(`Too many redirects (${maxRedirects}) following ${url}`);
}

// ‚ïê‚ïê CLOUDFLARE WORKER CODE ‚ïê‚ïê
function workerCode(){return`export default{
async fetch(r,env,ctx){
const cors={'Access-Control-Allow-Origin':'*',
'Access-Control-Allow-Methods':'GET,POST,PUT,DELETE,OPTIONS',
'Access-Control-Allow-Headers':'Content-Type,X-Target,X-Cookies,X-XSRF-TOKEN',
'Access-Control-Expose-Headers':'X-Set-Cookies,X-Location,Content-Type,X-Status',
'Access-Control-Max-Age':'86400'};
if(r.method==='OPTIONS')return new Response(null,{headers:cors});
const t=r.headers.get('X-Target');
if(!t)return new Response(JSON.stringify({error:'Need X-Target header',ok:false}),{status:400,headers:{...cors,'Content-Type':'application/json'}});
let url;
try{url=new URL(t)}catch{return new Response(JSON.stringify({error:'Invalid URL'}),{status:400,headers:{...cors,'Content-Type':'application/json'}})}
if(!url.hostname.endsWith('wizzair.com'))return new Response(JSON.stringify({error:'Only wizzair.com allowed'}),{status:403,headers:{...cors,'Content-Type':'application/json'}});
const h=new Headers();
h.set('User-Agent','Mozilla/5.0 (Linux; Android 14; Pixel 8) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Mobile Safari/537.36');
h.set('Accept',r.headers.get('Accept')||'text/html,application/xhtml+xml,application/json,*/*;q=0.8');
h.set('Accept-Language','en-US,en;q=0.9');
if(r.headers.get('Content-Type'))h.set('Content-Type',r.headers.get('Content-Type'));
const ck=r.headers.get('X-Cookies');if(ck)h.set('Cookie',ck);
const xsrf=r.headers.get('X-XSRF-TOKEN');if(xsrf)h.set('X-XSRF-TOKEN',xsrf);
h.set('Referer','https://multipass.wizzair.com/');
h.set('Origin','https://multipass.wizzair.com');
try{
const resp=await fetch(t,{method:r.method,headers:h,
body:['GET','HEAD'].includes(r.method)?undefined:await r.arrayBuffer(),redirect:'manual'});
const rh=new Headers(cors);
rh.set('X-Status',String(resp.status));
const sc=resp.headers.getSetCookie?resp.headers.getSetCookie():[];
if(sc.length)rh.set('X-Set-Cookies',JSON.stringify(sc));
if(resp.status>=300&&resp.status<400){
rh.set('X-Location',resp.headers.get('Location')||'');
rh.set('Content-Type','application/json');
return new Response(JSON.stringify({redirect:resp.headers.get('Location'),status:resp.status,cookies:sc.length}),{status:200,headers:rh})}
const ct=resp.headers.get('Content-Type');if(ct)rh.set('Content-Type',ct);
return new Response(resp.body,{status:resp.status,headers:rh});
}catch(e){return new Response(JSON.stringify({error:e.message}),{status:502,headers:{...cors,'Content-Type':'application/json'}})}
}
};`}

// ‚ïê‚ïê AUTH & DOWNLOAD ‚ïê‚ïê
async function loginAndDownload(){
  if(downloading)return;
  const email=$('wizEmail').value.trim();const pass=$('wizPass').value;
  if(!email||!pass){showDM('e','Enter email and password.');return}
  if(!getProxy()){showDM('e','Set up proxy first (see above).');return}

  downloading=true;paused=false;stopped=false;
  // Reset cookie state for fresh login
  cookieJar='';xsrfToken='';
  $('bLogin').disabled=true;$('bPause').classList.remove('hd-n');$('bStop').classList.remove('hd-n');
  $('dlProg').classList.remove('hd-n');showDL('Connecting to Wizz Air...');setDLProg(0);

  try{
    // ‚îÄ‚îÄ‚îÄ Step 1: Hit login page to get session + CSRF cookies ‚îÄ‚îÄ‚îÄ
    L('‚ïê‚ïê‚ïê Step 1: Fetching login page for CSRF token ‚ïê‚ïê‚ïê');
    showDL('Getting session...');
    
    const loginR=await px('https://multipass.wizzair.com/w6/subscriptions/auth/login');
    const loginHtml=await loginR.text();
    L(`Login page: ${loginR.status}, ${loginHtml.length} bytes, redirected: ${loginR.redirected}`);
    L(`Final URL: ${loginR.url}`);
    
    // Extract CSRF from meta tag if not already in cookies
    if(!xsrfToken){
      const csrfMeta=loginHtml.match(/<meta\s+name="csrf-token"\s+content="([^"]+)"/);
      if(csrfMeta){xsrfToken=csrfMeta[1];L(`üîë CSRF from meta tag: ${xsrfToken.substring(0,20)}...`)}
      // Also try content="..." name="csrf-token" order
      if(!xsrfToken){const m2=loginHtml.match(/content="([^"]+)"[^>]*name="csrf-token"/);
        if(m2){xsrfToken=m2[1];L(`üîë CSRF from meta (alt): ${xsrfToken.substring(0,20)}...`)}}
    }
    
    // Find JS bundle URLs (for endpoint discovery)
    const jsUrls=[];
    const jsRe=/(?:src|href)="([^"]*\.js[^"]*)"/g;
    let jm;while((jm=jsRe.exec(loginHtml))!==null){
      let u=jm[1];
      if(u.startsWith('/'))u='https://multipass.wizzair.com'+u;
      if(u.includes('wizzair'))jsUrls.push(u);
    }
    L(`Found ${jsUrls.length} JS bundles: ${jsUrls.map(u=>u.split('/').pop()).join(', ')}`);
    
    // ‚îÄ‚îÄ‚îÄ Step 2: Discover login endpoint from JS bundles ‚îÄ‚îÄ‚îÄ
    L('‚ïê‚ïê‚ïê Step 2: Discovering login API endpoint ‚ïê‚ïê‚ïê');
    showDL('Discovering API...');
    
    let discoveredLoginEndpoint=null;
    let discoveredApiBase=null;
    
    // Try fetching JS to find login endpoint
    for(const jsUrl of jsUrls.slice(0,3)){
      try{
        L(`Fetching JS: ${jsUrl.split('/').pop()}`);
        const jsR=await px(jsUrl);
        const jsCode=await jsR.text();
        L(`JS bundle: ${jsCode.length} bytes`);
        
        // Search for login-related API patterns
        const patterns=[
          /["']([^"']*auth\/login[^"']*)["']/g,
          /["']([^"']*\/login[^"']*)["']/g,
          /["']([^"']*\/api\/[^"']*auth[^"']*)["']/g,
          /login[^{]*url\s*[:=]\s*["']([^"']+)["']/gi,
          /["'](\/w6\/subscriptions\/[^"']*login[^"']*)["']/g,
          /["'](\/w6\/subscriptions\/[^"']*auth[^"']*)["']/g,
        ];
        
        const found=new Set();
        patterns.forEach(p=>{let m;while((m=p.exec(jsCode))!==null){
          const ep=m[1];
          if(ep.length<100&&ep.includes('/')&&!ep.includes('.css')&&!ep.includes('.js')&&!ep.includes('.png')){
            found.add(ep)}}});
        
        if(found.size>0){
          L(`Found potential endpoints in ${jsUrl.split('/').pop()}: ${[...found].join(', ')}`);
          // Prefer json/auth patterns
          for(const ep of found){
            if(ep.includes('json')&&ep.includes('login')){discoveredLoginEndpoint=ep;break}
            if(ep.includes('auth')&&ep.includes('login')&&!discoveredLoginEndpoint)discoveredLoginEndpoint=ep;
          }
        }
        
        // Also look for flight search URL pattern
        const searchPat=/["'](\/w6\/subscriptions\/[^"']*(?:availability|search|flight)[^"']*)["']/g;
        let sm;while((sm=searchPat.exec(jsCode))!==null){
          L(`Potential flight API: ${sm[1]}`);}
          
        // Look for base API URL
        const basePat=/["'](https?:\/\/multipass\.wizzair\.com\/w6\/subscriptions\/[^"']*)["']/g;
        let bm;while((bm=basePat.exec(jsCode))!==null){
          if(!discoveredApiBase&&bm[1].includes('json'))discoveredApiBase=bm[1];
        }
        
      }catch(e){LW(`JS fetch error: ${e.message}`)}
    }
    
    if(discoveredLoginEndpoint)L(`‚úÖ Discovered login endpoint: ${discoveredLoginEndpoint}`);
    if(discoveredApiBase)L(`‚úÖ Discovered API base: ${discoveredApiBase}`);
    
    // ‚îÄ‚îÄ‚îÄ Step 3: Try to authenticate ‚îÄ‚îÄ‚îÄ
    L('‚ïê‚ïê‚ïê Step 3: Authenticating ‚ïê‚ïê‚ïê');
    showDL('Logging in...');
    
    // Build list of endpoints to try (discovered first, then known patterns)
    const loginEndpoints=[];
    if(discoveredLoginEndpoint){
      const ep=discoveredLoginEndpoint.startsWith('http')?discoveredLoginEndpoint:
        'https://multipass.wizzair.com'+discoveredLoginEndpoint;
      loginEndpoints.push(ep);
    }
    loginEndpoints.push(
      'https://multipass.wizzair.com/w6/subscriptions/auth/login',
      'https://multipass.wizzair.com/w6/subscriptions/json/auth/login',
      'https://multipass.wizzair.com/w6/subscriptions/api/auth/login',
      'https://multipass.wizzair.com/w6/subscriptions/json/login',
      'https://multipass.wizzair.com/w6/subscriptions/api/login',
    );
    // De-duplicate
    const uniqueEndpoints=[...new Set(loginEndpoints)];
    
    let loggedIn=false;
    
    // Try each endpoint with multiple body formats
    for(const ep of uniqueEndpoints){
      if(loggedIn)break;
      
      // Format 1: JSON with _token
      const bodies=[
        {email,password:pass,_token:xsrfToken},
        {email,password:pass},
        {username:email,password:pass,_token:xsrfToken},
      ];
      
      for(const body of bodies){
        if(loggedIn)break;
        try{
          L(`Trying: POST ${ep}`);
          L(`  Body: ${JSON.stringify(body).substring(0,100)}`);
          const r=await px(ep,{method:'POST',contentType:'application/json',
            body:JSON.stringify(body),maxRedirects:3});
          const txt=await r.text();
          L(`  Response: ${r.status} | ${txt.length} bytes`);
          L(`  Body: ${txt.substring(0,300)}`);
          
          // Success indicators
          if(r.status>=200&&r.status<300&&!txt.includes('"error"')&&!txt.includes('<!DOCTYPE')){
            loggedIn=true;LS(`‚úÖ Login succeeded at ${ep}`);break}
          // Redirect to authenticated page = success
          if(r.redirected&&r.url&&!r.url.includes('/login')&&!r.url.includes('/auth')){
            loggedIn=true;LS(`‚úÖ Login succeeded (redirected to ${r.url})`);break}
        }catch(e){LW(`  ${ep}: ${e.message}`)}
      }
      
      // Format 2: Form-urlencoded
      if(!loggedIn){
        try{
          L(`Trying form-encoded: POST ${ep}`);
          const formBody=`email=${encodeURIComponent(email)}&password=${encodeURIComponent(pass)}&_token=${encodeURIComponent(xsrfToken||'')}`;
          const r=await px(ep,{method:'POST',contentType:'application/x-www-form-urlencoded',
            body:formBody,maxRedirects:3});
          const txt=await r.text();
          L(`  Response: ${r.status} | ${txt.length} bytes`);
          L(`  Body: ${txt.substring(0,300)}`);
          
          if(r.status>=200&&r.status<300&&!txt.includes('/login')){
            loggedIn=true;LS(`‚úÖ Login (form) succeeded at ${ep}`)}
          if(r.redirected&&r.url&&!r.url.includes('/login')&&!r.url.includes('/auth')){
            loggedIn=true;LS(`‚úÖ Login (form) succeeded (redirect to ${r.url})`)}
        }catch(e){LW(`  Form ${ep}: ${e.message}`)}
      }
    }

    // Also try the main Wizz Air API login (different domain, may help with some cookie sharing)
    if(!loggedIn){
      L('Trying main wizzair.com API...');
      try{
        const metaR=await px('https://www.wizzair.com/static/metadata.json');
        const meta=await metaR.json();
        const apiUrl=meta.apiUrl||`https://be.wizzair.com/${meta.appVersion||'19.3.0'}/Api`;
        L(`API URL: ${apiUrl}`);

        const loginR=await px(`${apiUrl}/customer/login`,{method:'POST',contentType:'application/json',
          body:JSON.stringify({email,password:pass,isGoogleLogin:false})});
        const loginTxt=await loginR.text();
        L(`Main API: ${loginR.status} | ${loginTxt.substring(0,300)}`);
        if(loginR.status>=200&&loginR.status<300&&loginR.status!==429){loggedIn=true;LS('Main API login OK')}
        else if(loginR.status===429){LW('Main API rate limited (429). Wait a minute and retry.')}
      }catch(e){LW(`Main API: ${e.message}`)}
    }

    // ‚îÄ‚îÄ‚îÄ Step 4: Fetch authenticated page ‚îÄ‚îÄ‚îÄ
    L('‚ïê‚ïê‚ïê Step 4: Fetching authenticated page ‚ïê‚ïê‚ïê');
    showDL('Fetching route data...');
    L(`Cookie jar before auth page: ${cookieJar.substring(0,120)}...`);
    
    const authR=await px('https://multipass.wizzair.com/w6/subscriptions/spa/private-page/wallets');
    let pageHtml=await authR.text();
    L(`Auth page: ${authR.status} | ${pageHtml.length} bytes | redirected: ${authR.redirected} | final URL: ${authR.url}`);

    // If redirected to login, auth failed
    if(authR.url&&authR.url.includes('/auth/login')){
      L(`‚ö†Ô∏è Still redirected to login page ‚Äî authentication failed`);
      L(`Page HTML snippet: ${pageHtml.substring(0,500)}`);
      
      // Try one more thing: maybe we need to hit the wallets page without following redirects
      // and the page actually has data embedded even before redirect
    }

    // Log full page for debugging (first 2000 chars)
    L(`Page content (first 2000 chars): ${pageHtml.substring(0,2000).replace(/\n/g,'\\n')}`);

    // ‚îÄ‚îÄ‚îÄ Step 5: Parse routes ‚îÄ‚îÄ‚îÄ
    L('‚ïê‚ïê‚ïê Step 5: Parsing routes ‚ïê‚ïê‚ïê');
    showDL('Parsing route data...');
    let routes=null;

    // Pattern 1: "routes":[...] from head
    const rp=/"routes":\[(.*?)\].*?"isOneWayFlightsOnly"/gms;
    let hm=pageHtml.match(rp);
    if(hm&&hm[0]){
      try{const j=`{"routes":${hm[0].split('"routes":')[1].split(',"isOneWayFlightsOnly"')[0]}}`;
        routes=JSON.parse(j).routes;LS(`Routes from pattern 1: ${routes.length} origins`)}
      catch(e){LE(`Parse routes p1: ${e.message}`)}
    }
    // Pattern 2: window.CVO.routes
    if(!routes){const bp=/window\.CVO\.routes\s*=\s*(\[.*?\]);/s;const bm=pageHtml.match(bp);
      if(bm&&bm[1]){try{routes=JSON.parse(bm[1]);LS(`Routes from pattern 2: ${routes.length}`)}catch(e){LE(`Parse p2: ${e.message}`)}}}
    // Pattern 3: Look for route data in any JSON blob
    if(!routes){
      const jsonBlobs=pageHtml.match(/\{[^{}]*"departureStation"\s*:\s*\{[^}]*"id"\s*:\s*"[A-Z]{3}"[^}]*\}[^{}]*"arrivalStations"\s*:\s*\[[^\]]*\][^{}]*\}/g);
      if(jsonBlobs){L(`Found ${jsonBlobs.length} route JSON blobs via pattern 3`);
        try{routes=jsonBlobs.map(b=>JSON.parse(b));LS(`Routes from pattern 3: ${routes.length}`)}
        catch(e){LE(`Parse p3: ${e.message}`)}
      }
    }
    // Pattern 4: Search in all script tags
    if(!routes){
      const scripts=pageHtml.match(/<script[^>]*>([\s\S]*?)<\/script>/g);
      if(scripts){
        L(`Scanning ${scripts.length} script tags for route data...`);
        for(const s of scripts){
          const inner=s.replace(/<\/?script[^>]*>/g,'');
          if(inner.includes('departureStation')||inner.includes('routes')){
            L(`Found potential route script (${inner.length} bytes): ${inner.substring(0,200)}`);
          }
        }
      }
    }

    if(!routes||!routes.length){
      LE('‚ùå Could not find routes in page');
      L('‚ïê‚ïê‚ïê DIAGNOSTIC SUMMARY ‚ïê‚ïê‚ïê');
      L(`Logged in: ${loggedIn}`);
      L(`Cookie jar: ${cookieJar}`);
      L(`XSRF token: ${xsrfToken?'present':'missing'}`);
      L(`Final page URL: ${authR.url}`);
      L(`Page size: ${pageHtml.length} bytes`);
      L(`Contains "routes": ${pageHtml.includes('"routes"')}`);
      L(`Contains "departureStation": ${pageHtml.includes('departureStation')}`);
      L(`Contains "arrivalStations": ${pageHtml.includes('arrivalStations')}`);
      L(`Contains "login": ${pageHtml.includes('/login')}`);
      L(`Contains "wallets": ${pageHtml.includes('wallets')}`);
      L('Full page HTML logged above. Export debug log and share for troubleshooting.');
      L('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
      showDM('e',`Login or route extraction failed. Please export the debug log (üîß button) and share it for troubleshooting.`);
      throw new Error('No routes found')}

    LS(`Found ${routes.length} route origins`);

    // ‚îÄ‚îÄ‚îÄ Step 6: Get flight search API URL ‚îÄ‚îÄ‚îÄ
    L('‚ïê‚ïê‚ïê Step 6: Finding flight search API URL ‚ïê‚ïê‚ïê');
    let apiUrl=null;
    // Pattern A: Direct URL
    const hp=/"searchFlight":"(https:\/\/multipass\.wizzair\.com[^"]+)"/;
    const hm2=pageHtml.match(hp);
    if(hm2&&hm2[1]){apiUrl=hm2[1];L(`API URL (pattern A): ${apiUrl}`)}
    // Pattern B: UUID extraction
    if(!apiUrl){const hp2=/"searchFlight":"https:\/\/multipass\.wizzair\.com[^"]+\/([^"]+)"/;
      const hm3=pageHtml.match(hp2);
      if(hm3&&hm3[1]){apiUrl=`https://multipass.wizzair.com/w6/subscriptions/json/availability/${hm3[1]}`;L(`API URL (pattern B/UUID): ${apiUrl}`)}}
    // Pattern C: CVO variable
    if(!apiUrl){const bp2=/window\.CVO\.flightSearchUrlJson\s*=\s*"(https:\/\/multipass\.wizzair\.com[^"]+)"/;
      const bm2=pageHtml.match(bp2);if(bm2&&bm2[1]){apiUrl=bm2[1];L(`API URL (pattern C/CVO): ${apiUrl}`)}}
    // Pattern D: Search in script tags
    if(!apiUrl){const scripts=pageHtml.match(/<script[^>]*>([\s\S]*?)<\/script>/g)||[];
      for(const s of scripts){const m=s.match(/availability\/([a-f0-9-]{36})/i);
        if(m){apiUrl=`https://multipass.wizzair.com/w6/subscriptions/json/availability/${m[1]}`;L(`API URL (pattern D/script UUID): ${apiUrl}`);break}}}

    if(!apiUrl){LE('Flight search API URL not found');
      showDM('e','Routes found but API URL missing. Export log for troubleshooting.');throw new Error('No API URL')}
    LS(`Flight API: ${apiUrl}`);

    // ‚îÄ‚îÄ‚îÄ Step 7: Build tasks & download ‚îÄ‚îÄ‚îÄ
    L('‚ïê‚ïê‚ïê Step 7: Downloading flights ‚ïê‚ïê‚ïê');
    const dates=[];const today=new Date();
    for(let i=0;i<4;i++){const d=new Date(today);d.setDate(today.getDate()+i);dates.push(fD(d))}
    L(`Dates: ${dates.join(', ')}`);

    const tasks=[];const seen=new Set();
    routes.forEach(r=>{const orig=r.departureStation?.id;if(!orig)return;
      (r.arrivalStations||[]).forEach(d=>{dates.forEach(dt=>{const k=`${orig}|${d.id}|${dt}`;
        if(!seen.has(k)){seen.add(k);tasks.push({o:orig,d:d.id,dt})}})})});
    L(`${tasks.length} tasks to download`);
    showDL(`Downloading ${tasks.length} routes...`);

    let done=0,flights=0,errors=0,rl=0;
    for(let i=0;i<tasks.length;i++){
      if(stopped){L('Stopped by user');break}
      while(paused&&!stopped)await sleep(500);
      if(stopped)break;

      const t=tasks[i];
      setDLProg((i/tasks.length)*100);
      showDL(`${t.o}‚Üí${t.d} ${fDMY(t.dt)} [${i+1}/${tasks.length}]`);

      try{
        await sleep(350+Math.random()*350);
        const r=await px(apiUrl,{method:'POST',contentType:'application/json',
          body:JSON.stringify({flightType:'OW',origin:t.o,destination:t.d,departure:t.dt,arrival:'',intervalSubtype:null})});

        if(r.status===429){rl++;if(rl>=3){showDL('Rate limited ‚Äî waiting 60s...');await sleep(60000);rl=0}
          else{showDL('Rate limited ‚Äî waiting 15s...');await sleep(15000)}i--;continue}

        rl=0;
        if(r.status>=200&&r.status<300){
          const data=await r.json();
          let fl=data.flightsOutbound||data.flights||data.outbound||data.outboundFlights||[];
          if(Array.isArray(data))fl=data;
          fl=fl.map(f=>({departure:f.departure||f.departureTime||f.std||'',arrival:f.arrival||f.arrivalTime||f.sta||'',
            duration:f.duration||f.flightDuration||'',flightCode:f.flightCode||f.flightNumber||''}));
          await dbP('flights',{id:`${t.o}-${t.d}-${t.dt}`,origin:t.o,dest:t.d,date:t.dt,flights:fl,timestamp:Date.now()});
          done++;flights+=fl.length;
          if(i<3||fl.length>0)L(`  ${t.o}‚Üí${t.d}: ${fl.length} flights`);
        }else{
          await dbP('flights',{id:`${t.o}-${t.d}-${t.dt}`,origin:t.o,dest:t.d,date:t.dt,flights:[],timestamp:Date.now()});
          done++;errors++}

        if(done%30===0&&i<tasks.length-1){showDL('Rate-limit break (12s)...');await sleep(12000)}
      }catch(e){LE(`${t.o}-${t.d}: ${e.message}`);done++;errors++}
    }

    setDLProg(100);
    LS(`Download complete: ${flights} flights, ${done} routes, ${errors} errors`);
    showDL(`Done! ${flights} flights across ${done} routes.`);
    showDM('s',`Downloaded ${flights} flights from ${done} routes.`);
    await upSt();

  }catch(e){LE(`Download failed: ${e.message}`);if(!$('loginMsg').innerHTML.includes('log'))showDM('e',e.message)}
  finally{downloading=false;$('bLogin').disabled=false;$('bPause').classList.add('hd-n');$('bStop').classList.add('hd-n')}
}

function setDLProg(p){$('dlFill').style.width=Math.min(100,p)+'%'}
function showDL(m){$('dlStatus').textContent=m}
function showDM(t,m){const c={s:'mg-s',e:'mg-e',w:'mg-w',i:'mg-i'};$('loginMsg').innerHTML=`<div class="mg ${c[t]||'mg-i'}">${m}</div>`;
  if(t!=='e')setTimeout(()=>{const el=$('loginMsg');if(el.innerHTML.includes(m))el.innerHTML=''},10000)}
function showMsg(t,m){const c={s:'mg-s',e:'mg-e',w:'mg-w',i:'mg-i'};$('dMsg').innerHTML=`<div class="mg ${c[t]||'mg-i'}">${m}</div>`;
  setTimeout(()=>{const el=$('dMsg');if(el.innerHTML.includes(m))el.innerHTML=''},8000)}

// ‚ïê‚ïê IMPORT / EXPORT ‚ïê‚ïê
async function importJ(file){L(`Import: ${file.name}`);showMsg('i','Importing...');
  try{const t=await file.text();const d=JSON.parse(t);
    if(!d.data||!Array.isArray(d.data))throw new Error('Invalid format');
    let n=0;for(const f of d.data){if(f.id&&f.flights){await dbP('flights',{...f,timestamp:Date.now()});n++}}
    if(d.favorites)d.favorites.forEach(f=>{if(!favs.some(e=>e.code===f.code)){favs.push(f)}});saveF();renderF();
    await upSt();showMsg('s',`Imported ${n} routes!`);LS(`Imported ${n} routes`)}
  catch(e){LE(`Import: ${e.message}`);showMsg('e','Import failed: '+e.message)}}

async function exportJ(){const all=await dbA('flights');const val=all.filter(d=>Date.now()-d.timestamp<CACHE_H*36e5);
  if(!val.length){showMsg('e','No data');return}
  const exp={version:V,exportDate:new Date().toISOString(),favorites:favs,
    flightCount:val.reduce((s,f)=>s+f.flights.length,0),routeCount:val.length,data:val};
  const blob=new Blob([JSON.stringify(exp)],{type:'application/json'});const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download=`wizz-${fD(new Date())}.json`;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);
  LS('Exported');showMsg('s','Exported!')}

// ‚ïê‚ïê GITHUB ‚ïê‚ïê
function loadGH(){try{const s=JSON.parse(localStorage.getItem('wz_gh3')||'{}');if(s.o)$('gO').value=s.o;if(s.r)$('gR').value=s.r;if(s.t)$('gT').value=s.t}catch{}}
function saveGH(){localStorage.setItem('wz_gh3',JSON.stringify({o:$('gO').value.trim(),r:$('gR').value.trim(),t:$('gT').value.trim()}))}
function gGH(){try{return JSON.parse(localStorage.getItem('wz_gh3')||'{}')}catch{return{}}}

async function ghApi(path,method='GET',body=null){const s=gGH();if(!s.o||!s.r||!s.t)throw new Error('GitHub not configured');
  const url=`https://api.github.com/repos/${s.o}/${s.r}/contents/${path}`;
  const opts={method,headers:{'Authorization':`Bearer ${s.t}`,'Accept':'application/vnd.github.v3+json'}};
  if(body)opts.body=JSON.stringify(body);const resp=await fetch(url,opts);
  if(!resp.ok)throw new Error(`GitHub ${resp.status}`);return resp.json()}

async function testGH(){$('gMsg').innerHTML='<div class="mg mg-i"><span class="sp-n"></span> Testing...</div>';
  try{const s=gGH();const r=await fetch(`https://api.github.com/repos/${s.o}/${s.r}`,{headers:{'Authorization':`Bearer ${s.t}`}});
    if(!r.ok)throw new Error(`HTTP ${r.status}`);const d=await r.json();
    $('gMsg').innerHTML=`<div class="mg mg-s">‚úÖ Connected: ${d.full_name}</div>`;LS(`GH ok: ${d.full_name}`);listGHF()}
  catch(e){LE(`GH test: ${e.message}`);$('gMsg').innerHTML=`<div class="mg mg-e">‚ùå ${e.message}</div>`}}

async function listGHF(){const fl=$('gFL');try{let f;try{f=await ghApi('data')}catch{f=[]}
  const js=(Array.isArray(f)?f:[]).filter(x=>x.name.endsWith('.json')).sort((a,b)=>b.name.localeCompare(a.name));
  if(!js.length){fl.innerHTML='<em>No saved files yet.</em>';return}
  fl.innerHTML=js.map(x=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--bdr)">
    <span style="font-family:'JetBrains Mono',monospace;font-size:.7rem">${x.name}</span>
    <button class="bt bt-o bt-sm gl" data-p="${x.path}">Load</button></div>`).join('');
  fl.querySelectorAll('.gl').forEach(b=>b.onclick=()=>loadGHF(b.dataset.p))}
  catch(e){fl.innerHTML=`<em style="color:var(--red)">${e.message}</em>`}}

async function loadGHF(path){showMsg('i','Loading from GitHub...');
  try{const f=await ghApi(path);const c=atob(f.content.replace(/\n/g,''));const d=JSON.parse(c);
    if(!d.data)throw new Error('Invalid');let n=0;
    for(const x of d.data){if(x.id&&x.flights){await dbP('flights',{...x,timestamp:Date.now()});n++}}
    if(d.favorites)d.favorites.forEach(f=>{if(!favs.some(e=>e.code===f.code))favs.push(f)});saveF();renderF();
    await upSt();showMsg('s',`Loaded ${n} routes from GitHub`)}catch(e){showMsg('e',e.message)}}

async function saveGHD(){showMsg('i','Saving to GitHub...');
  try{const all=await dbA('flights');const val=all.filter(d=>Date.now()-d.timestamp<CACHE_H*36e5);
    if(!val.length)throw new Error('No data');
    const exp={version:V,exportDate:new Date().toISOString(),favorites:favs,
      flightCount:val.reduce((s,f)=>s+f.flights.length,0),routeCount:val.length,data:val};
    const c=btoa(unescape(encodeURIComponent(JSON.stringify(exp))));
    const now=new Date();const ts=`${fD(now)}-${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;
    await ghApi(`data/flights-${ts}.json`,'PUT',{message:`flights ${ts}`,content:c});
    showMsg('s',`Saved to GitHub: flights-${ts}.json`)}catch(e){showMsg('e',e.message)}}

// ‚ïê‚ïê SEARCH ENGINE ‚ïê‚ïê
function buildLU(val){const bO=new Map(),bD=new Map(),bK=new Map();
  val.forEach(d=>{bK.set(`${d.origin}|${d.dest}|${d.date}`,d.flights||[]);
    if(!bO.has(d.origin))bO.set(d.origin,[]);bO.get(d.origin).push({d:d.dest,dt:d.date,fl:d.flights||[]});
    if(!bD.has(d.dest))bD.set(d.dest,[]);bD.get(d.dest).push({o:d.origin,dt:d.date,fl:d.flights||[]})});
  return{bO,bD,bK}}

async function doSearch(){L(`=== SEARCH mode=${mode} ===`);
  const all=await dbA('flights');const val=all.filter(d=>Date.now()-d.timestamp<CACHE_H*36e5);
  if(!val.length){sR('mg-w','No data. Import or download first.');return}
  const lu=buildLU(val);
  switch(mode){case'dep':sDep(lu);break;case'dest':sDest(lu);break;case'rt':sRT(lu);break;case'trip':sTrip(lu);break}}

function sDep(lu){const ori=gSel('dL'),s=$('dS').value,e=$('dE').value;
  if(!ori.length){sR('mg-w','Select origins.');return}if(!s||!e){sR('mg-w','Set dates.');return}
  const dates=dRng(s,e),fl=[];
  ori.forEach(o=>{(lu.bO.get(o)||[]).forEach(r=>{if(dates.includes(r.dt))r.fl.forEach(f=>{fl.push({o,d:r.d,dt:r.dt,f})})})});
  LS(`Dep: ${fl.length} flights`);dispDep(fl)}

function sDest(lu){const dst=gSel('sL'),s=$('sS').value,e=$('sE').value;
  if(!dst.length){sR('mg-w','Select destinations.');return}if(!s||!e){sR('mg-w','Set dates.');return}
  const dates=dRng(s,e),rl=[];
  dst.forEach(d=>{(lu.bD.get(d)||[]).forEach(r=>{if(dates.includes(r.dt))r.fl.forEach(f=>{rl.push({type:'d',o:r.o,d,dt:r.dt,f})})})});
  LS(`Dest: ${rl.length}`);dispDest(rl,dst)}

function sRT(lu){const s=$('rtS').value,e=$('rtE').value,mn=+$('rtMn').value,mx=+$('rtMx').value;
  if(!s||!e){sR('mg-w','Set dates.');return}
  const oF=$('rtO').value.toUpperCase().trim(),dF=$('rtD').value.toUpperCase().trim();
  const oS=oF?new Set(oF.split(/[,;\s]+/).filter(Boolean)):null;
  const dS=dF?new Set(dF.split(/[,;\s]+/).filter(Boolean)):null;
  sR('mg-i','<span class="sp-n"></span> Searching round trips...');
  setTimeout(()=>{const dates=dRng(s,e),res=[],seen=new Set();
    lu.bO.forEach((routes,orig)=>{if(oS&&!oS.has(orig))return;
      routes.forEach(r=>{if(dS&&!dS.has(r.d))return;if(!r.fl.length||!dates.includes(r.dt))return;
        r.fl.forEach(of=>{(lu.bO.get(r.d)||[]).forEach(rr=>{if(rr.d!==orig||!dates.includes(rr.dt))return;
          const stay=dB(r.dt,rr.dt);if(stay<mn||stay>mx)return;if(!rr.fl.length)return;
          rr.fl.forEach(rf=>{const k=`${orig}|${r.d}|${r.dt}|${rr.dt}|${of.departure}|${rf.departure}`;
            if(seen.has(k))return;seen.add(k);
            res.push({o:orig,d:r.d,oD:r.dt,rD:rr.dt,oF:of,rF:rf,stay})})})})})});
    res.sort((a,b)=>a.stay-b.stay||a.o.localeCompare(b.o));
    LS(`RT: ${res.length}`);dispRT(res)},50)}

function sTrip(lu){const homes=gSel('tL'),s=$('tS').value,e=$('tE').value,mE=+$('tH').value,mD=+$('tMn').value;
  if(!homes.length){sR('mg-w','Select home airports.');return}if(!s||!e){sR('mg-w','Set dates.');return}
  sR('mg-i','<span class="sp-n"></span> Searching trips...');
  setTimeout(()=>{const dates=dRng(s,e),trips=[];
    const gF=(a,b,d)=>lu.bK.get(`${a}|${b}|${d}`)||[];
    function vC(f1,d1,f2,d2){if(d2>d1)return true;if(d2<d1)return false;return pT(f2.departure)>=pT(f1.arrival)+MIN_LAY}
    function vR(f1,d1,f2,d2){if(d2>d1)return true;if(d2<d1)return false;return pT(f2.departure)>=pT(f1.arrival)+60}
    homes.forEach(h=>{const hR=lu.bO.get(h)||[];const dd=new Set(hR.map(r=>r.d));
      dd.forEach(d1=>{if(!(lu.bO.get(d1)||[]).some(r=>r.d===h))return;
        dates.forEach(dt1=>{gF(h,d1,dt1).forEach(f1=>{dates.forEach(dt2=>{if(dt2<dt1)return;
          gF(d1,h,dt2).forEach(f2=>{if(!vR(f1,dt1,f2,dt2))return;const dy=dB(dt1,dt2);if(dy<mD)return;
            trips.push({h,hops:1,path:[h,d1,h],legs:[{from:h,to:d1,dt:dt1,f:f1},{from:d1,to:h,dt:dt2,f:f2}]})})})})})});
      if(mE>=1)dd.forEach(d1=>{(lu.bO.get(d1)||[]).forEach(r=>{const d2=r.d;if(d2===h)return;
        if(!(lu.bO.get(d2)||[]).some(rr=>rr.d===h))return;
        dates.forEach(dt1=>{const l1=gF(h,d1,dt1);if(!l1.length)return;const f1=l1[0];
          dates.forEach(dt2=>{if(dt2<dt1)return;for(const f2 of gF(d1,d2,dt2)){if(!vC(f1,dt1,f2,dt2))continue;
            dates.forEach(dt3=>{if(dt3<dt2)return;for(const f3 of gF(d2,h,dt3)){if(!vC(f2,dt2,f3,dt3))continue;
              const dy=dB(dt1,dt3);if(dy<mD)continue;
              trips.push({h,hops:2,path:[h,d1,d2,h],legs:[{from:h,to:d1,dt:dt1,f:f1},{from:d1,to:d2,dt:dt2,f:f2},{from:d2,to:h,dt:dt3,f:f3}]});return}});break}})})})})});
    LS(`Trip: ${trips.length}`);dispTrip(trips)},50)}

// ‚ïê‚ïê DISPLAY ‚ïê‚ïê
function sR(c,h){$('res').innerHTML=`<div class="mg ${c}">${h}</div>`}

function dispDep(fl){const R=$('res');if(!fl.length){sR('mg-w','No flights found.');return}
  const bD={};fl.forEach(f=>{if(!bD[f.dt])bD[f.dt]=[];bD[f.dt].push(f)});
  let h=`<div class="mg mg-s">Found <strong>${fl.length}</strong> flights</div>`;
  Object.keys(bD).sort().forEach(d=>{h+=`<div class="dh">${fDD(d)} ‚Äî ${bD[d].length} flights</div>`;
    bD[d].forEach(f=>{h+=fC(f.o,f.d,f.dt,f.f)})});R.innerHTML=h}

function dispDest(rl,dst){const R=$('res');if(!rl.length){sR('mg-w',`No routes to ${dst.join(', ')}.`);return}
  const bD={};rl.forEach(f=>{if(!bD[f.d])bD[f.d]=[];bD[f.d].push(f)});
  let h=`<div class="mg mg-s">Found <strong>${rl.length}</strong> routes</div>`;
  Object.keys(bD).sort().forEach(d=>{h+=`<div class="deh">üéØ ${aD(d)} (${bD[d].length})</div>`;
    bD[d].slice(0,30).forEach(f=>{h+=fC(f.o,f.d,f.dt,f.f)});
    if(bD[d].length>30)h+=`<div class="mg mg-i">${bD[d].length-30} more...</div>`});R.innerHTML=h}

function dispRT(res){const R=$('res');if(!res.length){sR('mg-w','No round trips found.');return}
  let h=`<div class="mg mg-s">Found <strong>${res.length}</strong> round trips</div>`;
  const lim=Math.min(res.length,100);
  if(res.length>lim)h+=`<div class="mg mg-i">Showing ${lim} of ${res.length}</div>`;
  res.slice(0,lim).forEach(r=>{h+=`<div class="fc"><div class="fc-r"><span class="rt">${aS(r.o)} ‚Üî ${aS(r.d)}</span><span class="bg bg-d">${r.stay}d</span></div>
    <div class="lb"><strong>Out:</strong> ${fDD(r.oD)} ¬∑ ${aS(r.o)}‚Üí${aS(r.d)} ¬∑ <span class="m">${fT(r.oF.departure)}</span>‚Üí<span class="m">${fT(r.oF.arrival)}</span> ${r.oF.duration||''}
    <a href="${bU(r.o,r.d,r.oD)}" target="_blank" class="bk" style="margin-left:4px;padding:3px 7px">Book</a><br><br>
    <strong>Ret:</strong> ${fDD(r.rD)} ¬∑ ${aS(r.d)}‚Üí${aS(r.o)} ¬∑ <span class="m">${fT(r.rF.departure)}</span>‚Üí<span class="m">${fT(r.rF.arrival)}</span> ${r.rF.duration||''}
    <a href="${bU(r.d,r.o,r.rD)}" target="_blank" class="bk" style="margin-left:4px;padding:3px 7px">Book</a></div></div>`});
  R.innerHTML=h}

function dispTrip(trips){const R=$('res');if(!trips.length){sR('mg-w','No trips found.');return}
  const bH={1:[],2:[],3:[]};trips.forEach(t=>{if(bH[t.hops])bH[t.hops].push(t)});
  let h=`<div class="mg mg-s">Found <strong>${trips.length}</strong> trips</div>`;
  [1,2,3].forEach(hp=>{if(!bH[hp].length)return;
    const lb=hp===1?'Direct Round Trip':hp===2?'1 Extra Stop':'2 Extra Stops';
    h+=`<div class="deh" style="background:var(--acc2)">üîÑ ${lb} (${bH[hp].length})</div>`;
    const bP={};bH[hp].forEach(t=>{const k=t.path.join('-');if(!bP[k])bP[k]=[];bP[k].push(t)});
    Object.keys(bP).slice(0,15).forEach(pk=>{const pts=bP[pk],s=pts[0];
      h+=`<div class="fc" style="border-left:3px solid var(--acc2)"><div style="display:flex;flex-wrap:wrap;gap:3px;align-items:center;margin-bottom:6px">`;
      s.path.forEach((p,i)=>{h+=`<span style="background:var(--s2);padding:3px 7px;border-radius:4px;font-size:.74rem"><span class="m" style="color:var(--acc)">${p}</span><br><small style="color:var(--tx3);font-size:.6rem">${(airp.get(p)||{}).n||''}</small></span>`;
        if(i<s.path.length-1)h+='<span style="color:var(--acc2);font-weight:700">‚Üí</span>'});
      h+='</div>';
      pts.slice(0,3).forEach(trip=>{const dy=dB(trip.legs[0].dt,trip.legs[trip.legs.length-1].dt);
        h+=`<div class="lb"><div style="font-weight:600;color:var(--grn);font-size:.78rem;margin-bottom:4px">üìÖ ${dy===0?'Same day':dy+'d'}</div>`;
        trip.legs.forEach((l,i)=>{h+=`<div style="padding:3px 0;border-bottom:1px solid var(--bdr);font-size:.74rem">
          <strong>Leg ${i+1}:</strong> ${fDD(l.dt)} ¬∑ ${aS(l.from)}‚Üí${aS(l.to)} ¬∑ <span class="m">${fT(l.f.departure)}</span>‚Üí<span class="m">${fT(l.f.arrival)}</span>
          <a href="${bU(l.from,l.to,l.dt)}" target="_blank" class="bk" style="padding:2px 6px;font-size:.65rem">Book</a></div>`});
        h+='</div>'});
      if(pts.length>3)h+=`<div style="font-size:.7rem;color:var(--tx3)">+${pts.length-3} more</div>`;
      h+='</div>'})});
  R.innerHTML=h}

function fC(o,d,dt,f){return`<div class="fc"><div class="fc-r"><span class="rt">${aS(o)} ‚Üí ${aS(d)}</span><span class="bg bg-d">Direct</span></div>
  <div class="fc-i">üìÖ ${fDD(dt)} ¬∑ ‚úàÔ∏è <span class="m">${fT(f.departure)}</span> ‚Üí üõ¨ <span class="m">${fT(f.arrival)}</span> ¬∑ ${f.duration||''} ¬∑ ${f.flightCode||''}</div>
  <a href="${bU(o,d,dt)}" target="_blank" class="bk">üé´ Book</a></div>`}

// ‚ïê‚ïê INIT ‚ïê‚ïê
async function init(){
  L(`Init v${V}`);await initDB();loadF();renderF();loadGH();

  // Check proxy
  const proxy=getProxy();
  if(proxy){$('proxySetup').classList.add('hd-n');$('proxyUrl').value=proxy;$('gPx').value=proxy;
    L(`Proxy: ${proxy}`)}
  else{$('loginCard').style.opacity='.5'}

  // Worker code
  $('workerCode').textContent=workerCode();

  // Dates
  const today=fD(new Date()),mx=fD((()=>{const d=new Date();d.setDate(d.getDate()+3);return d})());
  ['dS','sS','tS','rtS'].forEach(id=>{const e=$(id);if(e){e.value=today;e.min=today}});
  ['dE','sE','tE','rtE'].forEach(id=>{const e=$(id);if(e){e.value=mx;e.min=today}});

  await upSt();LS('Ready')}

// ‚ïê‚ïê EVENTS ‚ïê‚ïê
document.addEventListener('DOMContentLoaded',()=>{
  // Tabs
  $$('.t').forEach(t=>t.onclick=()=>{$$('.t').forEach(b=>b.classList.remove('on'));t.classList.add('on');
    mode=t.dataset.m;$$('.pn').forEach(p=>p.classList.remove('on'));$('p-'+mode).classList.add('on')});

  // Favorites
  $('bFav').onclick=()=>{const i=$('favI');if(addF(i.value))i.value=''};
  $('favI').onkeydown=e=>{if(e.key==='Enter'){const i=$('favI');if(addF(i.value))i.value=''}};

  // Airport selectors
  $$('.sf').forEach(b=>b.onclick=()=>sSel(b.dataset.l,favs.map(f=>f.code)));
  $$('.sa').forEach(b=>b.onclick=()=>sSel(b.dataset.l,[...airp.keys()]));
  $$('.sc').forEach(b=>b.onclick=()=>sSel(b.dataset.l,[]));

  // Proxy setup
  $('bSaveProxy').onclick=()=>{const u=$('proxyUrl').value.trim();
    if(!u){$('proxyMsg').innerHTML='<div class="mg mg-e">Enter proxy URL</div>';return}
    // Remove trailing slash
    const clean=u.replace(/\/+$/,'');
    localStorage.setItem('wz_proxy',clean);$('proxyMsg').innerHTML='<div class="mg mg-s">‚úÖ Proxy saved!</div>';
    $('gPx').value=clean;LS(`Proxy saved: ${clean}`)};
  $('bTestProxy').onclick=async()=>{
    const u=($('proxyUrl').value||getProxy()||'').trim().replace(/\/+$/,'');
    if(!u){$('proxyMsg').innerHTML='<div class="mg mg-e">Enter proxy URL first</div>';return}
    $('proxyMsg').innerHTML='<div class="mg mg-i">üîÑ Testing proxy connection...</div>';
    try{
      // Test 1: Basic connectivity 
      const r=await fetch(u,{method:'OPTIONS'});
      if(!r.ok&&r.status!==204){throw new Error(`OPTIONS returned ${r.status}`)}
      $('proxyMsg').innerHTML='<div class="mg mg-i">‚úÖ CORS OK. Testing Wizz Air connection...</div>';
      // Test 2: Actual proxy to wizzair 
      const r2=await fetch(u,{headers:{'X-Target':'https://wizzair.com/static/metadata.json'}});
      const txt=await r2.text();
      L(`Proxy test response: ${r2.status}, body: ${txt.substring(0,200)}`);
      if(r2.status>=200&&r2.status<300){
        try{const j=JSON.parse(txt);
          $('proxyMsg').innerHTML='<div class="mg mg-s">‚úÖ Proxy works! Connected to Wizz Air API v'+( j.appVersion||'OK')+'</div>';
          // Auto-save on successful test
          localStorage.setItem('wz_proxy',u);$('gPx').value=u;
          setTimeout(()=>{$('proxySetup').classList.add('hd-n');$('loginCard').style.opacity='1'},2000);
        }catch{$('proxyMsg').innerHTML='<div class="mg mg-s">‚úÖ Proxy works! Got response ('+txt.length+' bytes)</div>';
          localStorage.setItem('wz_proxy',u);$('gPx').value=u}
      }else{$('proxyMsg').innerHTML='<div class="mg mg-w">‚ö†Ô∏è Proxy responded but Wizz Air returned status '+r2.status+'. Check worker code.</div>'}
    }catch(e){L(`Proxy test error: ${e.message}`);
      $('proxyMsg').innerHTML='<div class="mg mg-e">‚ùå Test failed: '+e.message+'<br><small>Make sure you pasted the correct worker code and deployed it.</small></div>'}
  };
  $('setupHdr').onclick=()=>{$('setupHdr').classList.toggle('op');$('setupBody').classList.toggle('op')};
  $('bCopyWorker').onclick=()=>{$('workerCode').classList.toggle('hd-n');
    navigator.clipboard.writeText(workerCode()).then(()=>showMsg('s','Worker code copied!')).catch(()=>{})};

  // Login & Download
  $('bLogin').onclick=loginAndDownload;
  $('bPause').onclick=()=>{paused=!paused;$('bPause').textContent=paused?'‚ñ∂ Resume':'‚è∏ Pause'};
  $('bStop').onclick=()=>{stopped=true;paused=false};

  // Data management
  $('bImport').onclick=()=>$('fileIn').click();
  $('fileIn').onchange=e=>{if(e.target.files.length){importJ(e.target.files[0]);e.target.value=''}};
  $('bExport').onclick=exportJ;
  $('bClear').onclick=async()=>{if(confirm('Clear all data?')){await dbC('flights');await upSt();$('res').innerHTML='';LS('Cleared')}};
  $('bGHLoad').onclick=async()=>{const s=gGH();if(!s.t){$('mGH').classList.add('op');return}
    showMsg('i','Loading latest from GitHub...');
    try{let f;try{f=await ghApi('data')}catch{showMsg('e','No data/ folder.');return}
      const js=(Array.isArray(f)?f:[]).filter(x=>x.name.endsWith('.json')).sort((a,b)=>b.name.localeCompare(a.name));
      if(!js.length){showMsg('w','No files found.');return}await loadGHF(js[0].path)}catch(e){showMsg('e',e.message)}};
  $('bGHSave').onclick=saveGHD;

  // Search
  $('bSrch').onclick=doSearch;

  // Settings modal
  $('bGH').onclick=()=>{$('mGH').classList.add('op');listGHF()};
  $('bCGH').onclick=()=>$('mGH').classList.remove('op');
  $('mGH').onclick=e=>{if(e.target===$('mGH'))$('mGH').classList.remove('op')};
  $('bGHS').onclick=()=>{saveGH();$('gMsg').innerHTML='<div class="mg mg-s">Saved!</div>'};
  $('bGHT').onclick=testGH;
  $('bGPx').onclick=()=>{const u=$('gPx').value.trim();if(u){localStorage.setItem('wz_proxy',u);
    $('proxyUrl').value=u;$('proxySetup').classList.add('hd-n');$('loginCard').style.opacity='1';
    $('gMsg').innerHTML='<div class="mg mg-s">Proxy saved!</div>'}};

  // Log modal
  $('bLog').onclick=()=>$('mLog').classList.add('op');
  $('bCL').onclick=()=>$('mLog').classList.remove('op');
  $('mLog').onclick=e=>{if(e.target===$('mLog'))$('mLog').classList.remove('op')};
  $('bLC').onclick=()=>{logs=[];$('lA').innerHTML='';$('lCnt').textContent='(0)'};
  
  // Enhanced log export with full diagnostics
  function buildLogExport(){
    const divider='‚ïê'.repeat(60);
    let out=`${divider}\nWIZZ AYCF DEBUG LOG ‚Äî ${new Date().toISOString()}\n${divider}\n\n`;
    out+=`Version: ${V}\n`;
    out+=`User Agent: ${navigator.userAgent}\n`;
    out+=`Screen: ${screen.width}x${screen.height} | Window: ${innerWidth}x${innerHeight}\n`;
    out+=`Proxy: ${getProxy()||'NOT SET'}\n`;
    out+=`Cookies: ${cookieJar?cookieJar.substring(0,200)+'...':'NONE'}\n`;
    out+=`XSRF Token: ${xsrfToken?xsrfToken.substring(0,30)+'...':'NONE'}\n`;
    out+=`Favorites: ${favs.map(f=>f.code).join(', ')||'none'}\n`;
    out+=`Airports loaded: ${airp.size}\n`;
    out+=`Mode: ${mode}\n\n`;
    out+=`${divider}\nLOG ENTRIES (${logs.length})\n${divider}\n\n`;
    out+=logs.map(l=>l.l).join('\n');
    out+=`\n\n${divider}\nEND OF LOG\n${divider}\n`;
    return out;
  }
  
  $('bLE').onclick=()=>{const blob=new Blob([buildLogExport()],{type:'text/plain'});
    const url=URL.createObjectURL(blob);const a=document.createElement('a');
    a.href=url;a.download=`aycf-log-${fD(new Date())}.txt`;document.body.appendChild(a);a.click();document.body.removeChild(a)};
  
  // Copy log to clipboard
  if($('bLCopy'))$('bLCopy').onclick=()=>{
    navigator.clipboard.writeText(buildLogExport()).then(()=>{
      $('bLCopy').textContent='‚úÖ Copied!';setTimeout(()=>{$('bLCopy').textContent='üìã Copy Log'},2000)
    }).catch(()=>{
      // Fallback: select text
      const ta=document.createElement('textarea');ta.value=buildLogExport();document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);
      $('bLCopy').textContent='‚úÖ Copied!';setTimeout(()=>{$('bLCopy').textContent='üìã Copy Log'},2000)
    })};

  init()});
</script>
</body>
</html>
