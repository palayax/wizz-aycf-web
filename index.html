<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0d1117">
<title>Wizz AYCF Flight Finder</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0d1117;--s1:#161b22;--s2:#1c2333;--s3:#252d3d;
  --bdr:#30363d;--bdr2:#484f58;
  --acc:#58a6ff;--acc2:#a371f7;--grn:#3fb950;--ylw:#d29922;--red:#f85149;
  --tx:#e6edf3;--tx2:#8b949e;--tx3:#6e7681;
  --r:10px;--rs:6px;
}
html{font-size:15px}
body{font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:var(--tx);min-height:100vh;padding-bottom:20px}

.hd{position:sticky;top:0;z-index:100;background:rgba(13,17,23,.95);backdrop-filter:blur(16px);border-bottom:1px solid var(--bdr);padding:10px 14px}
.hd-r{display:flex;align-items:center;justify-content:space-between;max-width:900px;margin:0 auto}
.hd-t{font-size:1rem;font-weight:800;display:flex;align-items:center;gap:8px}
.hd-t .g{background:linear-gradient(90deg,var(--acc),var(--acc2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.hd-t .v{font-weight:400;font-size:.6rem;color:var(--tx3)}
.hd-a{display:flex;gap:4px}
.ib{width:36px;height:36px;border-radius:8px;border:1px solid var(--bdr);background:var(--s1);color:var(--tx2);display:flex;align-items:center;justify-content:center;cursor:pointer}

.ct{max-width:900px;margin:0 auto;padding:10px 12px}
.cd{background:var(--s1);border:1px solid var(--bdr);border-radius:var(--r);padding:14px;margin-bottom:10px}
.cd-t{font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--tx2);margin-bottom:10px}

.bt{display:inline-flex;align-items:center;gap:4px;padding:10px 14px;border-radius:var(--rs);border:none;font-family:'Inter',sans-serif;font-size:.82rem;font-weight:600;cursor:pointer;min-height:40px}
.bt:disabled{opacity:.3;pointer-events:none}
.bt-p{background:var(--acc);color:#0d1117}
.bt-g{background:var(--grn);color:#0d1117}
.bt-y{background:var(--ylw);color:#0d1117}
.bt-o{background:transparent;border:1px solid var(--bdr);color:var(--tx2)}
.bt-d{background:rgba(248,81,73,.12);border:1px solid rgba(248,81,73,.3);color:var(--red)}
.bt-sm{padding:7px 10px;font-size:.76rem;min-height:34px}
.rw{display:flex;gap:6px;flex-wrap:wrap}

.ip{width:100%;background:var(--s2);border:1px solid var(--bdr);border-radius:var(--rs);padding:11px 12px;color:var(--tx);font-family:'Inter',sans-serif;font-size:.88rem;min-height:42px}
.ip:focus{outline:none;border-color:var(--acc)}
select.ip{-webkit-appearance:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath d='M3 5l3 3 3-3' stroke='%238b949e' fill='none' stroke-width='1.5'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;padding-right:28px}
.ip-row{display:flex;gap:8px;margin-bottom:8px}

.filter-row{display:flex;gap:10px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
.filter-row label{font-size:.75rem;font-weight:600;color:var(--tx2);min-width:100px}
.filter-row select,.filter-row input{flex:1;min-width:120px}

.chk-row{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.chk-row input[type="checkbox"]{width:18px;height:18px;accent-color:var(--acc)}
.chk-row label{font-size:.78rem;color:var(--tx2)}

.mg{padding:12px;border-radius:var(--rs);margin-bottom:8px;font-size:.82rem}
.mg-i{background:rgba(88,166,255,.06);border:1px solid rgba(88,166,255,.2);color:#79c0ff}
.mg-s{background:rgba(63,185,80,.06);border:1px solid rgba(63,185,80,.2);color:var(--grn)}
.mg-w{background:rgba(210,153,34,.06);border:1px solid rgba(210,153,34,.2);color:var(--ylw)}
.mg-e{background:rgba(248,81,73,.06);border:1px solid rgba(248,81,73,.2);color:var(--red)}

.pg{height:4px;background:rgba(88,166,255,.12);border-radius:2px;overflow:hidden;margin:6px 0}
.pg .fl{height:100%;background:linear-gradient(90deg,var(--acc),var(--acc2));border-radius:2px;transition:width .3s;width:0%}

.hd-n{display:none!important}
.sep{border:none;border-top:1px solid var(--bdr);margin:12px 0}
.sp-n{display:inline-block;width:14px;height:14px;border:2px solid rgba(88,166,255,.2);border-top-color:var(--acc);border-radius:50%;animation:spi .6s linear infinite}
@keyframes spi{to{transform:rotate(360deg)}}

/* Results Table */
.results-controls{display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap;align-items:center}
.results-count{font-size:.8rem;color:var(--tx2);margin-left:auto}

.tbl-wrap{overflow-x:auto;border:1px solid var(--bdr);border-radius:var(--rs)}
table{width:100%;border-collapse:collapse;font-size:.78rem}
th,td{padding:10px 8px;text-align:left;border-bottom:1px solid var(--bdr)}
th{background:var(--s2);font-weight:600;color:var(--tx2);cursor:pointer;user-select:none;white-space:nowrap}
th:hover{background:var(--s3)}
th.sorted-asc::after{content:' ‚ñ≤';color:var(--acc)}
th.sorted-desc::after{content:' ‚ñº';color:var(--acc)}
tr:hover{background:var(--s2)}
td{color:var(--tx)}
.mono{font-family:'JetBrains Mono',monospace}
.link-btn{background:var(--grn);color:#0d1117;padding:4px 8px;border-radius:4px;text-decoration:none;font-size:.7rem;font-weight:600;white-space:nowrap}

/* Filter inputs in table header */
.th-filter{display:block;margin-top:4px}
.th-filter input,.th-filter select{width:100%;padding:4px 6px;font-size:.7rem;background:var(--bg);border:1px solid var(--bdr);border-radius:3px;color:var(--tx)}

/* Modal */
.mo{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:200;align-items:flex-end;justify-content:center}
.mo.op{display:flex}
.mo-s{width:100%;max-width:520px;background:var(--s1);border-radius:14px 14px 0 0;padding:16px 14px 24px;max-height:88vh;overflow-y:auto}
.mo-h{width:36px;height:3px;background:var(--tx3);border-radius:2px;margin:0 auto 12px}
.mo-t{font-size:1rem;font-weight:700;margin-bottom:12px}

.la{background:var(--bg);border:1px solid var(--bdr);border-radius:var(--rs);max-height:280px;overflow-y:auto;padding:8px;font-family:'JetBrains Mono',monospace;font-size:.65rem;color:var(--tx3);white-space:pre-wrap}
.la .e{color:var(--red)}.la .w{color:var(--ylw)}.la .s{color:var(--grn)}.la .a{color:var(--acc)}

.cl-h{cursor:pointer;display:flex;justify-content:space-between;align-items:center}
.cl-h .tg{font-size:.65rem;color:var(--tx3)}
.cl-b{display:none;margin-top:10px}.cl-b.op{display:block}
.stp{counter-reset:step;margin:10px 0}
.sp{counter-increment:step;padding-left:30px;position:relative;margin-bottom:10px;font-size:.8rem;color:var(--tx2)}
.sp::before{content:counter(step);position:absolute;left:0;top:0;width:22px;height:22px;border-radius:50%;background:var(--acc);color:var(--bg);font-size:.7rem;font-weight:700;display:flex;align-items:center;justify-content:center}
.code-box{background:var(--bg);border:1px solid var(--bdr);border-radius:var(--rs);padding:8px;font-family:'JetBrains Mono',monospace;font-size:.62rem;color:var(--acc);max-height:100px;overflow-y:auto;margin:6px 0}

/* Footer with branding */
.ft{display:flex;justify-content:space-between;align-items:center;font-size:.68rem;color:var(--tx3);padding:18px 12px;max-width:900px;margin:0 auto}
.ft a{color:var(--acc);text-decoration:none}
.ft-brand{display:flex;align-items:center;gap:6px}
.ft-brand img{width:20px;height:20px;border-radius:4px}
.ft-brand span{font-weight:600;color:var(--tx2)}

/* Date display box */
.date-box{display:inline-flex;align-items:center;gap:6px;background:var(--s3);padding:8px 12px;border-radius:var(--rs);font-family:'JetBrains Mono',monospace;font-size:.9rem;color:var(--grn);font-weight:600}
</style>
</head>
<body>

<header class="hd">
<div class="hd-r">
  <div class="hd-t">
    <span class="g">‚úàÔ∏è AYCF Finder</span>
    <span class="v">v4.3</span>
  </div>
  <div class="hd-a">
    <button class="ib" id="bLog" title="Debug Log">üîß</button>
    <button class="ib" id="bSettings" title="Settings">‚öôÔ∏è</button>
  </div>
</div>
</header>

<main class="ct">

<!-- Proxy Setup -->
<div class="cd" id="proxySetup">
  <div class="cd-t">üîß One-Time Setup (required)</div>
  <p style="font-size:.8rem;color:var(--tx2);margin-bottom:10px">
    To connect to Wizz Air, you need a free <strong style="color:var(--tx)">Cloudflare Worker</strong> proxy.
  </p>
  <div class="cl-h" id="setupHdr"><span style="font-size:.78rem;font-weight:600;color:var(--acc)">üìã Setup Instructions</span><span class="tg">‚ñº</span></div>
  <div class="cl-b" id="setupBody">
    <div class="stp">
      <div class="sp">Go to <a href="https://dash.cloudflare.com/sign-up" target="_blank" style="color:var(--acc)">Cloudflare</a> ‚Üí Create free account</div>
      <div class="sp"><strong style="color:var(--tx)">Workers & Pages</strong> ‚Üí <strong style="color:var(--tx)">Create</strong></div>
      <div class="sp">Click <strong style="color:var(--tx)">"Start with Hello World!"</strong></div>
      <div class="sp">Name it (e.g. <code style="color:var(--acc)">aycf-proxy</code>) ‚Üí Click <strong style="color:var(--tx)">Deploy</strong></div>
      <div class="sp">Click <strong style="color:var(--tx)">"Edit Code"</strong> ‚Üí Delete all ‚Üí Paste code below ‚Üí <strong style="color:var(--tx)">Deploy</strong></div>
      <div class="sp">Copy your Worker URL and paste below</div>
    </div>
    <button class="bt bt-p bt-sm" id="bCopyWorker">üìã Copy Worker Code</button>
    <div class="code-box hd-n" id="workerCode"></div>
  </div>
  <div class="ip-row" style="margin-top:10px">
    <input class="ip" id="proxyUrl" placeholder="https://your-worker.workers.dev">
    <button class="bt bt-g" id="bSaveProxy">Save</button>
    <button class="bt bt-p bt-sm" id="bTestProxy">üß™ Test</button>
  </div>
  <div id="proxyMsg" style="margin-top:6px"></div>
</div>

<!-- Login & Search -->
<div class="cd" id="loginCard">
  <div class="cd-t">üîë Login & Search Flights</div>
  <div class="ip-row">
    <input class="ip" id="wizEmail" type="email" placeholder="Wizz Air Email" autocomplete="email">
    <input class="ip" id="wizPass" type="password" placeholder="Password" autocomplete="current-password">
  </div>
  <div class="chk-row">
    <input type="checkbox" id="saveCredentials">
    <label for="saveCredentials">Remember credentials on this device</label>
  </div>

  <div class="cd-t" style="margin-top:14px">üéØ Search Filters</div>

  <div class="filter-row">
    <label>Departure Date:</label>
    <div class="date-box" id="dateDisplay">--/--/----</div>
    <input type="date" class="ip" id="filterDate" style="max-width:140px">
  </div>

  <div class="filter-row">
    <label>Date Flexibility:</label>
    <select class="ip" id="filterDateFlex" style="max-width:180px">
      <option value="exact">Exact Date Only</option>
      <option value="pm1">¬± 1 Day (3 days)</option>
    </select>
  </div>

  <div class="filter-row">
    <label>Origin City:</label>
    <select class="ip" id="filterOrigin"></select>
  </div>

  <div class="filter-row">
    <label>Destination City:</label>
    <select class="ip" id="filterDest">
      <option value="">All Destinations</option>
    </select>
  </div>

  <div class="filter-row">
    <label>Round Trip:</label>
    <select class="ip" id="filterRoundTrip" style="max-width:120px">
      <option value="no">No</option>
      <option value="yes">Yes</option>
    </select>
    <span style="font-size:.72rem;color:var(--tx3)">(Returns within 3-4 days)</span>
  </div>

  <div class="rw" style="margin-top:14px">
    <button class="bt bt-p" id="bSearch">üîç Search Flights</button>
    <button class="bt bt-y hd-n" id="bPause">‚è∏Ô∏è Pause</button>
    <button class="bt bt-o hd-n" id="bResume">‚ñ∂Ô∏è Resume</button>
    <button class="bt bt-d hd-n" id="bStop">‚èπÔ∏è Stop</button>
  </div>
  <div class="pg hd-n" id="dlProg"><div class="fl" id="dlFill"></div></div>
  <div id="dlStatus" style="font-size:.75rem;color:var(--tx2);margin-top:4px"></div>
  <div id="loginMsg"></div>
</div>

<!-- Results -->
<div class="cd" id="resultsCard">
  <div class="cd-t">üìä Search Results</div>

  <div class="results-controls">
    <button class="bt bt-o bt-sm" id="bExportResults">üì§ Export JSON</button>
    <button class="bt bt-o bt-sm" id="bImportResults">üì• Import JSON</button>
    <button class="bt bt-d bt-sm" id="bClearResults">üóëÔ∏è Clear</button>
    <input type="file" id="importFile" accept=".json" style="display:none">
    <span class="results-count" id="resultsCount">0 flights</span>
  </div>

  <div id="resultsArea">
    <div class="mg mg-i">No results yet. Search for flights above.</div>
  </div>
</div>

</main>

<footer class="ft">
  <div class="ft-brand">
    <img src="Palaya_Logo.png" alt="Palaya">
    <span>Palaya LTD</span>
  </div>
  <div>Not affiliated with Wizz Air</div>
</footer>

<!-- Settings Modal -->
<div class="mo" id="mSettings">
<div class="mo-s">
  <div class="mo-h"></div>
  <div class="mo-t">‚öôÔ∏è Settings</div>

  <div class="cd-t">Proxy URL</div>
  <div class="ip-row">
    <input class="ip" id="settingsProxy" placeholder="https://your-worker.workers.dev">
    <button class="bt bt-g bt-sm" id="bSaveSettingsProxy">Save</button>
  </div>

  <hr class="sep">

  <div class="cd-t">Priority Cities (Search Order)</div>
  <p style="font-size:.75rem;color:var(--tx2);margin-bottom:8px">
    Enter city codes separated by commas. These will be searched first.
  </p>
  <div class="ip-row">
    <input class="ip" id="priorityCities" placeholder="TLV, BCN, FCO, ATH" style="text-transform:uppercase">
    <button class="bt bt-g bt-sm" id="bSavePriority">Save</button>
  </div>

  <hr class="sep">

  <div class="cd-t">Saved Credentials</div>
  <button class="bt bt-d bt-sm" id="bClearCredentials">üóëÔ∏è Clear Saved Credentials</button>

  <hr class="sep">
  <button class="bt bt-o" style="width:100%" id="bCloseSettings">Close</button>
</div>
</div>

<!-- Log Modal -->
<div class="mo" id="mLog">
<div class="mo-s">
  <div class="mo-h"></div>
  <div class="mo-t">üîß Debug Log <span id="lCnt" style="font-size:.72rem;color:var(--tx3)">(0)</span></div>
  <div class="rw" style="margin-bottom:10px">
    <button class="bt bt-o bt-sm" id="bCopyLog">üìã Copy</button>
    <button class="bt bt-d bt-sm" id="bClearLog">Clear</button>
  </div>
  <div class="la" id="logArea">Waiting for events...</div>
  <hr class="sep">
  <button class="bt bt-o" style="width:100%" id="bCloseLog">Close</button>
</div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PALAYA LTD - WIZZ AYCF FINDER v4.3
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const VERSION = '4.3.0';

// Airport Database
const AIRPORTS = {
  // Israel
  TLV:{city:'Tel Aviv',airport:'Ben Gurion International',country:'Israel'},
  ETH:{city:'Eilat',airport:'Ramon Airport',country:'Israel'},
  // UK
  LTN:{city:'London',airport:'Luton Airport',country:'United Kingdom'},
  LGW:{city:'London',airport:'Gatwick Airport',country:'United Kingdom'},
  STN:{city:'London',airport:'Stansted Airport',country:'United Kingdom'},
  BHX:{city:'Birmingham',airport:'Birmingham Airport',country:'United Kingdom'},
  MAN:{city:'Manchester',airport:'Manchester Airport',country:'United Kingdom'},
  EDI:{city:'Edinburgh',airport:'Edinburgh Airport',country:'United Kingdom'},
  GLA:{city:'Glasgow',airport:'Glasgow Airport',country:'United Kingdom'},
  LPL:{city:'Liverpool',airport:'John Lennon Airport',country:'United Kingdom'},
  // Italy
  FCO:{city:'Rome',airport:'Fiumicino Airport',country:'Italy'},
  CIA:{city:'Rome',airport:'Ciampino Airport',country:'Italy'},
  MXP:{city:'Milan',airport:'Malpensa Airport',country:'Italy'},
  BGY:{city:'Milan',airport:'Bergamo Orio al Serio',country:'Italy'},
  VCE:{city:'Venice',airport:'Marco Polo Airport',country:'Italy'},
  NAP:{city:'Naples',airport:'Naples International',country:'Italy'},
  BRI:{city:'Bari',airport:'Karol Wojtyla Airport',country:'Italy'},
  CTA:{city:'Catania',airport:'Fontanarossa Airport',country:'Italy'},
  PMO:{city:'Palermo',airport:'Falcone Borsellino',country:'Italy'},
  BLQ:{city:'Bologna',airport:'Guglielmo Marconi',country:'Italy'},
  TRN:{city:'Turin',airport:'Turin Airport',country:'Italy'},
  PSA:{city:'Pisa',airport:'Galileo Galilei Airport',country:'Italy'},
  // Spain
  BCN:{city:'Barcelona',airport:'El Prat Airport',country:'Spain'},
  MAD:{city:'Madrid',airport:'Barajas Airport',country:'Spain'},
  AGP:{city:'Malaga',airport:'Costa del Sol Airport',country:'Spain'},
  ALC:{city:'Alicante',airport:'Alicante-Elche Airport',country:'Spain'},
  PMI:{city:'Palma',airport:'Son Sant Joan',country:'Spain'},
  VLC:{city:'Valencia',airport:'Valencia Airport',country:'Spain'},
  // Germany
  BER:{city:'Berlin',airport:'Brandenburg Airport',country:'Germany'},
  CGN:{city:'Cologne',airport:'Cologne Bonn Airport',country:'Germany'},
  DUS:{city:'Dusseldorf',airport:'Dusseldorf Airport',country:'Germany'},
  FRA:{city:'Frankfurt',airport:'Frankfurt Airport',country:'Germany'},
  HAM:{city:'Hamburg',airport:'Hamburg Airport',country:'Germany'},
  MUC:{city:'Munich',airport:'Franz Josef Strauss',country:'Germany'},
  NUE:{city:'Nuremberg',airport:'Nuremberg Airport',country:'Germany'},
  STR:{city:'Stuttgart',airport:'Stuttgart Airport',country:'Germany'},
  FMM:{city:'Memmingen',airport:'Allgau Airport',country:'Germany'},
  DTM:{city:'Dortmund',airport:'Dortmund Airport',country:'Germany'},
  // Poland
  WAW:{city:'Warsaw',airport:'Chopin Airport',country:'Poland'},
  WMI:{city:'Warsaw',airport:'Modlin Airport',country:'Poland'},
  KRK:{city:'Krakow',airport:'John Paul II Airport',country:'Poland'},
  KTW:{city:'Katowice',airport:'Pyrzowice Airport',country:'Poland'},
  GDN:{city:'Gdansk',airport:'Lech Walesa Airport',country:'Poland'},
  POZ:{city:'Poznan',airport:'Lawica Airport',country:'Poland'},
  WRO:{city:'Wroclaw',airport:'Copernicus Airport',country:'Poland'},
  // Romania
  OTP:{city:'Bucharest',airport:'Henri Coanda Airport',country:'Romania'},
  CLJ:{city:'Cluj-Napoca',airport:'Avram Iancu Airport',country:'Romania'},
  TSR:{city:'Timisoara',airport:'Traian Vuia Airport',country:'Romania'},
  IAS:{city:'Iasi',airport:'Iasi Airport',country:'Romania'},
  SBZ:{city:'Sibiu',airport:'Sibiu Airport',country:'Romania'},
  // Hungary & Austria
  BUD:{city:'Budapest',airport:'Ferenc Liszt Airport',country:'Hungary'},
  VIE:{city:'Vienna',airport:'Vienna International',country:'Austria'},
  // Greece
  ATH:{city:'Athens',airport:'Eleftherios Venizelos',country:'Greece'},
  SKG:{city:'Thessaloniki',airport:'Macedonia Airport',country:'Greece'},
  HER:{city:'Heraklion',airport:'Nikos Kazantzakis',country:'Greece'},
  RHO:{city:'Rhodes',airport:'Diagoras Airport',country:'Greece'},
  CFU:{city:'Corfu',airport:'Ioannis Kapodistrias',country:'Greece'},
  // Cyprus
  LCA:{city:'Larnaca',airport:'Larnaca Airport',country:'Cyprus'},
  PFO:{city:'Paphos',airport:'Paphos Airport',country:'Cyprus'},
  // Bulgaria
  SOF:{city:'Sofia',airport:'Sofia Airport',country:'Bulgaria'},
  VAR:{city:'Varna',airport:'Varna Airport',country:'Bulgaria'},
  // France
  CDG:{city:'Paris',airport:'Charles de Gaulle',country:'France'},
  ORY:{city:'Paris',airport:'Orly Airport',country:'France'},
  BVA:{city:'Paris',airport:'Beauvais-Tille',country:'France'},
  NCE:{city:'Nice',airport:'Cote d Azur Airport',country:'France'},
  // Portugal
  LIS:{city:'Lisbon',airport:'Humberto Delgado',country:'Portugal'},
  OPO:{city:'Porto',airport:'Francisco Sa Carneiro',country:'Portugal'},
  FAO:{city:'Faro',airport:'Faro Airport',country:'Portugal'},
  // Netherlands & Belgium
  AMS:{city:'Amsterdam',airport:'Schiphol Airport',country:'Netherlands'},
  EIN:{city:'Eindhoven',airport:'Eindhoven Airport',country:'Netherlands'},
  BRU:{city:'Brussels',airport:'Brussels Airport',country:'Belgium'},
  CRL:{city:'Brussels',airport:'Charleroi Airport',country:'Belgium'},
  // Scandinavia
  ARN:{city:'Stockholm',airport:'Arlanda Airport',country:'Sweden'},
  GOT:{city:'Gothenburg',airport:'Landvetter Airport',country:'Sweden'},
  CPH:{city:'Copenhagen',airport:'Kastrup Airport',country:'Denmark'},
  OSL:{city:'Oslo',airport:'Gardermoen Airport',country:'Norway'},
  HEL:{city:'Helsinki',airport:'Helsinki-Vantaa',country:'Finland'},
  // Balkans
  BEG:{city:'Belgrade',airport:'Nikola Tesla Airport',country:'Serbia'},
  PRN:{city:'Pristina',airport:'Adem Jashari Airport',country:'Kosovo'},
  SKP:{city:'Skopje',airport:'Skopje Airport',country:'North Macedonia'},
  TGD:{city:'Podgorica',airport:'Podgorica Airport',country:'Montenegro'},
  ZAG:{city:'Zagreb',airport:'Franjo Tudman Airport',country:'Croatia'},
  SPU:{city:'Split',airport:'Split Airport',country:'Croatia'},
  DBV:{city:'Dubrovnik',airport:'Dubrovnik Airport',country:'Croatia'},
  // Other
  TIA:{city:'Tirana',airport:'Mother Teresa Airport',country:'Albania'},
  PRG:{city:'Prague',airport:'Vaclav Havel Airport',country:'Czechia'},
  BTS:{city:'Bratislava',airport:'M.R. Stefanik Airport',country:'Slovakia'},
  LJU:{city:'Ljubljana',airport:'Joze Pucnik Airport',country:'Slovenia'},
  RIX:{city:'Riga',airport:'Riga Airport',country:'Latvia'},
  VNO:{city:'Vilnius',airport:'Vilnius Airport',country:'Lithuania'},
  TLL:{city:'Tallinn',airport:'Lennart Meri Airport',country:'Estonia'},
  KIV:{city:'Chisinau',airport:'Chisinau Airport',country:'Moldova'},
  SJJ:{city:'Sarajevo',airport:'Sarajevo Airport',country:'Bosnia'}
};

// State
let logs = [];
let searching = false;
let paused = false;
let stopped = false;
let cookieJar = '';
let xsrfToken = '';
let searchResults = [];
let currentSort = { field: null, asc: true };
let allDestinationsForReturn = new Set();

// Helpers
const $ = id => document.getElementById(id);
const $$ = s => document.querySelectorAll(s);

function L(m, c = '') {
  const ts = new Date().toISOString().slice(11, 23);
  const l = `[${ts}] ${m}`;
  logs.push({ l, c });
  if (logs.length > 3000) logs = logs.slice(-3000);
  console.log('[AYCF]', m);
  const a = $('logArea');
  if (a) {
    const d = document.createElement('div');
    d.className = c;
    d.textContent = l;
    a.appendChild(d);
    a.scrollTop = a.scrollHeight;
  }
  $('lCnt').textContent = `(${logs.length})`;
}
function LE(m) { L('‚ùå ' + m, 'e'); }
function LW(m) { L('‚ö†Ô∏è ' + m, 'w'); }
function LS(m) { L('‚úÖ ' + m, 's'); }
function LA(m) { L('üåê ' + m, 'a'); }

function getAirportInfo(code) {
  const info = AIRPORTS[code];
  if (info) return { code, ...info };
  return { code, city: code, airport: code, country: 'Unknown' };
}

function formatDate(d) {
  return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
}

// Format date as DD/MM/YYYY for display
function formatDateDMY(dateStr) {
  if (!dateStr) return '--/--/----';
  const [y, m, d] = dateStr.split('-');
  return `${d}/${m}/${y}`;
}

function updateDateDisplay() {
  const dateVal = $('filterDate').value;
  $('dateDisplay').textContent = formatDateDMY(dateVal);
}

function formatDateTime(dt, tm) {
  if (!dt) return '';
  const [y, m, d] = dt.split('-');
  const time = tm ? formatTime(tm) : '00:00';
  return `${time} ${d}/${m}/${y}`;
}

function formatTime(t) {
  if (!t) return '';
  if (t.includes('T')) t = t.split('T')[1];
  if (t.includes(':')) {
    const p = t.split(':');
    return String(+p[0]).padStart(2, '0') + ':' + String(+(p[1] || 0)).padStart(2, '0');
  }
  return t;
}

function addDays(dateStr, days) {
  const [y, m, d] = dateStr.split('-').map(Number);
  const date = new Date(y, m - 1, d);
  date.setDate(date.getDate() + days);
  return formatDate(date);
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
function getProxy() { return localStorage.getItem('wz_proxy') || ''; }
function getPriorityCities() {
  const saved = localStorage.getItem('wz_priority_cities') || 'TLV';
  return saved.split(',').map(c => c.trim().toUpperCase()).filter(c => c.length === 3);
}

function bookingUrl(o, d, dt) {
  return `https://multipass.wizzair.com/w6/subscriptions/spa/private-page/flight-search?origin=${o}&destination=${d}&departureDate=${dt}`;
}

// Credentials management
function saveCredentials() {
  if ($('saveCredentials').checked) {
    const email = $('wizEmail').value.trim();
    const pass = $('wizPass').value;
    if (email && pass) {
      localStorage.setItem('wz_email', btoa(email));
      localStorage.setItem('wz_pass', btoa(pass));
      L('Credentials saved');
    }
  }
}

function loadCredentials() {
  try {
    const email = localStorage.getItem('wz_email');
    const pass = localStorage.getItem('wz_pass');
    if (email && pass) {
      $('wizEmail').value = atob(email);
      $('wizPass').value = atob(pass);
      $('saveCredentials').checked = true;
      L('Credentials loaded');
    }
  } catch (e) {
    LW('Failed to load credentials');
  }
}

function clearCredentials() {
  localStorage.removeItem('wz_email');
  localStorage.removeItem('wz_pass');
  $('wizEmail').value = '';
  $('wizPass').value = '';
  $('saveCredentials').checked = false;
  LS('Credentials cleared');
}

// Populate city dropdowns
function populateCityDropdowns() {
  const cities = new Map();
  Object.entries(AIRPORTS).forEach(([code, info]) => {
    const key = `${info.city}, ${info.country}`;
    if (!cities.has(key)) cities.set(key, []);
    cities.get(key).push(code);
  });

  const priorityCodes = getPriorityCities();
  const sortedCities = [...cities.entries()].sort((a, b) => {
    const aHasPriority = a[1].some(c => priorityCodes.includes(c));
    const bHasPriority = b[1].some(c => priorityCodes.includes(c));
    if (aHasPriority && !bHasPriority) return -1;
    if (!aHasPriority && bHasPriority) return 1;
    return a[0].localeCompare(b[0]);
  });

  const originSel = $('filterOrigin');
  originSel.innerHTML = sortedCities.map(([city, codes]) =>
    `<option value="${codes.join(',')}" ${codes.includes('TLV') ? 'selected' : ''}>${city} (${codes.join('/')})</option>`
  ).join('');

  const destSel = $('filterDest');
  destSel.innerHTML = '<option value="" selected>All Destinations</option>' +
    sortedCities.map(([city, codes]) =>
      `<option value="${codes.join(',')}">${city} (${codes.join('/')})</option>`
    ).join('');
}

// Proxy fetch
async function px(url, opts = {}) {
  const proxy = getProxy();
  if (!proxy) throw new Error('Proxy not configured');

  const maxRedirects = opts.maxRedirects || 5;
  let currentUrl = url;
  let attempt = 0;

  while (attempt < maxRedirects) {
    attempt++;
    const headers = { 'X-Target': currentUrl };
    if (cookieJar) headers['X-Cookies'] = cookieJar;
    if (opts.contentType) headers['Content-Type'] = opts.contentType;
    if (xsrfToken) headers['X-XSRF-TOKEN'] = xsrfToken;

    const fOpts = { method: (attempt === 1 ? opts.method : null) || 'GET', headers };
    if (attempt === 1 && opts.body) fOpts.body = typeof opts.body === 'string' ? opts.body : JSON.stringify(opts.body);

    LA(`[${attempt}] ${fOpts.method || 'GET'} ${currentUrl.substring(0, 80)}...`);

    const resp = await fetch(proxy, fOpts);

    const sc = resp.headers.get('X-Set-Cookies');
    if (sc) {
      try {
        const arr = JSON.parse(sc);
        arr.forEach(c => {
          const parts = c.split(';')[0];
          const [name] = parts.split('=');
          const existing = cookieJar.split('; ').filter(x => x && !x.startsWith(name.trim() + '='));
          existing.push(parts);
          cookieJar = existing.join('; ');
          if (name.trim() === 'XSRF-TOKEN') {
            xsrfToken = decodeURIComponent(parts.split('=').slice(1).join('='));
          }
        });
      } catch (e) {}
    }

    const loc = resp.headers.get('X-Location');
    if (loc) {
      if (loc.startsWith('/')) currentUrl = new URL(currentUrl).origin + loc;
      else if (loc.startsWith('http')) currentUrl = loc;
      else currentUrl = new URL(loc, currentUrl).href;
      continue;
    }

    const status = parseInt(resp.headers.get('X-Status')) || resp.status;
    const bodyText = await resp.text();
    L(`  ‚úì ${status} | ${bodyText.length} bytes`);

    return { status, headers: resp.headers, url: currentUrl, bodyText,
      json: () => { try { return JSON.parse(bodyText); } catch(e) { return null; } }
    };
  }
  throw new Error('Too many redirects');
}

// Worker code
function workerCode() {
  return `export default{
async fetch(r,env,ctx){
const cors={'Access-Control-Allow-Origin':'*',
'Access-Control-Allow-Methods':'GET,POST,PUT,DELETE,OPTIONS',
'Access-Control-Allow-Headers':'Content-Type,X-Target,X-Cookies,X-XSRF-TOKEN',
'Access-Control-Expose-Headers':'X-Set-Cookies,X-Location,Content-Type,X-Status',
'Access-Control-Max-Age':'86400'};
if(r.method==='OPTIONS')return new Response(null,{headers:cors});
const t=r.headers.get('X-Target');
if(!t)return new Response(JSON.stringify({error:'Need X-Target header'}),{status:400,headers:{...cors,'Content-Type':'application/json'}});
let url;try{url=new URL(t)}catch{return new Response(JSON.stringify({error:'Invalid URL'}),{status:400,headers:{...cors,'Content-Type':'application/json'}})}
if(!url.hostname.endsWith('wizzair.com'))return new Response(JSON.stringify({error:'Only wizzair.com'}),{status:403,headers:{...cors,'Content-Type':'application/json'}});
const h=new Headers();
h.set('User-Agent','Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36');
h.set('Accept','text/html,application/xhtml+xml,application/json,*/*;q=0.8');
h.set('Accept-Language','en-US,en;q=0.9');
if(r.headers.get('Content-Type'))h.set('Content-Type',r.headers.get('Content-Type'));
const ck=r.headers.get('X-Cookies');if(ck)h.set('Cookie',ck);
const xsrf=r.headers.get('X-XSRF-TOKEN');if(xsrf)h.set('X-XSRF-TOKEN',xsrf);
h.set('Referer','https://multipass.wizzair.com/');
h.set('Origin','https://multipass.wizzair.com');
try{
const resp=await fetch(t,{method:r.method,headers:h,body:['GET','HEAD'].includes(r.method)?undefined:await r.arrayBuffer(),redirect:'manual'});
const rh=new Headers(cors);
rh.set('X-Status',String(resp.status));
const sc=resp.headers.getSetCookie?resp.headers.getSetCookie():[];
if(sc.length)rh.set('X-Set-Cookies',JSON.stringify(sc));
if(resp.status>=300&&resp.status<400){
rh.set('X-Location',resp.headers.get('Location')||'');
return new Response(JSON.stringify({redirect:resp.headers.get('Location')}),{status:200,headers:rh})}
const ct=resp.headers.get('Content-Type');if(ct)rh.set('Content-Type',ct);
return new Response(resp.body,{status:resp.status,headers:rh});
}catch(e){return new Response(JSON.stringify({error:e.message}),{status:502,headers:{...cors,'Content-Type':'application/json'}})}
}};`;
}

// Show messages
function showMsg(type, msg) {
  const c = { s: 'mg-s', e: 'mg-e', w: 'mg-w', i: 'mg-i' };
  $('loginMsg').innerHTML = `<div class="mg ${c[type] || 'mg-i'}">${msg}</div>`;
  if (type !== 'e') setTimeout(() => { $('loginMsg').innerHTML = ''; }, 8000);
}

function setProgress(p) { $('dlFill').style.width = Math.min(100, p) + '%'; }
function showStatus(m) { $('dlStatus').textContent = m; }

// Render results
function renderResults() {
  const area = $('resultsArea');
  $('resultsCount').textContent = `${searchResults.length} flights`;

  if (!searchResults.length) {
    area.innerHTML = '<div class="mg mg-w">No flights found yet.</div>';
    return;
  }

  let sorted = [...searchResults];
  if (currentSort.field) {
    sorted.sort((a, b) => {
      let va = a[currentSort.field] || '';
      let vb = b[currentSort.field] || '';
      if (typeof va === 'string') va = va.toLowerCase();
      if (typeof vb === 'string') vb = vb.toLowerCase();
      if (va < vb) return currentSort.asc ? -1 : 1;
      if (va > vb) return currentSort.asc ? 1 : -1;
      return 0;
    });
  }

  const columns = [
    { key: 'type', label: 'Type' },
    { key: 'originCountry', label: 'Origin Country' },
    { key: 'originCity', label: 'Origin City' },
    { key: 'originAirport', label: 'Origin Airport' },
    { key: 'destCountry', label: 'Dest Country' },
    { key: 'destCity', label: 'Dest City' },
    { key: 'destAirport', label: 'Dest Airport' },
    { key: 'flightNumber', label: 'Flight #' },
    { key: 'date', label: 'Date' },
    { key: 'departure', label: 'Departure' },
    { key: 'arrival', label: 'Arrival' },
    { key: 'bookingUrl', label: 'Book' }
  ];

  let html = '<div class="tbl-wrap"><table><thead><tr>';
  columns.forEach(col => {
    const sortClass = currentSort.field === col.key ? (currentSort.asc ? 'sorted-asc' : 'sorted-desc') : '';
    html += `<th class="${sortClass}" data-sort="${col.key}">${col.label}`;
    if (col.key !== 'bookingUrl') {
      html += `<span class="th-filter"><input type="text" data-filter="${col.key}" placeholder="Filter..."></span>`;
    }
    html += '</th>';
  });
  html += '</tr></thead><tbody>';

  sorted.forEach((r, idx) => {
    const depTime = formatDateTime(r.date, r.departure);
    const arrTime = formatDateTime(r.date, r.arrival);
    html += `<tr data-idx="${idx}">
      <td>${r.type === 'return' ? '‚Ü©Ô∏è Return' : '‚úàÔ∏è Outbound'}</td>
      <td>${r.originCountry}</td>
      <td>${r.originCity}</td>
      <td>${r.originAirport} (${r.originCode})</td>
      <td>${r.destCountry}</td>
      <td>${r.destCity}</td>
      <td>${r.destAirport} (${r.destCode})</td>
      <td class="mono">${r.flightNumber || '-'}</td>
      <td class="mono">${formatDateDMY(r.date)}</td>
      <td class="mono">${depTime}</td>
      <td class="mono">${arrTime}</td>
      <td><a href="${r.bookingUrl}" target="_blank" class="link-btn">Book</a></td>
    </tr>`;
  });
  html += '</tbody></table></div>';
  area.innerHTML = html;

  // Sort handlers
  area.querySelectorAll('th[data-sort]').forEach(th => {
    th.addEventListener('click', e => {
      if (e.target.tagName === 'INPUT') return;
      const field = th.dataset.sort;
      if (field === 'bookingUrl') return;
      if (currentSort.field === field) currentSort.asc = !currentSort.asc;
      else { currentSort.field = field; currentSort.asc = true; }
      renderResults();
    });
  });

  // Filter handlers
  area.querySelectorAll('input[data-filter]').forEach(inp => {
    inp.addEventListener('input', () => {
      const filters = {};
      area.querySelectorAll('input[data-filter]').forEach(i => {
        if (i.value.trim()) filters[i.dataset.filter] = i.value.trim().toLowerCase();
      });
      area.querySelectorAll('tbody tr').forEach(tr => {
        const idx = parseInt(tr.dataset.idx);
        const row = searchResults[idx];
        let show = true;
        for (const [key, val] of Object.entries(filters)) {
          const cellVal = String(row[key] || '').toLowerCase();
          if (!cellVal.includes(val)) { show = false; break; }
        }
        tr.style.display = show ? '' : 'none';
      });
    });
  });
}

function addFlightResult(flight) {
  searchResults.push(flight);
  $('resultsCount').textContent = `${searchResults.length} flights`;
  if (searchResults.length <= 3 || searchResults.length % 10 === 0) renderResults();
}

// Search flights
async function searchFlights() {
  if (searching) return;

  const email = $('wizEmail').value.trim();
  const pass = $('wizPass').value;
  if (!email || !pass) { showMsg('e', 'Enter email and password.'); return; }
  if (!getProxy()) { showMsg('e', 'Set up proxy first.'); return; }

  saveCredentials();

  const filterDate = $('filterDate').value;
  const filterDateFlex = $('filterDateFlex').value;
  const filterOrigin = $('filterOrigin').value;
  const filterDest = $('filterDest').value;
  const isRoundTrip = $('filterRoundTrip').value === 'yes';

  if (!filterDate) { showMsg('e', 'Select departure date.'); return; }
  if (!filterOrigin) { showMsg('e', 'Select origin city.'); return; }

  const originCodes = filterOrigin.split(',');
  const destCodes = filterDest ? filterDest.split(',') : null;

  searching = true;
  paused = false;
  stopped = false;
  cookieJar = '';
  xsrfToken = '';
  searchResults = [];
  allDestinationsForReturn = new Set();

  $('bSearch').disabled = true;
  $('bPause').classList.remove('hd-n');
  $('bStop').classList.remove('hd-n');
  $('bResume').classList.add('hd-n');
  $('dlProg').classList.remove('hd-n');
  showStatus('Connecting...');
  setProgress(0);
  renderResults();

  try {
    // Step 1: Login
    L('‚ïê‚ïê‚ïê Step 1: Getting login page ‚ïê‚ïê‚ïê');
    showStatus('Getting login page...');

    const loginR = await px('https://multipass.wizzair.com/w6/subscriptions/auth/login', { maxRedirects: 10 });
    const loginHtml = loginR.bodyText;

    const isKeycloak = loginR.url.includes('/auth/realms/') || loginHtml.includes('kc-form-login');
    if (!isKeycloak) throw new Error('Could not reach login page');

    // Step 2: Submit credentials
    L('‚ïê‚ïê‚ïê Step 2: Submitting credentials ‚ïê‚ïê‚ïê');
    showStatus('Logging in...');

    const formMatch = loginHtml.match(/<form[^>]*id="kc-form-login"[^>]*action="([^"]+)"/i) ||
                      loginHtml.match(/<form[^>]*action="([^"]*login-actions[^"]*)"/i);
    if (!formMatch) throw new Error('Login form not found');

    let formAction = formMatch[1].replace(/&amp;/g, '&');
    if (formAction.startsWith('/')) formAction = 'https://multipass.wizzair.com' + formAction;

    const authR = await px(formAction, {
      method: 'POST',
      contentType: 'application/x-www-form-urlencoded',
      body: `username=${encodeURIComponent(email)}&password=${encodeURIComponent(pass)}&credentialId=`,
      maxRedirects: 10
    });

    if (authR.bodyText.includes('Invalid username or password')) {
      throw new Error('Invalid username or password');
    }

    LS('Login successful!');

    // Step 3: Get routes - use the page we already have from login redirect
    L('‚ïê‚ïê‚ïê Step 3: Parsing routes ‚ïê‚ïê‚ïê');
    showStatus('Parsing routes...');

    // The authR should have redirected to the private page with routes
    let walletsHtml = authR.bodyText;

    // If not enough content, fetch wallets page
    if (walletsHtml.length < 50000 || !walletsHtml.includes('routes')) {
      L('Fetching wallets page for routes...');
      const walletsR = await px('https://multipass.wizzair.com/w6/subscriptions/spa/private-page/wallets', { maxRedirects: 10 });
      walletsHtml = walletsR.bodyText;
    }

    // Parse routes
    let routes = [];

    // Method 1: Look for "routes" array
    const routesMatch = walletsHtml.match(/"routes"\s*:\s*(\[[\s\S]*?\])(?=\s*[,}])/);
    if (routesMatch) {
      try {
        routes = JSON.parse(routesMatch[1]);
        L(`Found ${routes.length} routes via "routes" pattern`);
      } catch (e) { LW(`Parse routes failed: ${e.message}`); }
    }

    // Method 2: Extract airport codes
    if (!routes.length) {
      L('Trying fallback route extraction...');
      const allCodes = new Set();
      const codeMatches = walletsHtml.matchAll(/"id"\s*:\s*"([A-Z]{3})"/g);
      for (const m of codeMatches) {
        if (AIRPORTS[m[1]]) allCodes.add(m[1]);
      }
      L(`Found ${allCodes.size} known airport codes`);

      if (allCodes.size > 0) {
        // Use selected origin and all found codes as destinations
        originCodes.forEach(o => {
          const dests = [...allCodes].filter(c => c !== o);
          if (dests.length) {
            routes.push({
              departureStation: { id: o },
              arrivalStations: dests.map(c => ({ id: c }))
            });
          }
        });
        L(`Built ${routes.length} routes`);
      }
    }

    // Parse into usable format
    const parsedRoutes = [];
    routes.forEach(r => {
      let origin = null, destinations = [];
      if (r.departureStation && r.departureStation.id) {
        origin = r.departureStation.id;
        destinations = (r.arrivalStations || []).map(a => a.id || a).filter(Boolean);
      } else if (r.origin) {
        origin = r.origin;
        destinations = r.destinations || [];
      }
      if (origin && destinations.length) {
        if (!originCodes.includes(origin)) return;
        if (destCodes) destinations = destinations.filter(d => destCodes.includes(d));
        if (destinations.length) {
          parsedRoutes.push({ origin, destinations });
          destinations.forEach(d => allDestinationsForReturn.add(d));
        }
      }
    });

    L(`Found ${parsedRoutes.length} matching routes with ${allDestinationsForReturn.size} unique destinations`);

    if (!parsedRoutes.length) {
      LW('No routes matched - check filters');
      L(`originCodes: ${originCodes.join(',')}, destCodes: ${destCodes ? destCodes.join(',') : 'ALL'}`);
    }

    // Step 4: Build search dates
    L('‚ïê‚ïê‚ïê Step 4: Searching flights ‚ïê‚ïê‚ïê');

    // Build outbound dates based on flexibility
    const outboundDates = [filterDate];
    if (filterDateFlex === 'pm1') {
      outboundDates.unshift(addDays(filterDate, -1)); // day before
      outboundDates.push(addDays(filterDate, 1));     // day after
    }
    L(`Outbound dates: ${outboundDates.join(', ')}`);

    // Return dates (3-4 days after EACH outbound date)
    const returnDates = [];
    if (isRoundTrip) {
      outboundDates.forEach(od => {
        for (let i = 3; i <= 4; i++) {
          const rd = addDays(od, i);
          if (!returnDates.includes(rd)) returnDates.push(rd);
        }
      });
      L(`Return dates: ${returnDates.join(', ')}`);
    }

    // Build tasks
    const tasks = [];
    const seen = new Set();
    const priorityCodes = getPriorityCities();

    // Sort routes by priority
    parsedRoutes.sort((a, b) => {
      const aP = priorityCodes.indexOf(a.origin);
      const bP = priorityCodes.indexOf(b.origin);
      if (aP >= 0 && bP < 0) return -1;
      if (aP < 0 && bP >= 0) return 1;
      return a.origin.localeCompare(b.origin);
    });

    // Outbound tasks
    parsedRoutes.forEach(r => {
      const sortedDests = [...r.destinations].sort((a, b) => {
        const aP = priorityCodes.indexOf(a);
        const bP = priorityCodes.indexOf(b);
        if (aP >= 0 && bP < 0) return -1;
        if (aP < 0 && bP >= 0) return 1;
        return a.localeCompare(b);
      });

      sortedDests.forEach(dest => {
        outboundDates.forEach(dt => {
          const k = `${r.origin}|${dest}|${dt}`;
          if (!seen.has(k)) {
            seen.add(k);
            tasks.push({ o: r.origin, d: dest, dt, type: 'outbound' });
          }
        });
      });
    });

    // Return tasks
    if (isRoundTrip && allDestinationsForReturn.size > 0) {
      [...allDestinationsForReturn].forEach(returnOrigin => {
        originCodes.forEach(returnDest => {
          returnDates.forEach(dt => {
            const k = `${returnOrigin}|${returnDest}|${dt}`;
            if (!seen.has(k)) {
              seen.add(k);
              tasks.push({ o: returnOrigin, d: returnDest, dt, type: 'return' });
            }
          });
        });
      });
    }

    const outboundCount = tasks.filter(t => t.type === 'outbound').length;
    const returnCount = tasks.filter(t => t.type === 'return').length;
    L(`${tasks.length} searches: ${outboundCount} outbound, ${returnCount} return`);
    showStatus(`Searching ${tasks.length} routes...`);

    let rateLimitCount = 0;
    let consecutiveSuccess = 0;

    for (let i = 0; i < tasks.length; i++) {
      if (stopped) { L('Stopped by user'); break; }
      while (paused && !stopped) { showStatus('Paused...'); await sleep(500); }
      if (stopped) break;

      const t = tasks[i];
      setProgress((i / tasks.length) * 100);
      const oInfo = getAirportInfo(t.o);
      const dInfo = getAirportInfo(t.d);
      showStatus(`${t.type === 'return' ? '‚Ü©Ô∏è' : '‚úàÔ∏è'} ${oInfo.city} ‚Üí ${dInfo.city} [${i + 1}/${tasks.length}]`);

      try {
        // Optimized delay: faster after consecutive successes
        const delay = consecutiveSuccess > 10 ? 200 : (consecutiveSuccess > 5 ? 300 : 400);
        await sleep(delay + Math.random() * 200);

        const r = await px('https://multipass.wizzair.com/w6/subscriptions/json/flight-search', {
          method: 'POST',
          contentType: 'application/json',
          body: JSON.stringify({
            flightType: 'OW',
            origin: t.o,
            destination: t.d,
            departure: t.dt,
            arrival: '',
            intervalSubtype: null
          })
        });

        if (r.status === 429) {
          rateLimitCount++;
          consecutiveSuccess = 0;
          const waitTime = rateLimitCount >= 3 ? 60000 : 15000;
          showStatus(`Rate limited ‚Äî waiting ${waitTime/1000}s...`);
          await sleep(waitTime);
          if (rateLimitCount >= 3) rateLimitCount = 0;
          i--;
          continue;
        }

        rateLimitCount = 0;

        if (r.status >= 200 && r.status < 300) {
          consecutiveSuccess++;
          const data = r.json();

          if (data) {
            let fl = data.flightsOutbound || data.flights || data.outbound || [];
            if (Array.isArray(data) && data.length > 0 && data[0].departure) fl = data;

            if (fl && fl.length > 0) {
              L(`  ${t.o} ‚Üí ${t.d} (${t.type}): ${fl.length} flights`);
              fl.forEach(f => {
                addFlightResult({
                  type: t.type,
                  originCode: t.o,
                  originCity: oInfo.city,
                  originCountry: oInfo.country,
                  originAirport: oInfo.airport,
                  destCode: t.d,
                  destCity: dInfo.city,
                  destCountry: dInfo.country,
                  destAirport: dInfo.airport,
                  date: t.dt,
                  departure: f.departure || f.departureTime || '',
                  arrival: f.arrival || f.arrivalTime || '',
                  flightNumber: f.flightCode || f.flightNumber || '',
                  bookingUrl: bookingUrl(t.o, t.d, t.dt)
                });
              });
            }
          }
        }

        // Only pause every 50 requests (optimized from 30)
        if (i > 0 && i % 50 === 0 && i < tasks.length - 1) {
          showStatus('Brief pause to avoid rate limits...');
          await sleep(5000);
        }
      } catch (e) {
        consecutiveSuccess = 0;
        LW(`Error on ${t.o}‚Üí${t.d}: ${e.message}`);
      }
    }

    setProgress(100);
    LS(`Done! Found ${searchResults.length} flights`);
    showStatus(`Found ${searchResults.length} flights`);
    showMsg(searchResults.length > 0 ? 's' : 'w',
      searchResults.length > 0 ? `Found ${searchResults.length} flights!` : 'No flights found. Check debug log.');
    renderResults();

  } catch (e) {
    LE(`Failed: ${e.message}`);
    showMsg('e', e.message);
    renderResults();
  } finally {
    searching = false;
    paused = false;
    $('bSearch').disabled = false;
    $('bPause').classList.add('hd-n');
    $('bResume').classList.add('hd-n');
    $('bStop').classList.add('hd-n');
  }
}

// Export/Import
function exportResults() {
  if (!searchResults.length) { showMsg('w', 'No results to export'); return; }
  const data = {
    version: VERSION,
    exportDate: new Date().toISOString(),
    filters: {
      date: $('filterDate').value,
      dateFlex: $('filterDateFlex').value,
      origin: $('filterOrigin').value,
      destination: $('filterDest').value,
      roundTrip: $('filterRoundTrip').value
    },
    count: searchResults.length,
    flights: searchResults
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `wizz-flights-${formatDate(new Date())}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  showMsg('s', 'Results exported!');
}

function importResults(file) {
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      if (!data.flights || !Array.isArray(data.flights)) throw new Error('Invalid format');
      searchResults = data.flights;
      renderResults();
      showMsg('s', `Imported ${searchResults.length} flights!`);
    } catch (err) {
      showMsg('e', 'Import failed: ' + err.message);
    }
  };
  reader.readAsText(file);
}

// Initialize
function init() {
  L(`Init v${VERSION}`);

  const proxy = getProxy();
  if (proxy) {
    $('proxySetup').classList.add('hd-n');
    $('proxyUrl').value = proxy;
    $('settingsProxy').value = proxy;
  } else {
    $('loginCard').style.opacity = '.5';
  }

  loadCredentials();
  $('priorityCities').value = localStorage.getItem('wz_priority_cities') || 'TLV';

  $('filterDate').value = formatDate(new Date());
  $('filterDate').min = formatDate(new Date());
  updateDateDisplay();
  $('filterDate').addEventListener('change', updateDateDisplay);

  populateCityDropdowns();
  $('workerCode').textContent = workerCode();

  LS('Ready');
}

// Event listeners
document.addEventListener('DOMContentLoaded', () => {
  $('setupHdr').onclick = () => {
    $('setupHdr').classList.toggle('op');
    $('setupBody').classList.toggle('op');
  };

  $('bCopyWorker').onclick = () => {
    $('workerCode').classList.toggle('hd-n');
    navigator.clipboard.writeText(workerCode());
  };

  $('bSaveProxy').onclick = () => {
    const u = $('proxyUrl').value.trim().replace(/\/+$/, '');
    if (!u) return;
    localStorage.setItem('wz_proxy', u);
    $('settingsProxy').value = u;
    $('proxyMsg').innerHTML = '<div class="mg mg-s">‚úÖ Saved</div>';
  };

  $('bTestProxy').onclick = async () => {
    const u = ($('proxyUrl').value || getProxy() || '').trim().replace(/\/+$/, '');
    if (!u) { $('proxyMsg').innerHTML = '<div class="mg mg-e">Enter URL</div>'; return; }
    $('proxyMsg').innerHTML = '<div class="mg mg-i">Testing...</div>';
    try {
      const r = await fetch(u, { headers: { 'X-Target': 'https://wizzair.com/' } });
      if (r.status >= 200 && r.status < 400) {
        $('proxyMsg').innerHTML = '<div class="mg mg-s">‚úÖ Proxy works!</div>';
        localStorage.setItem('wz_proxy', u);
        $('settingsProxy').value = u;
        setTimeout(() => {
          $('proxySetup').classList.add('hd-n');
          $('loginCard').style.opacity = '1';
        }, 1500);
      } else {
        $('proxyMsg').innerHTML = `<div class="mg mg-w">Status ${r.status}</div>`;
      }
    } catch (e) {
      $('proxyMsg').innerHTML = `<div class="mg mg-e">${e.message}</div>`;
    }
  };

  $('bSearch').onclick = searchFlights;
  $('bPause').onclick = () => {
    paused = true;
    $('bPause').classList.add('hd-n');
    $('bResume').classList.remove('hd-n');
    L('Paused');
  };
  $('bResume').onclick = () => {
    paused = false;
    $('bResume').classList.add('hd-n');
    $('bPause').classList.remove('hd-n');
    L('Resumed');
  };
  $('bStop').onclick = () => { stopped = true; paused = false; };

  $('bExportResults').onclick = exportResults;
  $('bImportResults').onclick = () => $('importFile').click();
  $('importFile').onchange = e => {
    if (e.target.files.length) { importResults(e.target.files[0]); e.target.value = ''; }
  };
  $('bClearResults').onclick = () => {
    searchResults = [];
    currentSort = { field: null, asc: true };
    $('resultsArea').innerHTML = '<div class="mg mg-i">No results yet.</div>';
    $('resultsCount').textContent = '0 flights';
  };

  $('bSettings').onclick = () => $('mSettings').classList.add('op');
  $('bCloseSettings').onclick = () => $('mSettings').classList.remove('op');
  $('mSettings').onclick = e => { if (e.target === $('mSettings')) $('mSettings').classList.remove('op'); };
  $('bSaveSettingsProxy').onclick = () => {
    const u = $('settingsProxy').value.trim();
    if (u) {
      localStorage.setItem('wz_proxy', u);
      $('proxyUrl').value = u;
      $('proxySetup').classList.add('hd-n');
      $('loginCard').style.opacity = '1';
    }
  };
  $('bSavePriority').onclick = () => {
    localStorage.setItem('wz_priority_cities', $('priorityCities').value.trim().toUpperCase());
    populateCityDropdowns();
    LS('Priority saved');
  };
  $('bClearCredentials').onclick = () => { clearCredentials(); showMsg('s', 'Credentials cleared'); };

  $('bLog').onclick = () => $('mLog').classList.add('op');
  $('bCloseLog').onclick = () => $('mLog').classList.remove('op');
  $('mLog').onclick = e => { if (e.target === $('mLog')) $('mLog').classList.remove('op'); };
  $('bClearLog').onclick = () => { logs = []; $('logArea').innerHTML = ''; $('lCnt').textContent = '(0)'; };
  $('bCopyLog').onclick = () => {
    navigator.clipboard.writeText(`WIZZ AYCF LOG ‚Äî ${new Date().toISOString()}\nVersion: ${VERSION}\n\n${logs.map(l => l.l).join('\n')}`).then(() => {
      $('bCopyLog').textContent = '‚úÖ Copied';
      setTimeout(() => { $('bCopyLog').textContent = 'üìã Copy'; }, 1500);
    });
  };

  init();
});
</script>
</body>
</html>
